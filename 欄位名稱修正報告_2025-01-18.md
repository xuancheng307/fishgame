# æ¬„ä½åç¨±ä¸ä¸€è‡´ä¿®æ­£å ±å‘Š

**ä¿®æ­£æ—¥æœŸ**: 2025-01-18
**å•é¡Œä¾†æº**: ç”¨æˆ¶å ±å‘Š
**åš´é‡ç¨‹åº¦**: ğŸ”´ Criticalï¼ˆæœƒå°è‡´ API 500 éŒ¯èª¤ï¼‰

---

## ğŸš¨ ç™¼ç¾çš„å•é¡Œ

### å•é¡Œ1: games.game_name vs games.name

**ç—‡ç‹€**: å‰µå»ºéŠæˆ² API æœƒç›´æ¥å ±éŒ¯ 500

**è³‡æ–™åº«å®šç¾©**:
```sql
-- complete_database_structure.sql Line 38
`name` varchar(100) NOT NULL
```

**ä»£ç¢¼ä½¿ç”¨**:
```javascript
// âŒ éŒ¯èª¤ï¼šä½¿ç”¨ä¸å­˜åœ¨çš„æ¬„ä½ game_name
INSERT INTO games (game_name, ...) VALUES (?, ...)  // Line 353
SELECT game_name FROM games WHERE id = ?           // Line 211
gameName: game.game_name                           // å¤šè™•
```

**å½±éŸ¿ç¯„åœ**:
- âŒ `/api/admin/games/create` - å‰µå»ºéŠæˆ²å¤±æ•—
- âŒ `/api/qr/:gameId` - QR Code ç”Ÿæˆå¤±æ•—
- âŒ æ‰€æœ‰è¿”å› `gameName` çš„ API

---

### å•é¡Œ2: games.team_names æ¬„ä½ä¸å­˜åœ¨

**ç—‡ç‹€**: éšŠä¼å‘½ååŠŸèƒ½å®Œå…¨ç„¡æ³•ä½¿ç”¨ï¼ŒUPDATE èªå¥å¤±æ•—

**è³‡æ–™åº«å®šç¾©**:
```sql
-- âŒ å®Œå…¨æ²’æœ‰ team_names æ¬„ä½
```

**ä»£ç¢¼ä½¿ç”¨**:
```javascript
// âŒ éŒ¯èª¤ï¼šæ¬„ä½ä¸å­˜åœ¨
const teamNames = JSON.parse(game.team_names || '{}');      // Line 2068
UPDATE games SET team_names = ? WHERE id = ?                // Line 2075
```

**å½±éŸ¿ç¯„åœ**:
- âŒ éšŠä¼åŠ å…¥éŠæˆ²æ™‚è¨­å®šé¡¯ç¤ºåç¨±
- âŒ æ›´æ–°éšŠä¼åç¨±
- âŒ é¡¯ç¤ºéšŠä¼è‡ªè¨‚åç¨±

---

## ğŸ”§ ä¿®æ­£æªæ–½

### ä¿®æ­£1: çµ±ä¸€ä½¿ç”¨ `name` æ¬„ä½

**ç­–ç•¥**: ä¿®æ”¹ä»£ç¢¼ä»¥ç¬¦åˆè³‡æ–™åº« schema

**è³‡æ–™åº«**: ä¿æŒä¸è®Š
```sql
`name` varchar(100) NOT NULL
```

**ä»£ç¢¼ä¿®æ­£**:

#### ä¿®æ­£ A: SELECT èªå¥
```javascript
// ä¿®æ­£å‰ âŒ
'SELECT game_name FROM games WHERE id = ?'

// ä¿®æ­£å¾Œ âœ…
'SELECT name FROM games WHERE id = ?'
```

**ä½ç½®**: server.js:211

#### ä¿®æ­£ B: INSERT èªå¥
```javascript
// ä¿®æ­£å‰ âŒ
INSERT INTO games (
    game_name, initial_budget, ...
)

// ä¿®æ­£å¾Œ âœ…
INSERT INTO games (
    name, initial_budget, ...
)
```

**ä½ç½®**: server.js:353

#### ä¿®æ­£ C: è®€å–æ¬„ä½å€¼
```javascript
// ä¿®æ­£å‰ âŒ
gameName: game.game_name
gameName: participant.game_name

// ä¿®æ­£å¾Œ âœ… (ä½¿ç”¨ replace_all)
gameName: game.name
gameName: participant.name
```

**ä½ç½®**: server.js å¤šè™•ï¼ˆå·²å…¨å±€æ›¿æ›ï¼‰

---

### ä¿®æ­£2: æ·»åŠ  `team_names` æ¬„ä½

**ç­–ç•¥**: åœ¨è³‡æ–™åº«ä¸­æ·»åŠ ç¼ºå¤±çš„æ¬„ä½

**è³‡æ–™åº«ä¿®æ­£**:
```sql
-- complete_database_structure.sql Line 45
`team_names` json DEFAULT NULL COMMENT 'éšŠä¼åç¨±æ˜ å°„ {teamId: displayName}'
```

**æ¬„ä½èªªæ˜**:
- é¡å‹: JSON
- æ ¼å¼: `{"1": "æµ·ç›œéšŠ", "2": "é¯Šé­šéšŠ", ...}`
- ç”¨é€”: å„²å­˜æ¯å€‹éšŠä¼çš„è‡ªè¨‚é¡¯ç¤ºåç¨±
- é è¨­: NULLï¼ˆä½¿ç”¨ users.team_nameï¼‰

**ä»£ç¢¼**: ä¿æŒä¸è®Šï¼ˆå·²æ­£ç¢ºä½¿ç”¨ï¼‰
```javascript
// âœ… æ­£ç¢ºä½¿ç”¨
const teamNames = JSON.parse(game.team_names || '{}');
UPDATE games SET team_names = ? WHERE id = ?
```

---

## ğŸ“Š ä¿®æ­£çµ±è¨ˆ

### ä¿®æ”¹çš„æª”æ¡ˆ

| æª”æ¡ˆ | ä¿®æ­£é …ç›® | ä¿®æ”¹æ¬¡æ•¸ |
|------|---------|---------|
| `complete_database_structure.sql` | æ·»åŠ  team_names æ¬„ä½ | 1 è¡Œ |
| `backend/server.js` | game_name â†’ name (SELECT) | 1 è™• |
| `backend/server.js` | game_name â†’ name (INSERT) | 1 è™• |
| `backend/server.js` | game.game_name â†’ game.name | å…¨å±€æ›¿æ› |
| `backend/server.js` | participant.game_name â†’ participant.name | å…¨å±€æ›¿æ› |

### æœå°‹çµæœé©—è­‰

**ä¿®æ­£å‰**:
```bash
grep "game_name" backend/server.js
# æ‰¾åˆ° 10+ è™•ä½¿ç”¨ game_name
```

**ä¿®æ­£å¾Œ**:
```bash
grep "game_name" backend/server.js
# No matches found âœ…
```

---

## âœ… é©—è­‰æ¸¬è©¦

### èªæ³•æª¢æŸ¥
```bash
node --check backend/server.js
# âœ… é€šéï¼ˆç„¡è¼¸å‡ºï¼‰
```

### åŠŸèƒ½é©—è­‰æ¸…å–®

- [ ] **å‰µå»ºéŠæˆ² API**
  ```bash
  POST /api/admin/games/create
  {
    "gameName": "æ¸¬è©¦éŠæˆ²",
    "initialBudget": 1000000,
    ...
  }
  # é æœŸ: æˆåŠŸå‰µå»ºï¼Œgames è¡¨æ’å…¥ name='æ¸¬è©¦éŠæˆ²'
  ```

- [ ] **QR Code ç”Ÿæˆ**
  ```bash
  GET /api/qr/:gameId
  # é æœŸ: æˆåŠŸè¿”å› gameName å’Œ QR code
  ```

- [ ] **éšŠä¼åŠ å…¥éŠæˆ²ä¸¦è¨­å®šåç¨±**
  ```bash
  POST /api/game/:gameId/join
  {
    "teamId": 1,
    "teamDisplayName": "æµ·ç›œéšŠ"
  }
  # é æœŸ: games.team_names æ›´æ–°ç‚º {"1": "æµ·ç›œéšŠ"}
  ```

- [ ] **è®€å–éšŠä¼åç¨±**
  ```javascript
  const teamNames = JSON.parse(game.team_names || '{}');
  const displayName = teamNames[teamId] || user.team_name;
  # é æœŸ: æ­£ç¢ºè®€å–è‡ªè¨‚åç¨±æˆ–é è¨­åç¨±
  ```

---

## ğŸ” å½±éŸ¿åˆ†æ

### ä¿®æ­£å‰çš„éŒ¯èª¤

**å‰µå»ºéŠæˆ²æ™‚**:
```
Error: ER_BAD_FIELD_ERROR: Unknown column 'game_name' in 'field list'
HTTP 500 Internal Server Error
```

**ä½¿ç”¨ team_names æ™‚**:
```
Error: ER_BAD_FIELD_ERROR: Unknown column 'team_names' in 'field list'
HTTP 500 Internal Server Error
```

### ä¿®æ­£å¾Œçš„è¡Œç‚º

**å‰µå»ºéŠæˆ²**:
```javascript
// âœ… æˆåŠŸ
INSERT INTO games (name, ...) VALUES ('æ¸¬è©¦éŠæˆ²', ...)
Result: { insertId: 1, affectedRows: 1 }
```

**è¨­å®šéšŠä¼åç¨±**:
```javascript
// âœ… æˆåŠŸ
UPDATE games SET team_names = '{"1":"æµ·ç›œéšŠ"}' WHERE id = 1
Result: { affectedRows: 1 }
```

---

## ğŸ“ è³‡æ–™åº« Schema æœ€çµ‚ç‰ˆæœ¬

### games è¡¨ï¼ˆä¿®æ­£å¾Œï¼‰

```sql
CREATE TABLE IF NOT EXISTS `games` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL,                    -- âœ… ä¸»è¦æ¬„ä½
  `description` text,
  `status` enum('pending','active','completed') NOT NULL DEFAULT 'pending',
  `phase` enum('waiting','buying','selling','settling','day_ended') DEFAULT 'waiting',
  `total_days` int(11) NOT NULL DEFAULT 7,
  `current_day` int(11) NOT NULL DEFAULT 0,
  `num_teams` int(11) NOT NULL DEFAULT 10,
  `team_names` json DEFAULT NULL,                  -- âœ… æ–°å¢æ¬„ä½
  `initial_budget` decimal(12,2) NOT NULL DEFAULT 1000000.00,
  `daily_interest_rate` decimal(5,4) NOT NULL DEFAULT 0.0300,
  `loan_interest_rate` decimal(5,4) NOT NULL DEFAULT 0.0300,
  `max_loan_ratio` decimal(5,2) NOT NULL DEFAULT 0.50,
  `unsold_fee_per_kg` decimal(10,2) NOT NULL DEFAULT 10.00,
  `fixed_unsold_ratio` decimal(5,2) NOT NULL DEFAULT 2.50,
  `distributor_floor_price_a` decimal(10,2) NOT NULL DEFAULT 100.00,
  `distributor_floor_price_b` decimal(10,2) NOT NULL DEFAULT 80.00,
  `target_price_a` decimal(10,2) NOT NULL DEFAULT 150.00,
  `target_price_b` decimal(10,2) NOT NULL DEFAULT 120.00,
  `buying_duration` int(11) NOT NULL DEFAULT 7,
  `selling_duration` int(11) NOT NULL DEFAULT 4,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_phase` (`phase`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## ğŸ¯ ä½¿ç”¨ç¯„ä¾‹

### team_names æ¬„ä½ä½¿ç”¨

**å„²å­˜æ ¼å¼**:
```json
{
  "1": "æµ·ç›œéšŠ",
  "2": "é¯Šé­šéšŠ",
  "3": "é‡‘æ§é­šéšŠ",
  "10": "å¤§ç™½é¯ŠéšŠ"
}
```

**è®€å–é‚è¼¯**:
```javascript
// 1. å¾ games è¡¨è®€å–
const [games] = await db.execute('SELECT team_names FROM games WHERE id = ?', [gameId]);
const teamNames = JSON.parse(games[0].team_names || '{}');

// 2. ç²å–éšŠä¼é¡¯ç¤ºåç¨±
const displayName = teamNames[teamId] || user.team_name || `éšŠä¼${teamId}`;

// 3. æ›´æ–°éšŠä¼åç¨±
teamNames[teamId] = newDisplayName;
await db.execute(
  'UPDATE games SET team_names = ? WHERE id = ?',
  [JSON.stringify(teamNames), gameId]
);
```

**å‰ç«¯é¡¯ç¤º**:
```javascript
// å„ªå…ˆä½¿ç”¨è‡ªè¨‚åç¨±ï¼Œå¦å‰‡ä½¿ç”¨é è¨­åç¨±
<div>
  {game.teamNames?.[teamId] || team.team_name || `Team ${teamId}`}
</div>
```

---

## ğŸ”„ é·ç§»æŒ‡å—

### å°æ–¼ç¾æœ‰è³‡æ–™åº«

å¦‚æœå·²ç¶“æœ‰é‹è¡Œä¸­çš„è³‡æ–™åº«ï¼Œéœ€è¦åŸ·è¡Œä»¥ä¸‹é·ç§»ï¼š

```sql
-- 1. æ·»åŠ  team_names æ¬„ä½
ALTER TABLE games ADD COLUMN `team_names` json DEFAULT NULL COMMENT 'éšŠä¼åç¨±æ˜ å°„ {teamId: displayName}';

-- 2. ç¢ºèªç¾æœ‰è³‡æ–™
SELECT id, name, team_names FROM games;

-- 3. å¦‚æœæœ‰èˆŠè³‡æ–™ä½¿ç”¨ game_nameï¼Œéœ€è¦é‡å‘½åæ¬„ä½ï¼ˆä¸å¤ªå¯èƒ½ï¼Œå› ç‚ºæœƒå ±éŒ¯ï¼‰
-- æ³¨æ„ï¼šé€šå¸¸ä¸éœ€è¦æ­¤æ­¥é©Ÿï¼Œå› ç‚ºç¾æœ‰çš„ schema å·²ç¶“æ˜¯ name
```

### å°æ–¼å…¨æ–°éƒ¨ç½²

ç›´æ¥ä½¿ç”¨æ›´æ–°å¾Œçš„ `complete_database_structure.sql`ï¼š
```bash
mysql -u root -p fishmarket_game < complete_database_structure.sql
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶æ›´æ–°

### éœ€è¦æ›´æ–°çš„æ–‡ä»¶

1. **API æ–‡æª”**
   - æ›´æ–°å‰µå»ºéŠæˆ²çš„ç¯„ä¾‹
   - èªªæ˜ team_names çš„ä½¿ç”¨æ–¹å¼

2. **è³‡æ–™åº« Schema æ–‡æª”**
   - æ¨™è¨» `name` æ˜¯æ¨™æº–æ¬„ä½åç¨±
   - èªªæ˜ `team_names` JSON æ ¼å¼

3. **å‰ç«¯ä»£ç¢¼**ï¼ˆå¦‚æœæœ‰ï¼‰
   - ç¢ºèªæ‰€æœ‰ API è«‹æ±‚ä½¿ç”¨æ­£ç¢ºçš„æ¬„ä½åç¨±
   - æ›´æ–°é¡¯ç¤ºé‚è¼¯ä»¥ä½¿ç”¨ team_names

---

## âš ï¸ æ³¨æ„äº‹é …

### ç ´å£æ€§è®Šæ›´

**å°æ–¼æ­£åœ¨é‹è¡Œçš„ç³»çµ±**:
- âœ… æ·»åŠ  `team_names` æ¬„ä½æ˜¯**å®‰å…¨**çš„ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
- âš ï¸ ä»£ç¢¼ä¸­çš„ `game_name` ä¿®æ­£å¯èƒ½éœ€è¦é‡å•Ÿæœå‹™
- âœ… ç¾æœ‰è³‡æ–™ä¸å—å½±éŸ¿ï¼ˆå› ç‚º schema æœ¬ä¾†å°±æ˜¯ `name`ï¼‰

### å›æ»¾è¨ˆåŠƒ

å¦‚æœä¿®æ­£å¾Œå‡ºç¾å•é¡Œï¼š

```sql
-- ç§»é™¤ team_names æ¬„ä½
ALTER TABLE games DROP COLUMN team_names;
```

```javascript
// æ¢å¾©ä»£ç¢¼ï¼ˆä¸å»ºè­°ï¼‰
// å°‡æ‰€æœ‰ game.name æ”¹å› game.game_name
// ä¸¦å°‡è³‡æ–™åº«æ¬„ä½æ”¹å
ALTER TABLE games CHANGE name game_name varchar(100) NOT NULL;
```

**å»ºè­°**: ä¸è¦å›æ»¾ï¼Œå› ç‚ºåŸæœ¬çš„å¯¦ç¾å°±æ˜¯éŒ¯èª¤çš„

---

## ğŸ“ˆ æ¸¬è©¦è¨ˆåŠƒ

### å–®å…ƒæ¸¬è©¦

```javascript
describe('Games API', () => {
  it('should create game with correct field name', async () => {
    const response = await request(app)
      .post('/api/admin/games/create')
      .send({
        gameName: 'æ¸¬è©¦éŠæˆ²',
        initialBudget: 1000000
      });

    expect(response.status).toBe(200);
    expect(response.body.gameId).toBeDefined();

    // é©—è­‰è³‡æ–™åº«
    const [games] = await db.execute(
      'SELECT name FROM games WHERE id = ?',
      [response.body.gameId]
    );
    expect(games[0].name).toBe('æ¸¬è©¦éŠæˆ²');
  });

  it('should handle team_names JSON field', async () => {
    const gameId = 1;
    const teamNames = { "1": "æµ·ç›œéšŠ", "2": "é¯Šé­šéšŠ" };

    await db.execute(
      'UPDATE games SET team_names = ? WHERE id = ?',
      [JSON.stringify(teamNames), gameId]
    );

    const [games] = await db.execute(
      'SELECT team_names FROM games WHERE id = ?',
      [gameId]
    );

    const parsed = JSON.parse(games[0].team_names);
    expect(parsed["1"]).toBe("æµ·ç›œéšŠ");
    expect(parsed["2"]).toBe("é¯Šé­šéšŠ");
  });
});
```

### æ•´åˆæ¸¬è©¦

1. å‰µå»ºæ–°éŠæˆ²
2. 10å€‹éšŠä¼åŠ å…¥éŠæˆ²ä¸¦è¨­å®šåç¨±
3. é–‹å§‹ç¬¬1å¤©
4. é©—è­‰æ‰€æœ‰éšŠä¼åç¨±æ­£ç¢ºé¡¯ç¤º
5. æª¢æŸ¥ QR Code åŒ…å«æ­£ç¢ºçš„éŠæˆ²åç¨±

---

## âœ… ä¿®æ­£å®Œæˆç¢ºèª

- [x] è³‡æ–™åº« schema æ·»åŠ  `team_names` æ¬„ä½
- [x] æ‰€æœ‰ `game_name` æ”¹ç‚º `name` (SELECT)
- [x] æ‰€æœ‰ `game_name` æ”¹ç‚º `name` (INSERT)
- [x] æ‰€æœ‰ `game.game_name` æ”¹ç‚º `game.name`
- [x] æ‰€æœ‰ `participant.game_name` æ”¹ç‚º `participant.name`
- [x] èªæ³•æª¢æŸ¥é€šé
- [ ] åŠŸèƒ½æ¸¬è©¦é€šéï¼ˆå¾…åŸ·è¡Œï¼‰

---

## ğŸ‰ ç¸½çµ

### ä¿®æ­£å‰

```
âŒ å‰µå»ºéŠæˆ² â†’ 500 Error (game_name æ¬„ä½ä¸å­˜åœ¨)
âŒ è¨­å®šéšŠå â†’ 500 Error (team_names æ¬„ä½ä¸å­˜åœ¨)
âŒ QR Code  â†’ 500 Error (ç„¡æ³•è®€å– game_name)
```

### ä¿®æ­£å¾Œ

```
âœ… å‰µå»ºéŠæˆ² â†’ æˆåŠŸä½¿ç”¨ name æ¬„ä½
âœ… è¨­å®šéšŠå â†’ æˆåŠŸä½¿ç”¨ team_names JSON æ¬„ä½
âœ… QR Code  â†’ æˆåŠŸè®€å– game.name
```

---

**ä¿®æ­£ç‹€æ…‹**: âœ… å®Œæˆ
**æ¸¬è©¦ç‹€æ…‹**: â³ å¾…æ¸¬è©¦
**éƒ¨ç½²å»ºè­°**: é‡æ–°åˆå§‹åŒ–è³‡æ–™åº«å¾Œé‡å•Ÿæœå‹™

**æ–‡æª”ç¶­è­·**: Claude Code
