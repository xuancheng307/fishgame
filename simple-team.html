<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é­šå¸‚å ´éŠæˆ² - å­¸ç”Ÿä»‹é¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: #f0f2f5; 
            padding: 15px; 
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .card h3 { margin-bottom: 15px; color: #333; }
        
        .phase-banner {
            background: #e6f7ff;
            color: #0050b3;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .phase-banner.buying { background: #fff1f0; color: #cf1322; }
        .phase-banner.selling { background: #f6ffed; color: #52c41a; }
        .phase-banner.settling { background: #fff7e6; color: #d46b08; }
        
        .timer-display {
            font-size: 36px;
            font-weight: bold;
            color: #1890ff;
            text-align: center;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .status-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #1890ff;
        }
        
        .status-card h4 {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .status-card .value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .bidding-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: white;
            font-weight: bold;
        }
        
        .bidding-tabs .tab:first-child.active {
            background: #ff4d4f;
            border-color: #ff4d4f;
            box-shadow: 0 2px 8px rgba(255,77,79,0.3);
        }
        
        .bidding-tabs .tab:last-child.active {
            background: #52c41a;
            border-color: #52c41a;
            box-shadow: 0 2px 8px rgba(82,196,26,0.3);
        }
        
        .tab:hover:not(.active) {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .fish-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .fish-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #fafafa;
            border: 2px solid #d9d9d9;
            margin-right: 5px;
            border-radius: 4px;
            transition: all 0.3s;
            font-size: 18px;
            font-weight: bold;
        }
        
        .fish-tab:hover:not(.active) {
            background: #e6e6e6;
            transform: translateY(-2px);
        }
        
        .fish-tab:last-child {
            margin-right: 0;
        }
        
        .fish-tab.active {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
            box-shadow: 0 2px 8px rgba(24,144,255,0.3);
        }
        
        .price-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .price-group {
            padding: 20px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .price-group h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
            font-weight: bold;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d9d9d9;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
            background: white;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.2);
        }
        
        /* ç¢ºä¿æ•¸å­—è¼¸å…¥æ¡†æ­£å¸¸é¡¯ç¤º */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 40px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #1890ff; color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-info { background: #13c2c2; color: white; }
        .btn-info:hover { background: #36cfc9; }
        .btn-success { background: #52c41a; color: white; }
        .btn-success:hover { background: #73d13d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .submit-area {
            text-align: center;
            margin-top: 20px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th, .table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .table th {
            background: #fafafa;
            font-weight: 600;
        }
        
        .monitoring-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .alert {
            padding: 15px;
            background: #fff1f0;
            border: 1px solid #ffccc7;
            border-radius: 4px;
            color: #cf1322;
            margin-top: 15px;
        }
        
        .alert.success {
            background: #f6ffed;
            border-color: #b7eb8f;
            color: #52c41a;
        }
        
        .alert.info {
            background: #e6f7ff;
            border-color: #91d5ff;
            color: #0050b3;
        }
        
        .join-game-card {
            text-align: center;
            padding: 50px 20px;
        }
        
        .join-btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .join-btn:hover {
            background: #40a9ff;
        }
        
        .used-prices {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .monitoring-panel {
                grid-template-columns: 1fr;
            }
            .price-inputs {
                grid-template-columns: 1fr;
            }
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="header">
            <h1>é­šå¸‚å ´éŠæˆ²</h1>
            <div>
                <span id="currentTeam"></span>
                <button class="btn btn-info" onclick="openSettings()" style="margin-left: 15px;">âš™ï¸ è¨­å®š</button>
                <button class="btn btn-info" onclick="openGameInstructions()" style="margin-left: 15px;">ğŸ¯ éŠæˆ²èªªæ˜</button>
                <button class="btn btn-primary" onclick="logout()" style="margin-left: 15px;">ç™»å‡º</button>
            </div>
        </div>

        <!-- æœªåŠ å…¥éŠæˆ²æ™‚é¡¯ç¤º -->
        <div id="joinGameSection" class="card join-game-card" style="display: none;">
            <h2 style="margin-bottom: 20px;">æ­¡è¿ä¾†åˆ°é­šå¸‚å ´éŠæˆ²</h2>
            <p style="margin-bottom: 30px; color: #666;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥ç•¶å‰éŠæˆ²</p>
            <button id="joinBtn" class="join-btn" onclick="joinGame()">åŠ å…¥ç•¶å‰éŠæˆ²</button>
        </div>

        <!-- å·²åŠ å…¥éŠæˆ²ä¸»ä»‹é¢ -->
        <div id="gameInterface" style="display: none;">
            <!-- ç•¶å‰éŠæˆ²ç‹€æ…‹å€å¡Š -->
            <div class="card" id="currentGameStatus">
                <h3 id="gameTitle">ç•¶å‰éŠæˆ²</h3>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span id="gameName">è¼‰å…¥ä¸­...</span> - ç¬¬ <span id="dayNumber">-</span> å¤©
                    </div>
                    <div id="timerDisplay" class="timer-display" style="display: none; font-size: 24px; font-weight: bold; color: #cf1322;">
                        00:00
                    </div>
                </div>
            </div>

            <!-- éŠæˆ²ç‹€æ…‹æ©«å¹… -->
            <div id="phaseBanner" class="phase-banner">ç­‰å¾…é–‹å§‹</div>

            <!-- æˆ‘çš„è³‡ç”¢å¡ -->
            <div class="card">
                <h3>æˆ‘çš„è³‡ç”¢ç‹€æ³</h3>
                <div class="status-grid">
                    <div class="status-card">
                        <h4>ç¾é‡‘</h4>
                        <div class="value" id="currentBudget">$0</div>
                    </div>
                    <div class="status-card">
                        <h4>ç¸½å€Ÿè²¸</h4>
                        <div class="value" id="totalLoan">$0</div>
                    </div>
                    <div class="status-card">
                        <h4>Aé­šåº«å­˜</h4>
                        <div class="value" id="fishAInventory">0 kg</div>
                    </div>
                    <div class="status-card">
                        <h4>Bé­šåº«å­˜</h4>
                        <div class="value" id="fishBInventory">0 kg</div>
                    </div>
                    <div class="status-card">
                        <h4>ç´¯ç©æ”¶ç›Š</h4>
                        <div class="value" id="cumulativeProfit">$0</div>
                    </div>
                    <div class="status-card">
                        <h4>ROI</h4>
                        <div class="value" id="roi">0.00%</div>
                    </div>
                </div>
            </div>

            <!-- å¸‚å ´è³‡è¨Šå¡ -->
            <div class="card">
                <h3>ç•¶æ—¥å¸‚å ´è³‡è¨Š</h3>
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Aé­šä¾›çµ¦é‡</h4>
                        <div class="value" id="fishASupply">- kg</div>
                    </div>
                    <div class="status-card">
                        <h4>Bé­šä¾›çµ¦é‡</h4>
                        <div class="value" id="fishBSupply">- kg</div>
                    </div>
                    <div class="status-card">
                        <h4>Aé­šé¤å»³é ç®—</h4>
                        <div class="value" id="fishABudget">$-</div>
                    </div>
                    <div class="status-card">
                        <h4>Bé­šé¤å»³é ç®—</h4>
                        <div class="value" id="fishBBudget">$-</div>
                    </div>
                </div>
            </div>

            <!-- éŠæˆ²è¦å‰‡å¡ -->
            <div class="card">
                <h3>éŠæˆ²è¦å‰‡åƒæ•¸</h3>
                <div class="status-grid">
                    <div class="status-card">
                        <h4>åˆå§‹é ç®—</h4>
                        <div class="value" id="initialBudget">$-</div>
                    </div>
                    <div class="status-card">
                        <h4>ç¸½éŠæˆ²å¤©æ•¸</h4>
                        <div class="value" id="totalDays">- å¤©</div>
                    </div>
                    <div class="status-card">
                        <h4>è²¸æ¬¾åˆ©ç‡</h4>
                        <div class="value" id="loanInterestRate">-%</div>
                    </div>
                    <div class="status-card">
                        <h4>æ»¯éŠ·è²»ç”¨</h4>
                        <div class="value" id="unsoldFeePerKg">$/kg</div>
                    </div>
                    <div class="status-card">
                        <h4>Aé­šç›®æ¨™åƒ¹</h4>
                        <div class="value" id="targetPriceA">$-</div>
                    </div>
                    <div class="status-card">
                        <h4>Bé­šç›®æ¨™åƒ¹</h4>
                        <div class="value" id="targetPriceB">$-</div>
                    </div>
                </div>
            </div>

            <!-- ä¸‹å–®å€ -->
            <div class="card">
                <h3>ä¸‹å–®å€åŸŸ</h3>
                
                <!-- è²·å…¥/è³£å‡ºåˆ‡æ› -->
                <div class="bidding-tabs">
                    <button class="tab active" onclick="switchBidType('buy')">ğŸ›’ è²·å…¥æŠ•æ¨™</button>
                    <button class="tab" onclick="switchBidType('sell')">ğŸ’° è³£å‡ºæŠ•æ¨™</button>
                </div>

                <!-- è²·å…¥è¡¨å–® -->
                <div id="buyTab" class="tab-content active">
                    <!-- Aé­š/Bé­šåˆ‡æ› -->
                    <div class="fish-tabs">
                        <button class="fish-tab active" onclick="switchFish('buy', 'A')">Aé­š</button>
                        <button class="fish-tab" onclick="switchFish('buy', 'B')">Bé­š</button>
                    </div>

                    <!-- Aé­šè²·å…¥ -->
                    <div id="buyFishA" class="fish-content">
                        <div class="price-inputs">
                            <div class="price-group">
                                <h4>åƒ¹ä½ 1</h4>
                                <input type="number" class="form-input" id="buyAPriceGroup1Price" placeholder="å–®åƒ¹ ($)" step="1" min="1" inputmode="numeric" pattern="\d+">
                                <input type="number" class="form-input" id="buyAPriceGroup1Qty" placeholder="æ•¸é‡ (kg)" step="1" min="1" inputmode="numeric" pattern="\d+">
                            </div>
                            <div class="price-group">
                                <h4>åƒ¹ä½ 2</h4>
                                <input type="number" class="form-input" id="buyAPriceGroup2Price" placeholder="å–®åƒ¹ ($)" step="1" min="1" inputmode="numeric" pattern="\d+">
                                <input type="number" class="form-input" id="buyAPriceGroup2Qty" placeholder="æ•¸é‡ (kg)" step="1" min="1" inputmode="numeric" pattern="\d+">
                            </div>
                        </div>
                        <div class="used-prices" id="buyAUsedPrices">å·²ä½¿ç”¨åƒ¹ä½: ç„¡</div>
                        <div class="submit-area">
                            <button class="btn btn-success submit-btn" onclick="submitBid('buy', 'A')">æäº¤Aé­šè²·å…¥</button>
                        </div>
                    </div>

                    <!-- Bé­šè²·å…¥ -->
                    <div id="buyFishB" class="fish-content" style="display: none;">
                        <div class="price-inputs">
                            <div class="price-group">
                                <h4>åƒ¹ä½ 1</h4>
                                <input type="number" class="form-input" id="buyBPriceGroup1Price" placeholder="å–®åƒ¹ ($)" step="1" min="1" inputmode="numeric" pattern="\d+">
                                <input type="number" class="form-input" id="buyBPriceGroup1Qty" placeholder="æ•¸é‡ (kg)" step="1" min="1" inputmode="numeric" pattern="\d+">
                            </div>
                            <div class="price-group">
                                <h4>åƒ¹ä½ 2</h4>
                                <input type="number" class="form-input" id="buyBPriceGroup2Price" placeholder="å–®åƒ¹ ($)" step="1" min="1" inputmode="numeric" pattern="\d+">
                                <input type="number" class="form-input" id="buyBPriceGroup2Qty" placeholder="æ•¸é‡ (kg)" step="1" min="1" inputmode="numeric" pattern="\d+">
                            </div>
                        </div>
                        <div class="used-prices" id="buyBUsedPrices">å·²ä½¿ç”¨åƒ¹ä½: ç„¡</div>
                        <div class="submit-area">
                            <button class="btn btn-success submit-btn" onclick="submitBid('buy', 'B')">æäº¤Bé­šè²·å…¥</button>
                        </div>
                    </div>
                </div>

                <!-- è³£å‡ºè¡¨å–® -->
                <div id="sellTab" class="tab-content">
                    <!-- Aé­š/Bé­šåˆ‡æ› -->
                    <div class="fish-tabs">
                        <button class="fish-tab active" onclick="switchFish('sell', 'A')">Aé­š</button>
                        <button class="fish-tab" onclick="switchFish('sell', 'B')">Bé­š</button>
                    </div>

                    <!-- Aé­šè³£å‡º -->
                    <div id="sellFishA" class="fish-content">
                        <div class="price-inputs">
                            <div class="price-group">
                                <h4>åƒ¹ä½ 1</h4>
                                <input type="number" class="form-input" id="sellAPriceGroup1Price" placeholder="å–®åƒ¹ ($)" step="1" min="1" inputmode="numeric" pattern="\d+">
                                <input type="number" class="form-input" id="sellAPriceGroup1Qty" placeholder="æ•¸é‡ (kg)" step="1" min="1" inputmode="numeric" pattern="\d+">
                            </div>
                            <div class="price-group">
                                <h4>åƒ¹ä½ 2</h4>
                                <input type="number" class="form-input" id="sellAPriceGroup2Price" placeholder="å–®åƒ¹ ($)" step="1" min="1" inputmode="numeric" pattern="\d+">
                                <input type="number" class="form-input" id="sellAPriceGroup2Qty" placeholder="æ•¸é‡ (kg)" step="1" min="1" inputmode="numeric" pattern="\d+">
                            </div>
                        </div>
                        <div class="used-prices" id="sellAUsedPrices">å·²ä½¿ç”¨åƒ¹ä½: ç„¡</div>
                        <div class="submit-area">
                            <button class="btn btn-success submit-btn" onclick="submitBid('sell', 'A')">æäº¤Aé­šè³£å‡º</button>
                        </div>
                    </div>

                    <!-- Bé­šè³£å‡º -->
                    <div id="sellFishB" class="fish-content" style="display: none;">
                        <div class="price-inputs">
                            <div class="price-group">
                                <h4>åƒ¹ä½ 1</h4>
                                <input type="number" class="form-input" id="sellBPriceGroup1Price" placeholder="å–®åƒ¹ ($)" step="1" min="1" inputmode="numeric" pattern="\d+">
                                <input type="number" class="form-input" id="sellBPriceGroup1Qty" placeholder="æ•¸é‡ (kg)" step="1" min="1" inputmode="numeric" pattern="\d+">
                            </div>
                            <div class="price-group">
                                <h4>åƒ¹ä½ 2</h4>
                                <input type="number" class="form-input" id="sellBPriceGroup2Price" placeholder="å–®åƒ¹ ($)" step="1" min="1" inputmode="numeric" pattern="\d+">
                                <input type="number" class="form-input" id="sellBPriceGroup2Qty" placeholder="æ•¸é‡ (kg)" step="1" min="1" inputmode="numeric" pattern="\d+">
                            </div>
                        </div>
                        <div class="used-prices" id="sellBUsedPrices">å·²ä½¿ç”¨åƒ¹ä½: ç„¡</div>
                        <div class="submit-area">
                            <button class="btn btn-success submit-btn" onclick="submitBid('sell', 'B')">æäº¤Bé­šè³£å‡º</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¯æ—¥çµç®—è³‡è¨Šå¡ -->
            <div class="card" id="settlementCard" style="display: none;">
                <h3>æœ€æ–°çµç®—è³‡è¨Š</h3>
                <div class="status-grid">
                    <div class="status-card">
                        <h4>è²·å…¥æˆæœ¬</h4>
                        <div class="value" id="settlementCost">$0</div>
                    </div>
                    <div class="status-card">
                        <h4>è³£å‡ºæ”¶å…¥</h4>
                        <div class="value" id="settlementRevenue">$0</div>
                    </div>
                    <div class="status-card">
                        <h4>Aé­šæ»¯éŠ·</h4>
                        <div class="value" id="unsoldFishA">0 kg</div>
                    </div>
                    <div class="status-card">
                        <h4>Bé­šæ»¯éŠ·</h4>
                        <div class="value" id="unsoldFishB">0 kg</div>
                    </div>
                    <div class="status-card">
                        <h4>æ»¯éŠ·è²»ç”¨</h4>
                        <div class="value" id="unsoldFee" style="color: #cf1322;">$0</div>
                    </div>
                    <div class="status-card">
                        <h4>åˆ©æ¯æ”¯å‡º</h4>
                        <div class="value" id="interestFee" style="color: #cf1322;">$0</div>
                    </div>
                    <div class="status-card">
                        <h4>ç•¶æ—¥æ·¨åˆ©</h4>
                        <div class="value" id="dailyProfit">$0</div>
                    </div>
                    <div class="status-card">
                        <h4>çµç®—æ™‚é–“</h4>
                        <div class="value" id="settlementTime">-</div>
                    </div>
                </div>
            </div>

            <!-- ç›£æ§é¢æ¿ -->
            <div class="monitoring-panel">
                <!-- åŒ¿åè¨‚å–®ç°¿ -->
                <div class="card">
                    <h3>åŒ¿åè¨‚å–®ç°¿</h3>
                    <div>
                        <h4>Aé­š</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åƒ¹æ ¼</th>
                                    <th>æ•¸é‡</th>
                                    <th>é¡å‹</th>
                                </tr>
                            </thead>
                            <tbody id="orderbookA"></tbody>
                        </table>
                        
                        <h4 style="margin-top: 20px;">Bé­š</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åƒ¹æ ¼</th>
                                    <th>æ•¸é‡</th>
                                    <th>é¡å‹</th>
                                </tr>
                            </thead>
                            <tbody id="orderbookB"></tbody>
                        </table>
                    </div>
                </div>

                <!-- å°æ’è¡Œæ¦œ -->
                <div class="card">
                    <h3>æ’è¡Œæ¦œ (å‰10å)
                        <button class="btn btn-primary" onclick="loadLeaderboard()" style="float: right; padding: 5px 10px; font-size: 12px;">åˆ·æ–°</button>
                    </h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>éšŠä¼</th>
                                <th>ROI</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard"></tbody>
                    </table>
                </div>
            </div>

            <!-- æ­·å²æŠ•æ¨™ç´€éŒ„å€å¡Š -->
            <div class="card">
                <h3>æ­·å²æŠ•æ¨™ç´€éŒ„</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: end;">
                    <div class="form-group" style="min-width: 120px;">
                        <label for="bidHistoryDay">é¸æ“‡å¤©æ•¸:</label>
                        <select id="bidHistoryDay" class="form-input">
                            <option value="">è«‹é¸æ“‡å¤©æ•¸</option>
                        </select>
                    </div>
                    <div class="form-group" style="min-width: 120px;">
                        <label for="bidHistoryType">æŠ•æ¨™é¡å‹:</label>
                        <select id="bidHistoryType" class="form-input">
                            <option value="buy">è²·å…¥æŠ•æ¨™</option>
                            <option value="sell">è³£å‡ºæŠ•æ¨™</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadBidHistory()">æŸ¥è©¢ç´€éŒ„</button>
                    <button class="btn btn-success" onclick="loadCompleteBidSummary()" style="margin-left: 10px;">æŸ¥çœ‹å®Œæ•´çµ±è¨ˆ</button>
                </div>
                <div id="bidHistoryContent">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        ğŸ“Š è«‹é¸æ“‡å¤©æ•¸å’ŒæŠ•æ¨™é¡å‹æŸ¥çœ‹æ­·å²æˆäº¤ç´€éŒ„
                    </div>
                </div>
            </div>

            <!-- è¨Šæ¯å€ -->
            <div id="messageArea"></div>
        </div>

        <!-- è¨­å®šå°è©±æ¡† -->
        <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                <h2 style="margin-bottom: 20px;">è¨­å®š</h2>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å°çµ„åç¨±:</label>
                    <input type="text" id="teamNameInput" class="form-input" placeholder="è¼¸å…¥å°çµ„åç¨±" style="width: 100%;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ–°å¯†ç¢¼:</label>
                    <input type="text" id="newPasswordInput" class="form-input" placeholder="è¼¸å…¥æ–°å¯†ç¢¼(ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹)" style="width: 100%;">
                    <small style="color: #666;">ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å¯†ç¢¼</small>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveSettings()">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let gameId = null;
        let currentDayId = null;
        let currentPhase = 'waiting';
        let teamData = null;
        let usedPrices = { buy: { A: [], B: [] }, sell: { A: [], B: [] } };
        
        // New variables for real-time updates
        let gameStatusInterval = null;
        let countdownInterval = null;
        let currentEndTime = null;
        
        // é é¢è¼‰å…¥
        window.onload = function() {
            checkAuth();
            loadGameStatus();
            initializeRealtimeUpdates();
        };
        
        // æª¢æŸ¥èªè­‰
        function checkAuth() {
            const token = localStorage.getItem('token');
            const role = localStorage.getItem('role');
            const username = localStorage.getItem('username');
            
            if (!token || role !== 'team') {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('currentTeam').textContent = `éšŠä¼: ${username || 'æœªçŸ¥'}`;
        }
        
        // è¼‰å…¥éŠæˆ²ç‹€æ…‹
        async function loadGameStatus() {
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰éŠæˆ²ID
            gameId = localStorage.getItem('game_id');
            
            if (!gameId) {
                // é¡¯ç¤ºåŠ å…¥éŠæˆ²ç•Œé¢
                document.getElementById('joinGameSection').style.display = 'block';
                document.getElementById('gameInterface').style.display = 'none';
                return;
            }
            
            // å–å¾—åœ˜éšŠè³‡æ–™
            await loadTeamSummary();
            
            // é¡¯ç¤ºéŠæˆ²ç•Œé¢
            document.getElementById('joinGameSection').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'block';
            
            // è¼‰å…¥å…¶ä»–è³‡æ–™
            loadOrderbook();
            loadLeaderboard();
            loadUsedPrices();
        }
        
        // åŠ å…¥éŠæˆ²
        async function joinGame() {
            const btn = document.getElementById('joinBtn');
            btn.disabled = true;
            btn.textContent = 'åŠ å…¥ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE}/team/join-current`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    gameId = data.game_id;
                    localStorage.setItem('game_id', gameId);
                    showMessage('æˆåŠŸåŠ å…¥éŠæˆ²ï¼', 'success');
                    loadGameStatus();
                } else {
                    throw new Error(data.error?.message || data.error || 'åŠ å…¥éŠæˆ²å¤±æ•—');
                }
            } catch (error) {
                showMessage(`åŠ å…¥éŠæˆ²éŒ¯èª¤: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'åŠ å…¥ç•¶å‰éŠæˆ²';
            }
        }
        
        // Add phase normalization function
        function normalizePhase(dayStatus) {
            const map = {
                'pending': 'waiting',
                'buying_open': 'buying',
                'buying_closed': 'buy_closed',
                'selling_open': 'selling',
                'selling_closed': 'sell_closed',
                'settled': 'settling'
            };
            return map[dayStatus] || dayStatus || 'waiting';
        }
        
        // è¼‰å…¥åœ˜éšŠæ‘˜è¦
        async function loadTeamSummary() {
            if (!gameId) return;
            
            try {
                const response = await fetch(`${API_BASE}/team/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    teamData = data;
                    updateTeamDisplay(data);
                    // Fix: Use normalized phase from gameInfo.dayStatus
                    const normalized = normalizePhase(data.gameInfo?.dayStatus);
                    currentPhase = normalized;
                    updatePhaseControls(normalized);
                }
            } catch (error) {
                console.error('è¼‰å…¥åœ˜éšŠæ‘˜è¦éŒ¯èª¤:', error);
            }
        }
        
        // æ›´æ–°åœ˜éšŠé¡¯ç¤º
        function updateTeamDisplay(data) {
            // å¾ dashboard API çš„å›æ‡‰ä¸­ç²å–è³‡æ–™ - ä½¿ç”¨å¾Œç«¯å¯¦éš›çµæ§‹
            currentPhase = data.gameInfo?.dayStatus || 'waiting';
            currentDayId = data.gameInfo?.currentDay;
            
            // æ›´æ–°è³‡ç”¢å¡ - ä½¿ç”¨ financials ä¸­çš„è³‡æ–™
            const financials = data.financials || {};
            document.getElementById('currentBudget').textContent = `$${(financials.currentBudget || 0).toLocaleString()}`;
            document.getElementById('totalLoan').textContent = `$${(financials.totalLoan || 0).toLocaleString()}`;
            document.getElementById('fishAInventory').textContent = `${financials.fishAInventory || 0} kg`;
            document.getElementById('fishBInventory').textContent = `${financials.fishBInventory || 0} kg`;
            
            // æ­·å²è³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            const history = data.history || [];
            const latestHistory = history[history.length - 1] || {};
            document.getElementById('cumulativeProfit').textContent = `$${(latestHistory.cumulative_profit || 0).toLocaleString()}`;
            document.getElementById('roi').textContent = `${((latestHistory.roi || 0) * 100).toFixed(2)}%`;
            
            // é¡¯ç¤ºæœ€æ–°çµç®—è³‡è¨Šï¼ˆå¦‚æœæœ‰ï¼‰
            if (latestHistory && latestHistory.day_number) {
                updateSettlementInfo(latestHistory, data.todayBids || [], gameRules.unsoldFeePerKg || 10);
            }
            
            // æ›´æ–°å¸‚å ´è³‡è¨Š - ä½¿ç”¨ marketInfo ä¸­çš„è³‡æ–™
            const marketInfo = data.marketInfo || {};
            document.getElementById('fishASupply').textContent = marketInfo.fishASupply ? `${marketInfo.fishASupply.toLocaleString()} kg` : '- kg';
            document.getElementById('fishBSupply').textContent = marketInfo.fishBSupply ? `${marketInfo.fishBSupply.toLocaleString()} kg` : '- kg';
            document.getElementById('fishABudget').textContent = marketInfo.fishABudget ? `$${marketInfo.fishABudget.toLocaleString()}` : '$-';
            document.getElementById('fishBBudget').textContent = marketInfo.fishBBudget ? `$${marketInfo.fishBBudget.toLocaleString()}` : '$-';
            
            // æ›´æ–°éŠæˆ²è¦å‰‡è³‡è¨Š - ä½¿ç”¨ gameRules ä¸­çš„è³‡æ–™
            const gameRules = data.gameRules || {};
            const gameInfo = data.gameInfo || {};
            document.getElementById('initialBudget').textContent = gameRules.initialBudget ? `$${gameRules.initialBudget.toLocaleString()}` : '$-';
            document.getElementById('totalDays').textContent = gameInfo.totalDays ? `${gameInfo.totalDays} å¤©` : '- å¤©';
            document.getElementById('loanInterestRate').textContent = gameRules.loanInterestRate ? `${(gameRules.loanInterestRate * 100).toFixed(1)}%` : '-%';
            document.getElementById('unsoldFeePerKg').textContent = gameRules.unsoldFeePerKg ? `$${gameRules.unsoldFeePerKg}/kg` : '$-/kg';
            document.getElementById('targetPriceA').textContent = gameRules.targetPriceA ? `$${gameRules.targetPriceA}` : '$-';
            document.getElementById('targetPriceB').textContent = gameRules.targetPriceB ? `$${gameRules.targetPriceB}` : '$-';
            
            // æ›´æ–°éšæ®µæ©«å¹…
            const banner = document.getElementById('phaseBanner');
            banner.className = `phase-banner ${currentPhase}`;
            banner.textContent = getPhaseText(currentPhase);
            
            // æ›´æ–°å€’æ•¸
            if (data.countdown && data.countdown > 0) {
                startCountdown(data.countdown);
            }
        }
        
        // æ›´æ–°çµç®—è³‡è¨Šé¡¯ç¤º
        function updateSettlementInfo(settlementData, todayBids, unsoldFeePerKg) {
            const card = document.getElementById('settlementCard');
            if (!settlementData || !settlementData.day_number) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            // è¨ˆç®—è²·å…¥å’Œè³£å‡ºæ•¸é‡
            let fishABought = 0, fishBBought = 0;
            let fishASold = 0, fishBSold = 0;
            
            if (todayBids && todayBids.length > 0) {
                todayBids.forEach(bid => {
                    if (bid.bid_type === 'buy') {
                        if (bid.fish_type === 'A') {
                            fishABought += (bid.quantity_fulfilled || 0);
                        } else {
                            fishBBought += (bid.quantity_fulfilled || 0);
                        }
                    } else if (bid.bid_type === 'sell') {
                        if (bid.fish_type === 'A') {
                            fishASold += (bid.quantity_fulfilled || 0);
                        } else {
                            fishBSold += (bid.quantity_fulfilled || 0);
                        }
                    }
                });
            }
            
            // è¨ˆç®—æ»¯éŠ·æ•¸é‡
            const unsoldFishA = Math.max(0, fishABought - fishASold);
            const unsoldFishB = Math.max(0, fishBBought - fishBSold);
            const totalUnsold = unsoldFishA + unsoldFishB;
            const calculatedUnsoldFee = totalUnsold * unsoldFeePerKg;
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('settlementCost').textContent = `$${(settlementData.cost || 0).toLocaleString()}`;
            document.getElementById('settlementRevenue').textContent = `$${(settlementData.revenue || 0).toLocaleString()}`;
            document.getElementById('unsoldFishA').textContent = `${unsoldFishA} kg`;
            document.getElementById('unsoldFishB').textContent = `${unsoldFishB} kg`;
            document.getElementById('unsoldFee').textContent = `$${(settlementData.unsold_fee || calculatedUnsoldFee || 0).toLocaleString()}`;
            document.getElementById('interestFee').textContent = `$${(settlementData.interest_incurred || 0).toLocaleString()}`;
            
            // è¨ˆç®—ä¸¦é¡¯ç¤ºç•¶æ—¥æ·¨åˆ©
            const dailyProfit = settlementData.daily_profit || 0;
            const profitElement = document.getElementById('dailyProfit');
            profitElement.textContent = `$${dailyProfit.toLocaleString()}`;
            profitElement.style.color = dailyProfit >= 0 ? '#52c41a' : '#cf1322';
            
            // é¡¯ç¤ºçµç®—æ™‚é–“ï¼ˆç¬¬å¹¾å¤©ï¼‰
            document.getElementById('settlementTime').textContent = `ç¬¬ ${settlementData.day_number} å¤©`;
        }
        
        // æ›´æ–°éšæ®µæ§åˆ¶
        function updatePhaseControls(phase) {
            const buyTab = document.getElementById('buyTab');
            const sellTab = document.getElementById('sellTab');
            
            // Fix: Only disable inputs and submit buttons, not tab buttons
            const buyInputs = buyTab.querySelectorAll('input[type="number"], .submit-btn');
            const sellInputs = sellTab.querySelectorAll('input[type="number"], .submit-btn');
            
            buyInputs.forEach(input => {
                input.disabled = phase !== 'buying';
            });
            
            sellInputs.forEach(input => {
                input.disabled = phase !== 'selling';
            });
        }
        
        // åˆ‡æ›è²·å…¥/è³£å‡ºé¡å‹
        function switchBidType(type) {
            const tabs = document.querySelectorAll('.bidding-tabs .tab');
            tabs[0].classList.toggle('active', type === 'buy');
            tabs[1].classList.toggle('active', type === 'sell');
            document.getElementById('buyTab').classList.toggle('active', type === 'buy');
            document.getElementById('sellTab').classList.toggle('active', type === 'sell');
        }
        
        // åˆ‡æ›é­šé¡
        function switchFish(bidType, fishType) {
            const container = document.getElementById(`${bidType}Tab`);
            const tabs = container.querySelectorAll('.fish-tab');
            const contents = container.querySelectorAll('.fish-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.style.display = 'none');
            
            // å•Ÿå‹•å°æ‡‰çš„æ¨™ç±¤å’Œå…§å®¹
            const targetTab = Array.from(tabs).find(tab => tab.textContent.includes(fishType));
            if (targetTab) targetTab.classList.add('active');
            
            document.getElementById(`${bidType}Fish${fishType}`).style.display = 'block';
        }
        
        // åƒ¹æ ¼/æ•¸é‡æ•´æ•¸æª¢æŸ¥ï¼šæ­£æ•´æ•¸ï¼ˆè‡³å°‘ 1ï¼‰
        function isPosInt(v) { return /^\d+$/.test(String(v)); }
        
        // æäº¤æŠ•æ¨™
        async function submitBid(bidType, fishType) {
            if (!gameId || !currentDayId) {
                showMessage('ç„¡æ•ˆçš„éŠæˆ²ç‹€æ…‹', 'error');
                return;
            }
            
            // å–å¾—æŒ‰éˆ•ä¸¦æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨è™•ç†ä¸­
            const submitBtn = document.querySelector(`#${bidType}Fish${fishType} .submit-btn`);
            if (submitBtn.disabled) {
                return; // é˜²æ­¢é‡è¤‡é»æ“Š
            }
            
            // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡æäº¤
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            
            try {
            
            const priceGroup1Price = parseFloat(document.getElementById(`${bidType}${fishType}PriceGroup1Price`).value);
            const priceGroup1Qty = parseInt(document.getElementById(`${bidType}${fishType}PriceGroup1Qty`).value);
            const priceGroup2Price = parseFloat(document.getElementById(`${bidType}${fishType}PriceGroup2Price`).value);
            const priceGroup2Qty = parseInt(document.getElementById(`${bidType}${fishType}PriceGroup2Qty`).value);
            
            const bids = [];
            
            // æ”¶é›†æœ‰æ•ˆçš„æŠ•æ¨™
            if (priceGroup1Price > 0 && priceGroup1Qty > 0) {
                // åŠ å…¥æ•´æ•¸æª¢æŸ¥
                if (!isPosInt(document.getElementById(`${bidType}${fishType}PriceGroup1Price`).value) || 
                    !isPosInt(document.getElementById(`${bidType}${fishType}PriceGroup1Qty`).value)) {
                    showMessage('åƒ¹æ ¼èˆ‡æ•¸é‡å¿…é ˆç‚ºæ­£æ•´æ•¸', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = `æäº¤${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}`;
                    return;
                }
                bids.push({
                    fishType: fishType,
                    price: priceGroup1Price,
                    quantity: priceGroup1Qty
                });
            }
            
            if (priceGroup2Price > 0 && priceGroup2Qty > 0) {
                // åŠ å…¥æ•´æ•¸æª¢æŸ¥
                if (!isPosInt(document.getElementById(`${bidType}${fishType}PriceGroup2Price`).value) || 
                    !isPosInt(document.getElementById(`${bidType}${fishType}PriceGroup2Qty`).value)) {
                    showMessage('åƒ¹æ ¼èˆ‡æ•¸é‡å¿…é ˆç‚ºæ­£æ•´æ•¸', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = `æäº¤${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}`;
                    return;
                }
                bids.push({
                    fishType: fishType,
                    price: priceGroup2Price,
                    quantity: priceGroup2Qty
                });
            }
            
            if (bids.length === 0) {
                showMessage('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹æœ‰æ•ˆçš„åƒ¹ä½', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = `æäº¤${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}`;
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦è¶…éå…©å€‹ä¸åŒåƒ¹ä½ï¼ˆåŒ…å«å·²é€å‡ºçš„åƒ¹ä½ï¼‰
            const pricesNow = bids.map(b => b.price);  // Fix: use 'price' not 'price_per_unit'
            const oldPrices = usedPrices[bidType][fishType] || [];
            const merged = new Set([...oldPrices, ...pricesNow]);  // Already correct syntax
            if (merged.size > 2) {
                showMessage('æ¯é­šç¨®ã€Œå…¨æ—¥ã€æœ€å¤šå…©å€‹ä¸åŒåƒ¹æ ¼ï¼ˆå«å·²é€å‡ºçš„ï¼‰', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = `æäº¤${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}`;
                return;
            }
            
            // é©—è­‰è³‡é‡‘å’Œåº«å­˜ - ä½¿ç”¨æ­£ç¢ºçš„è³‡æ–™çµæ§‹
            if (bidType === 'buy') {
                const totalCost = bids.reduce((sum, bid) => sum + bid.price * bid.quantity, 0);
                const financials = teamData?.financials || {};
                const availableFunds = financials.currentBudget || 0; // æš«æ™‚ç°¡åŒ–ï¼Œå¯èƒ½éœ€è¦åŠ å…¥è²¸æ¬¾é¡åº¦
                if (totalCost > availableFunds) {
                    showMessage('è³‡é‡‘ä¸è¶³ï¼Œè¶…éå¯ç”¨é¡åº¦', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = `æäº¤${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}`;
                    return;
                }
            } else {
                const totalQty = bids.reduce((sum, bid) => sum + bid.quantity, 0);
                const financials = teamData?.financials || {};
                const inventory = fishType === 'A' ? (financials.fishAInventory || 0) : (financials.fishBInventory || 0);
                if (totalQty > inventory) {
                    showMessage('åº«å­˜ä¸è¶³', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = `æäº¤${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}`;
                    return;
                }
            }
            
            // æäº¤æ‰€æœ‰æŠ•æ¨™ï¼ˆä½¿ç”¨æ­£ç¢ºçš„ APIï¼‰
            try {
                const isBuying = bidType === 'buy';
                const endpoint = isBuying ? '/team/submit-buy-bids' : '/team/submit-sell-bids';
                const bidData = isBuying ? { buyBids: bids } : { sellBids: bids };
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(bidData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error?.message || result.error || 'æŠ•æ¨™å¤±æ•—');
                }
                
                showMessage(`${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}æŠ•æ¨™æäº¤æˆåŠŸï¼`, 'success');
                
                // æ¸…ç©ºè¼¸å…¥
                document.getElementById(`${bidType}${fishType}PriceGroup1Price`).value = '';
                document.getElementById(`${bidType}${fishType}PriceGroup1Qty`).value = '';
                document.getElementById(`${bidType}${fishType}PriceGroup2Price`).value = '';
                document.getElementById(`${bidType}${fishType}PriceGroup2Qty`).value = '';
                
                // é‡æ–°è¼‰å…¥è³‡æ–™
                loadTeamSummary();
                loadOrderbook();
                loadUsedPrices();
                
            } catch (error) {
                showMessage(`æŠ•æ¨™éŒ¯èª¤: ${error.message}`, 'error');
            } finally {
                // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
                submitBtn.disabled = false;
                submitBtn.textContent = `æäº¤${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}`;
            }
            
            } catch (error) {
                // è™•ç†æœ€å¤–å±¤çš„éŒ¯èª¤
                console.error('Submit bid error:', error);
                showMessage('æäº¤æŠ•æ¨™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                // ç¢ºä¿æŒ‰éˆ•è¢«é‡æ–°å•Ÿç”¨
                const submitBtn = document.querySelector(`#${bidType}Fish${fishType} .submit-btn`);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = `æäº¤${fishType}é­š${bidType === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}`;
                }
            }
        }
        
        // è¼‰å…¥å·²ä½¿ç”¨åƒ¹ä½
        async function loadUsedPrices() {
            if (!gameId || !currentDayId) return;
            
            try {
                // å¾ dashboard ç²å–å·²ä½¿ç”¨åƒ¹ä½è³‡è¨Š
                const response = await fetch(`${API_BASE}/team/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.todayBids) {
                    // è™•ç†å·²ä½¿ç”¨çš„åƒ¹ä½
                    usedPrices = { buy: { A: [], B: [] }, sell: { A: [], B: [] } };
                    
                    data.todayBids.forEach(bid => {
                        const bidType = bid.bid_type === 'buy' ? 'buy' : 'sell';
                        const fishType = bid.fish_type;
                        if (!usedPrices[bidType][fishType].includes(bid.price)) {
                            usedPrices[bidType][fishType].push(bid.price);
                        }
                    });
                    
                    // æ›´æ–°é¡¯ç¤º
                    updateUsedPricesDisplay();
                }
            } catch (error) {
                console.error('è¼‰å…¥å·²ä½¿ç”¨åƒ¹ä½éŒ¯èª¤:', error);
            }
        }
        
        // æ›´æ–°å·²ä½¿ç”¨åƒ¹ä½é¡¯ç¤º
        function updateUsedPricesDisplay() {
            ['buy', 'sell'].forEach(bidType => {
                ['A', 'B'].forEach(fishType => {
                    const prices = usedPrices[bidType][fishType];
                    const element = document.getElementById(`${bidType}${fishType}UsedPrices`);
                    if (element) {
                        element.textContent = `å·²ä½¿ç”¨åƒ¹ä½: ${prices.length > 0 ? prices.map(p => `$${p}`).join(', ') : 'ç„¡'}`;
                    }
                });
            });
        }
        
        // è¼‰å…¥è¨‚å–®ç°¿
        async function loadOrderbook() {
            if (!gameId || !currentDayId) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/games/${gameId}/current-bids`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateOrderbook(data);
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨‚å–®ç°¿éŒ¯èª¤:', error);
            }
        }
        
        // æ›´æ–°è¨‚å–®ç°¿é¡¯ç¤º
        function updateOrderbook(data) {
            const orderbookA = document.getElementById('orderbookA');
            const orderbookB = document.getElementById('orderbookB');
            
            orderbookA.innerHTML = '';
            orderbookB.innerHTML = '';
            
            // åˆ†é›¢Aé­šå’ŒBé­šçš„è²·è³£è¨‚å–®
            const fishA_orders = [];
            const fishB_orders = [];
            
            // è™•ç†è²·å…¥è¨‚å–®
            if (data.buyBids) {
                data.buyBids.forEach(bid => {
                    const order = {
                        price: bid.price,
                        quantity: bid.quantity_submitted,
                        type: 'buy'
                    };
                    if (bid.fish_type === 'A') {
                        fishA_orders.push(order);
                    } else if (bid.fish_type === 'B') {
                        fishB_orders.push(order);
                    }
                });
            }
            
            // è™•ç†è³£å‡ºè¨‚å–®
            if (data.sellBids) {
                data.sellBids.forEach(bid => {
                    const order = {
                        price: bid.price,
                        quantity: bid.quantity_submitted,
                        type: 'sell'
                    };
                    if (bid.fish_type === 'A') {
                        fishA_orders.push(order);
                    } else if (bid.fish_type === 'B') {
                        fishB_orders.push(order);
                    }
                });
            }
            
            // æ’åºï¼šè²·å–®æŒ‰åƒ¹æ ¼é™åºï¼Œè³£å–®æŒ‰åƒ¹æ ¼å‡åº
            fishA_orders.sort((a, b) => {
                if (a.type === b.type) {
                    return a.type === 'buy' ? b.price - a.price : a.price - b.price;
                }
                return a.type === 'buy' ? -1 : 1;
            });
            
            fishB_orders.sort((a, b) => {
                if (a.type === b.type) {
                    return a.type === 'buy' ? b.price - a.price : a.price - b.price;
                }
                return a.type === 'buy' ? -1 : 1;
            });
            
            // é¡¯ç¤ºAé­šè¨‚å–®
            fishA_orders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>$${order.price}</td>
                    <td>${order.quantity} kg</td>
                    <td style="color: ${order.type === 'buy' ? '#52c41a' : '#f5222d'}">${order.type === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}</td>
                `;
                orderbookA.appendChild(row);
            });
            
            // é¡¯ç¤ºBé­šè¨‚å–®
            fishB_orders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>$${order.price}</td>
                    <td>${order.quantity} kg</td>
                    <td style="color: ${order.type === 'buy' ? '#52c41a' : '#f5222d'}">${order.type === 'buy' ? 'è²·å…¥' : 'è³£å‡º'}</td>
                `;
                orderbookB.appendChild(row);
            });
            
            // å¦‚æœæ²’æœ‰è¨‚å–®ï¼Œé¡¯ç¤ºæç¤º
            if (fishA_orders.length === 0) {
                orderbookA.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">æš«ç„¡è¨‚å–®</td></tr>';
            }
            if (fishB_orders.length === 0) {
                orderbookB.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">æš«ç„¡è¨‚å–®</td></tr>';
            }
        }
        
        // è¼‰å…¥æ’è¡Œæ¦œ
        async function loadLeaderboard() {
            if (!gameId) return;
            
            try {
                const response = await fetch(`${API_BASE}/leaderboard/${gameId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    updateLeaderboard(data);
                }
            } catch (error) {
                console.error('è¼‰å…¥æ’è¡Œæ¦œéŒ¯èª¤:', error);
            }
        }
        
        // æ›´æ–°æ’è¡Œæ¦œé¡¯ç¤º
        function updateLeaderboard(data) {
            const tbody = document.getElementById('leaderboard');
            tbody.innerHTML = '';
            
            if (data && data.length > 0) {
                // åªé¡¯ç¤ºå‰10å
                const top10 = data.slice(0, 10);
                top10.forEach((team, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${team.team_name || team.username}</td>
                        <td>${(team.roi * 100).toFixed(2)}%</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        // å–å¾—éšæ®µæ–‡å­—
        function getPhaseText(phase) {
            const phaseTexts = {
                'waiting': 'ç­‰å¾…é–‹å§‹',
                'buying': 'è²·å…¥éšæ®µ',
                'selling': 'è³£å‡ºéšæ®µ',
                'settling': 'çµç®—ä¸­',
                'day_ended': 'ç•¶æ—¥çµæŸ'
            };
            return phaseTexts[phase] || phase;
        }
        
        // å€’æ•¸è¨ˆæ™‚
        function startCountdown(seconds) {
            if (window.countdownTimer) {
                clearInterval(window.countdownTimer);
            }
            
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.style.display = 'block';
            
            let remaining = seconds;
            
            const updateTimer = () => {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                if (remaining <= 0) {
                    clearInterval(window.countdownTimer);
                    timerDisplay.style.display = 'none';
                    return;
                }
                remaining--;
            };
            
            updateTimer();
            window.countdownTimer = setInterval(updateTimer, 1000);
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const alertClass = type === 'success' ? 'alert success' : type === 'info' ? 'alert info' : 'alert';
            
            messageArea.innerHTML = `<div class="${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }
        
        // ç™»å‡º
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            localStorage.removeItem('game_id');
            window.location.href = 'login.html';
        }
        
        // å®šæœŸæ›´æ–°
        setInterval(() => {
            loadTeamSummary();
            loadOrderbook();
        }, 3000);
        
        // å®šæœŸæ›´æ–°æ’è¡Œæ¦œï¼ˆé »ç‡è¼ƒä½ï¼‰
        setInterval(loadLeaderboard, 10000);
        
        // é–‹å•ŸéŠæˆ²èªªæ˜
        function openGameInstructions() {
            window.open('game-instructions.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        // ===== NEW FUNCTIONS FOR PHASE 4 UPGRADE =====
        
        // åˆå§‹åŒ–å³æ™‚æ›´æ–°ç³»çµ±
        function initializeRealtimeUpdates() {
            // å•Ÿå‹•éŠæˆ²ç‹€æ…‹è¼ªè©¢ (æ¯5ç§’)
            gameStatusInterval = setInterval(updateGameStatus, 5000);
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            updateGameStatus();
        }

        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        async function updateGameStatus() {
            try {
                const response = await fetch('/api/game/status');
                const gameStatus = await response.json();
                
                if (gameStatus.gameActive) {
                    // æ›´æ–°éŠæˆ²è³‡è¨Šé¡¯ç¤º
                    document.getElementById('gameName').textContent = gameStatus.gameName || 'æœªçŸ¥éŠæˆ²';
                    document.getElementById('dayNumber').textContent = gameStatus.dayNumber || '-';
                    
                    // æ›´æ–°éšæ®µæ©«å¹…
                    updatePhaseBanner(gameStatus.phase);
                    
                    // è™•ç†å€’æ•¸è¨ˆæ™‚å™¨
                    if (gameStatus.endTime && gameStatus.endTime !== currentEndTime) {
                        // æ–°çš„æŠ•æ¨™éšæ®µé–‹å§‹ï¼Œå•Ÿå‹•å€’æ•¸è¨ˆæ™‚å™¨
                        currentEndTime = gameStatus.endTime;
                        startCountdownTimer(gameStatus.endTime);
                    } else if (!gameStatus.endTime && currentEndTime) {
                        // æŠ•æ¨™éšæ®µçµæŸï¼Œæ¸…é™¤å€’æ•¸è¨ˆæ™‚å™¨
                        currentEndTime = null;
                        clearCountdownTimer();
                    } else if (!gameStatus.endTime && (gameStatus.phase === 'buying' || gameStatus.phase === 'selling')) {
                        // é€²è¡Œä¸­ä½†æ²’æœ‰endTimeï¼Œéš±è—è¨ˆæ™‚å™¨ä½†ä¿æŒç‹€æ…‹é¡¯ç¤º
                        document.getElementById('timerDisplay').style.display = 'none';
                    }
                    
                    // æ›´æ–°æ­·å²æŠ•æ¨™ç´€éŒ„çš„å¤©æ•¸é¸é …
                    updateBidHistoryDayOptions(gameStatus.dayNumber);
                    
                    // æ›´æ–°å…¨åŸŸè®Šæ•¸ä»¥ä¿æŒç›¸å®¹æ€§
                    gameId = gameStatus.gameId;
                    currentPhase = gameStatus.phase;
                    
                } else {
                    // æ²’æœ‰é€²è¡Œä¸­çš„éŠæˆ²
                    document.getElementById('gameName').textContent = 'ç„¡é€²è¡Œä¸­éŠæˆ²';
                    document.getElementById('dayNumber').textContent = '-';
                    updatePhaseBanner('waiting');
                    clearCountdownTimer();
                }
            } catch (error) {
                console.error('æ›´æ–°éŠæˆ²ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // æ›´æ–°éšæ®µæ©«å¹…
        function updatePhaseBanner(phase) {
            const banner = document.getElementById('phaseBanner');
            banner.className = 'phase-banner'; // é‡ç½® class
            
            switch (phase) {
                case 'buying':
                    banner.textContent = 'ğŸ“ˆ è²·å…¥æŠ•æ¨™é€²è¡Œä¸­';
                    banner.classList.add('buying');
                    break;
                case 'selling':
                    banner.textContent = 'ğŸ“‰ è³£å‡ºæŠ•æ¨™é€²è¡Œä¸­';
                    banner.classList.add('selling');
                    break;
                case 'buy_ended':
                    banner.textContent = 'â³ è²·å…¥æŠ•æ¨™å·²çµæŸï¼Œç­‰å¾…è³£å‡ºæŠ•æ¨™';
                    break;
                case 'sell_ended':
                    banner.textContent = 'â³ è³£å‡ºæŠ•æ¨™å·²çµæŸï¼Œç­‰å¾…çµç®—';
                    break;
                case 'settled':
                    banner.textContent = 'âœ… ç•¶æ—¥å·²çµç®—å®Œæˆ';
                    banner.classList.add('settling');
                    break;
                default:
                    banner.textContent = 'â¸ï¸ ç­‰å¾…é–‹å§‹';
            }
        }

        // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚å™¨ (æš«æ™‚ç°¡åŒ–ç‰ˆæœ¬)
        function startCountdownTimer(endTime) {
            clearCountdownTimer(); // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
            
            if (!endTime) {
                return; // å¦‚æœæ²’æœ‰çµæŸæ™‚é–“ï¼Œä¸é¡¯ç¤ºå€’æ•¸
            }
            
            const endTimestamp = new Date(endTime).getTime();
            const timerDisplay = document.getElementById('timerDisplay');
            
            timerDisplay.style.display = 'block';
            
            const updateCountdown = () => {
                const now = new Date().getTime();
                const remaining = endTimestamp - now;
                
                if (remaining <= 0) {
                    timerDisplay.textContent = '00:00';
                    timerDisplay.style.display = 'none';
                    clearCountdownTimer();
                    return;
                }
                
                const minutes = Math.floor(remaining / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };
            
            updateCountdown(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // æ¸…é™¤å€’æ•¸è¨ˆæ™‚å™¨
        function clearCountdownTimer() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            document.getElementById('timerDisplay').style.display = 'none';
        }

        // æ›´æ–°æ­·å²æŠ•æ¨™ç´€éŒ„çš„å¤©æ•¸é¸é …
        function updateBidHistoryDayOptions(maxDay) {
            const daySelect = document.getElementById('bidHistoryDay');
            const currentValue = daySelect.value;

            daySelect.innerHTML = '<option value="">è«‹é¸æ“‡å¤©æ•¸</option>';

            for (let i = 1; i <= maxDay; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `ç¬¬ ${i} å¤©`;
                // å¦‚æœå·²æœ‰é¸æ“‡å€¼ï¼Œä¿ç•™è©²å€¼ï¼›å¦å‰‡è‡ªå‹•é¸æ“‡ç•¶å‰æœ€æ–°å¤©æ•¸
                if (currentValue) {
                    if (i.toString() === currentValue) {
                        option.selected = true;
                    }
                } else if (i === maxDay) {
                    // é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œè‡ªå‹•é¸æ“‡æœ€æ–°çš„å¤©æ•¸
                    option.selected = true;
                }
                daySelect.appendChild(option);
            }
        }

        // è¼‰å…¥æŠ•æ¨™æ­·å²
        async function loadBidHistory() {
            const day = document.getElementById('bidHistoryDay').value;
            const type = document.getElementById('bidHistoryType').value;
            const contentDiv = document.getElementById('bidHistoryContent');
            
            if (!day) {
                contentDiv.innerHTML = '<div style="text-align: center; color: #cf1322; padding: 20px;">è«‹å…ˆé¸æ“‡å¤©æ•¸</div>';
                return;
            }
            
            contentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">è¼‰å…¥ä¸­...</div>';
            
            try {
                const response = await fetch('/api/game/bid-history');
                const data = await response.json();
                
                if (data.success) {
                    // ç¯©é¸æŒ‡å®šå¤©æ•¸å’Œé¡å‹çš„è³‡æ–™
                    const filteredData = data.history.filter(item => 
                        item.dayNumber.toString() === day && item.bidType === type
                    );
                    
                    if (filteredData.length === 0) {
                        contentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">è©²å¤©æ•¸æš«ç„¡æŠ•æ¨™ç´€éŒ„</div>';
                        return;
                    }
                    
                    // é¡¯ç¤ºçµæœ
                    displayBidHistory(filteredData[0], day, type);
                } else {
                    contentDiv.innerHTML = `<div style="text-align: center; color: #cf1322; padding: 20px;">${data.message}</div>`;
                }
            } catch (error) {
                console.error('è¼‰å…¥æŠ•æ¨™æ­·å²å¤±æ•—:', error);
                contentDiv.innerHTML = '<div style="text-align: center; color: #cf1322; padding: 20px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            }
        }

        // è¼‰å…¥å®Œæ•´æŠ•æ¨™çµ±è¨ˆ
        async function loadCompleteBidSummary() {
            const day = document.getElementById('bidHistoryDay').value;
            const contentDiv = document.getElementById('bidHistoryContent');
            
            if (!day) {
                contentDiv.innerHTML = '<div style="text-align: center; color: #cf1322; padding: 20px;">è«‹å…ˆé¸æ“‡å¤©æ•¸</div>';
                return;
            }
            
            if (!gameId) {
                contentDiv.innerHTML = '<div style="text-align: center; color: #cf1322; padding: 20px;">éŠæˆ²å°šæœªé–‹å§‹</div>';
                return;
            }
            
            contentDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">è¼‰å…¥å®Œæ•´çµ±è¨ˆä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/admin/games/${gameId}/day/${day}/bid-summary`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayCompleteBidSummary(data, day);
                } else {
                    contentDiv.innerHTML = `<div style="text-align: center; color: #cf1322; padding: 20px;">${data.error || 'è¼‰å…¥å¤±æ•—'}</div>`;
                }
            } catch (error) {
                console.error('è¼‰å…¥å®Œæ•´çµ±è¨ˆå¤±æ•—:', error);
                contentDiv.innerHTML = '<div style="text-align: center; color: #cf1322; padding: 20px;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            }
        }
        
        // é¡¯ç¤ºå®Œæ•´æŠ•æ¨™çµ±è¨ˆ
        function displayCompleteBidSummary(data, day) {
            const contentDiv = document.getElementById('bidHistoryContent');
            
            // å»ºç«‹çµ±è¨ˆæ‘˜è¦
            let html = `
                <h4>ç¬¬ ${day} å¤© - å®Œæ•´ç«¶æ¨™çµæœçµ±è¨ˆ</h4>
                
                <!-- å¸‚å ´è³‡è¨Š -->
                <div style="background: #f0f2f5; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h5>ğŸ“Š å¸‚å ´è³‡è¨Š</h5>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <div style="color: #666; font-size: 12px;">Aé­šä¾›çµ¦é‡</div>
                            <div style="font-size: 18px; font-weight: bold;">${data.dayInfo?.supply?.fishA || 0} kg</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 12px;">Bé­šä¾›çµ¦é‡</div>
                            <div style="font-size: 18px; font-weight: bold;">${data.dayInfo?.supply?.fishB || 0} kg</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 12px;">Aé­šé¤å»³é ç®—</div>
                            <div style="font-size: 18px; font-weight: bold;">$${(data.dayInfo?.budget?.fishA || 0).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 12px;">Bé­šé¤å»³é ç®—</div>
                            <div style="font-size: 18px; font-weight: bold;">$${(data.dayInfo?.budget?.fishB || 0).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
                
                <!-- è²·å…¥çµ±è¨ˆ -->
                <div style="margin-bottom: 30px;">
                    <h5>ğŸ“ˆ è²·å…¥æŠ•æ¨™çµ±è¨ˆ</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Aé­šè²·å…¥çµ±è¨ˆ -->
                        <div style="border: 1px solid #d9d9d9; border-radius: 5px; padding: 15px;">
                            <h6 style="color: #1890ff;">Aé­šè²·å…¥</h6>
                            ${formatBidStats(data.statistics?.buy?.fishA)}
                        </div>
                        <!-- Bé­šè²·å…¥çµ±è¨ˆ -->
                        <div style="border: 1px solid #d9d9d9; border-radius: 5px; padding: 15px;">
                            <h6 style="color: #52c41a;">Bé­šè²·å…¥</h6>
                            ${formatBidStats(data.statistics?.buy?.fishB)}
                        </div>
                    </div>
                </div>
                
                <!-- è³£å‡ºçµ±è¨ˆ -->
                <div style="margin-bottom: 30px;">
                    <h5>ğŸ“‰ è³£å‡ºæŠ•æ¨™çµ±è¨ˆ</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Aé­šè³£å‡ºçµ±è¨ˆ -->
                        <div style="border: 1px solid #d9d9d9; border-radius: 5px; padding: 15px;">
                            <h6 style="color: #1890ff;">Aé­šè³£å‡º</h6>
                            ${formatBidStats(data.statistics?.sell?.fishA)}
                        </div>
                        <!-- Bé­šè³£å‡ºçµ±è¨ˆ -->
                        <div style="border: 1px solid #d9d9d9; border-radius: 5px; padding: 15px;">
                            <h6 style="color: #52c41a;">Bé­šè³£å‡º</h6>
                            ${formatBidStats(data.statistics?.sell?.fishB)}
                        </div>
                    </div>
                </div>
                
                <!-- æ‰€æœ‰æŠ•æ¨™æ˜ç´° -->
                <div style="margin-bottom: 30px;">
                    <h5>ğŸ“‹ æ‰€æœ‰æŠ•æ¨™æ˜ç´°</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- è²·å…¥æŠ•æ¨™æ˜ç´° -->
                        <div>
                            <h6>è²·å…¥æŠ•æ¨™</h6>
                            ${formatBidDetails(data.bidDetails?.buy)}
                        </div>
                        <!-- è³£å‡ºæŠ•æ¨™æ˜ç´° -->
                        <div>
                            <h6>è³£å‡ºæŠ•æ¨™</h6>
                            ${formatBidDetails(data.bidDetails?.sell)}
                        </div>
                    </div>
                </div>
                
                <!-- åœ˜éšŠæˆäº¤ç´°ç¯€ -->
                ${data.dailyResults && data.dailyResults.length > 0 ? `
                <div style="margin-bottom: 30px;">
                    <h5>ğŸ‘¥ åœ˜éšŠæˆäº¤ç´°ç¯€</h5>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>åœ˜éšŠ</th>
                                <th>æ”¶å…¥</th>
                                <th>æˆæœ¬</th>
                                <th>æ»¯éŠ·è²»</th>
                                <th>åˆ©æ¯</th>
                                <th>æ·¨åˆ©</th>
                                <th>ç´¯ç©æ”¶ç›Š</th>
                                <th>ROI</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.dailyResults.map(team => `
                                <tr>
                                    <td>${team.team_name || team.username}</td>
                                    <td style="color: #52c41a;">$${(team.revenue || 0).toLocaleString()}</td>
                                    <td style="color: #cf1322;">$${(team.cost || 0).toLocaleString()}</td>
                                    <td style="color: #cf1322;">$${(team.unsold_fee || 0).toLocaleString()}</td>
                                    <td style="color: #cf1322;">$${(team.interest_incurred || 0).toLocaleString()}</td>
                                    <td style="color: ${team.daily_profit >= 0 ? '#52c41a' : '#cf1322'};">
                                        $${(team.daily_profit || 0).toLocaleString()}
                                    </td>
                                    <td>$${(team.cumulative_profit || 0).toLocaleString()}</td>
                                    <td style="font-weight: bold;">${((team.roi || 0) * 100).toFixed(2)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
            `;
            
            contentDiv.innerHTML = html;
        }
        
        // æ ¼å¼åŒ–æŠ•æ¨™çµ±è¨ˆ
        function formatBidStats(stats) {
            if (!stats) return '<div style="color: #999;">ç„¡è³‡æ–™</div>';
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                    <div>
                        <span style="color: #666;">ç¸½æŠ•æ¨™æ•¸ï¼š</span>
                        <strong>${stats.totalBids || 0}</strong>
                    </div>
                    <div>
                        <span style="color: #666;">æˆäº¤ç‡ï¼š</span>
                        <strong>${stats.fulfillmentRate || '0.00'}%</strong>
                    </div>
                    <div>
                        <span style="color: #666;">æäº¤ç¸½é‡ï¼š</span>
                        <strong>${stats.totalQuantitySubmitted || 0} kg</strong>
                    </div>
                    <div>
                        <span style="color: #666;">æˆäº¤ç¸½é‡ï¼š</span>
                        <strong>${stats.totalQuantityFulfilled || 0} kg</strong>
                    </div>
                    <div>
                        <span style="color: #666;">æœ€é«˜åƒ¹ï¼š</span>
                        <strong>$${stats.maxPrice || 0}</strong>
                    </div>
                    <div>
                        <span style="color: #666;">æœ€ä½åƒ¹ï¼š</span>
                        <strong>$${stats.minPrice || 0}</strong>
                    </div>
                    <div>
                        <span style="color: #666;">å¹³å‡åƒ¹ï¼š</span>
                        <strong>$${stats.avgPrice || 0}</strong>
                    </div>
                    <div>
                        <span style="color: #666;">åŠ æ¬Šå¹³å‡åƒ¹ï¼š</span>
                        <strong>$${stats.weightedAvgPrice || 0}</strong>
                    </div>
                </div>
            `;
        }
        
        // æ ¼å¼åŒ–æŠ•æ¨™æ˜ç´°
        function formatBidDetails(bids) {
            if (!bids) return '<div style="color: #999;">ç„¡æŠ•æ¨™</div>';
            
            const fishA = bids.fishA || [];
            const fishB = bids.fishB || [];
            
            let html = '';
            
            if (fishA.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #1890ff;">Aé­š</strong>
                        <table class="table" style="margin-top: 5px;">
                            <thead>
                                <tr>
                                    <th>åƒ¹æ ¼</th>
                                    <th>æäº¤é‡</th>
                                    <th>æˆäº¤é‡</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${fishA.slice(0, 5).map(bid => `
                                    <tr>
                                        <td>$${bid.price}</td>
                                        <td>${bid.quantity_submitted} kg</td>
                                        <td>${bid.quantity_fulfilled || 0} kg</td>
                                        <td>${getStatusBadge(bid.status)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${fishA.length > 5 ? `<div style="text-align: center; color: #666; font-size: 12px;">...é‚„æœ‰ ${fishA.length - 5} ç­†</div>` : ''}
                    </div>
                `;
            }
            
            if (fishB.length > 0) {
                html += `
                    <div>
                        <strong style="color: #52c41a;">Bé­š</strong>
                        <table class="table" style="margin-top: 5px;">
                            <thead>
                                <tr>
                                    <th>åƒ¹æ ¼</th>
                                    <th>æäº¤é‡</th>
                                    <th>æˆäº¤é‡</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${fishB.slice(0, 5).map(bid => `
                                    <tr>
                                        <td>$${bid.price}</td>
                                        <td>${bid.quantity_submitted} kg</td>
                                        <td>${bid.quantity_fulfilled || 0} kg</td>
                                        <td>${getStatusBadge(bid.status)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${fishB.length > 5 ? `<div style="text-align: center; color: #666; font-size: 12px;">...é‚„æœ‰ ${fishB.length - 5} ç­†</div>` : ''}
                    </div>
                `;
            }
            
            return html || '<div style="color: #999;">ç„¡æŠ•æ¨™</div>';
        }
        
        // å–å¾—ç‹€æ…‹æ¨™ç±¤
        function getStatusBadge(status) {
            const badges = {
                'fulfilled': '<span style="color: #52c41a;">âœ“ å®Œå…¨æˆäº¤</span>',
                'partial': '<span style="color: #faad14;">âš  éƒ¨åˆ†æˆäº¤</span>',
                'failed': '<span style="color: #cf1322;">âœ— æœªæˆäº¤</span>',
                'pending': '<span style="color: #666;">â³ å¾…è™•ç†</span>'
            };
            return badges[status] || status;
        }
        
        // é¡¯ç¤ºæŠ•æ¨™æ­·å²
        function displayBidHistory(data, day, type) {
            const contentDiv = document.getElementById('bidHistoryContent');
            const typeText = type === 'buy' ? 'è²·å…¥' : 'è³£å‡º';
            
            // æŒ‰é­šç¨®å’Œåƒ¹æ ¼åˆ†çµ„
            const fishA = data.bids.filter(bid => bid.fishType === 'A').sort((a, b) => b.price - a.price);
            const fishB = data.bids.filter(bid => bid.fishType === 'B').sort((a, b) => b.price - a.price);
            
            let html = `
                <h4>ç¬¬ ${day} å¤© - ${typeText}æŠ•æ¨™çµæœ</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5>Aé­š</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åƒ¹æ ¼</th>
                                    <th>æäº¤æ•¸é‡</th>
                                    <th>æˆäº¤æ•¸é‡</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (fishA.length === 0) {
                html += '<tr><td colspan="4" style="text-align: center; color: #666;">ç„¡æŠ•æ¨™ç´€éŒ„</td></tr>';
            } else {
                fishA.forEach(bid => {
                    const statusText = bid.successful ? 'æˆäº¤' : 'æœªæˆäº¤';
                    const statusColor = bid.successful ? '#52c41a' : '#cf1322';
                    html += `
                        <tr>
                            <td>$${bid.price}</td>
                            <td>${bid.quantity} kg</td>
                            <td>${bid.fulfilled || 0} kg</td>
                            <td style="color: ${statusColor}">${statusText}</td>
                        </tr>
                    `;
                });
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h5>Bé­š</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åƒ¹æ ¼</th>
                                    <th>æäº¤æ•¸é‡</th>
                                    <th>æˆäº¤æ•¸é‡</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (fishB.length === 0) {
                html += '<tr><td colspan="4" style="text-align: center; color: #666;">ç„¡æŠ•æ¨™ç´€éŒ„</td></tr>';
            } else {
                fishB.forEach(bid => {
                    const statusText = bid.successful ? 'æˆäº¤' : 'æœªæˆäº¤';
                    const statusColor = bid.successful ? '#52c41a' : '#cf1322';
                    html += `
                        <tr>
                            <td>$${bid.price}</td>
                            <td>${bid.quantity} kg</td>
                            <td>${bid.fulfilled || 0} kg</td>
                            <td style="color: ${statusColor}">${statusText}</td>
                        </tr>
                    `;
                });
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        }

        // æ¸…ç†å‡½æ•¸ (åœ¨é é¢å¸è¼‰æ™‚èª¿ç”¨)
        window.addEventListener('beforeunload', function() {
            if (gameStatusInterval) {
                clearInterval(gameStatusInterval);
            }
            clearCountdownTimer();
        });

        // ===== è¨­å®šåŠŸèƒ½ =====

        // é–‹å•Ÿè¨­å®šå°è©±æ¡†
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const teamNameInput = document.getElementById('teamNameInput');
            const newPasswordInput = document.getElementById('newPasswordInput');

            // è¼‰å…¥ç•¶å‰å°çµ„åç¨±
            teamNameInput.value = teamData ? (teamData.team_name || '') : '';
            newPasswordInput.value = '';

            modal.style.display = 'flex';
        }

        // é—œé–‰è¨­å®šå°è©±æ¡†
        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'none';
        }

        // å„²å­˜è¨­å®š
        async function saveSettings() {
            const teamName = document.getElementById('teamNameInput').value.trim();
            const newPassword = document.getElementById('newPasswordInput').value.trim();

            // æª¢æŸ¥æ˜¯å¦æœ‰è¦æ›´æ–°çš„è³‡æ–™
            if (!teamName && !newPassword) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€é …è¦æ›´æ–°çš„è³‡æ–™');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/users/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        teamName: teamName || null,
                        newPassword: newPassword || null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'æ›´æ–°è¨­å®šå¤±æ•—');
                }

                alert('è¨­å®šæ›´æ–°æˆåŠŸ!');

                // æ›´æ–°æœ¬åœ°çš„ teamData
                if (teamData) {
                    teamData.team_name = data.user.team_name;
                }

                // æ›´æ–°é é¢é¡¯ç¤ºçš„å°çµ„åç¨±
                updateTeamDisplay();

                // é—œé–‰å°è©±æ¡†
                closeSettings();

            } catch (error) {
                console.error('æ›´æ–°è¨­å®šéŒ¯èª¤:', error);
                alert('æ›´æ–°è¨­å®šå¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°é é¢ä¸Šçš„å°çµ„åç¨±é¡¯ç¤º
        function updateTeamDisplay() {
            const teamElement = document.getElementById('currentTeam');
            if (teamData) {
                const displayName = teamData.team_name || teamData.username;
                teamElement.textContent = `å°çµ„: ${displayName}`;
            }
        }

        // ===== END OF PHASE 4 NEW FUNCTIONS =====
    </script>
</body>
</html>