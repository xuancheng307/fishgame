<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é­šå¸‚å ´éŠæˆ² - ç®¡ç†æ§åˆ¶å°</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: #f0f2f5; 
            overflow-x: hidden;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }
        
        /* Tab Navigation */
        .tab-navigation {
            background: white;
            border-bottom: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .tab-nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
        }
        
        .tab-nav {
            display: flex;
            min-width: fit-content;
        }
        
        .tab-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            font-weight: 500;
            color: #666;
            position: relative;
        }
        
        .tab-item:hover {
            color: #1890ff;
            background: #f0f9ff;
        }
        
        .tab-item.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
            background: #f0f9ff;
        }
        
        /* Tab Content */
        .tab-content {
            padding: 20px;
            min-height: calc(100vh - 200px);
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Card Styles */
        .card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .card h3 { 
            margin-bottom: 20px; 
            color: #333; 
            font-size: 18px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: #1890ff; color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-success { background: #52c41a; color: white; }
        .btn-success:hover { background: #73d13d; }
        .btn-danger { background: #ff4d4f; color: white; }
        .btn-danger:hover { background: #ff7875; }
        .btn-info { background: #13c2c2; color: white; }
        .btn-info:hover { background: #36cfc9; }
        .btn-secondary { background: #8c8c8c; color: white; }
        .btn-secondary:hover { background: #a6a6a6; }
        .btn-warning { background: #faad14; color: white; }
        .btn-warning:hover { background: #ffc53d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-input, .form-select {
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f9f9f9;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending { background: #fff7e6; color: #d46b08; }
        .status-active { background: #f6ffed; color: #389e0d; }
        .status-completed { background: #f0f0f0; color: #595959; }
        
        /* Loading and Empty States */
        .loading, .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 10px; }
            .tab-content { padding: 15px; }
            .form-grid { grid-template-columns: 1fr; }
            .card { padding: 16px; }
        }
        
        /* Alert Styles */
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .alert-success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #389e0d;
        }
        
        .alert-error {
            background: #fff2f0;
            border: 1px solid #ffb3b0;
            color: #cf1322;
        }
        
        .alert-info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #0050b3;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>ğŸŸ é­šå¸‚å ´éŠæˆ²ç®¡ç†æ§åˆ¶å°</h1>
                <div class="subtitle">Fish Market Game Management Dashboard</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="resetAllPasswords()" class="btn btn-warning" style="background: #faad14; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    ğŸ”„ é‡ç½®æ‰€æœ‰å¯†ç¢¼
                </button>
                <button onclick="logout()" class="btn btn-danger" style="background: #ff4d4f; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    ğŸšª ç™»å‡º
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <div class="tab-nav-container">
            <div class="tab-nav">
                <div class="tab-item active" onclick="switchTab('game-instructions')">ğŸ¯ éŠæˆ²ä»‹ç´¹</div>
                <div class="tab-item" onclick="switchTab('create-game')">ğŸ“ å‰µå»ºéŠæˆ²</div>
                <div class="tab-item" onclick="switchTab('game-control')">ğŸ® éŠæˆ²æ§åˆ¶</div>
                <div class="tab-item" onclick="switchTab('bidding-results')">ğŸ“Š ç«¶æ¨™çµæœ</div>
                <div class="tab-item" onclick="switchTab('daily-stats')">ğŸ“ˆ æ¯æ—¥çµ±è¨ˆ</div>
                <div class="tab-item" onclick="switchTab('game-history')">ğŸ“‹ æ­·å²éŠæˆ²</div>
                <div class="tab-item" onclick="switchTab('qr-code')">ğŸ“± QR Code</div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="container tab-content">
        <!-- Tab 0: Game Instructions -->
        <div id="game-instructions" class="tab-pane active">
            <div class="card">
                <h3>ğŸ¯ éŠæˆ²ä»‹ç´¹</h3>
                <div style="padding: 20px;">
                    <iframe src="game-instructions.html" style="width: 100%; height: 800px; border: none; border-radius: 8px;"></iframe>
                </div>
            </div>
        </div>
        
        <!-- Tab 1: Create Game -->
        <div id="create-game" class="tab-pane">
            <div class="card">
                <h3>å‰µå»ºæ–°éŠæˆ²</h3>
                <form id="create-game-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">éŠæˆ²åç¨± *</label>
                            <input type="text" class="form-input" id="gameName" placeholder="è¼¸å…¥éŠæˆ²åç¨±" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">éŠæˆ²å¤©æ•¸</label>
                            <input type="number" class="form-input" id="totalDays" value="7" min="1" max="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åƒèˆ‡çµ„æ•¸</label>
                            <input type="number" class="form-input" id="numTeams" value="12" min="1" max="20">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åˆå§‹è³‡é‡‘ (å…ƒ)</label>
                            <input type="number" class="form-input" id="initialBudget" value="1000000" min="100000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ¯æ—¥è²¸æ¬¾åˆ©ç‡ (%)</label>
                            <input type="number" class="form-input" id="loanInterestRate" value="3" min="0" max="10" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ»¯éŠ·è™•ç†è²» (å…ƒ/kg)</label>
                            <input type="number" class="form-input" id="unsoldFeePerKg" value="10" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Aç´šé­šç›®æ¨™åƒ¹æ ¼ (å…ƒ/kg)</label>
                            <input type="number" class="form-input" id="targetPriceA" value="500" min="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bç´šé­šç›®æ¨™åƒ¹æ ¼ (å…ƒ/kg)</label>
                            <input type="number" class="form-input" id="targetPriceB" value="300" min="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å›ºå®šæ»¯éŠ·æ¯”ä¾‹ (%)</label>
                            <input type="number" class="form-input" id="fixedUnsoldRatio" value="2.5" min="0" max="10" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è²·å…¥æŠ•æ¨™æ™‚é–“ (åˆ†é˜)</label>
                            <input type="number" class="form-input" id="buyingDuration" value="7" min="1" max="30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">è³£å‡ºæŠ•æ¨™æ™‚é–“ (åˆ†é˜)</label>
                            <input type="number" class="form-input" id="sellingDuration" value="4" min="1" max="30">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary" style="padding: 15px 40px; font-size: 16px;">
                            ğŸš€ å‰µå»ºéŠæˆ²
                        </button>
                    </div>
                </form>
            </div>

            <!-- Game Creation Results -->
            <div id="game-creation-result" style="display: none;"></div>
        </div>

        <!-- Tab 2: Game Control -->
        <div id="game-control" class="tab-pane">
            <div class="card">
                <h3>éŠæˆ²æ§åˆ¶é¢æ¿</h3>
            </div>

            <!-- Game Control Panel (will be populated dynamically) -->
            <div id="game-control-panel"></div>
        </div>

        <!-- Tab 3: Bidding Results -->
        <div id="bidding-results" class="tab-pane">
            <div class="card">
                <h3>ç«¶æ¨™çµæœæŸ¥çœ‹</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="min-width: 120px;">
                        <label class="form-label">é¸æ“‡å¤©æ•¸</label>
                        <select class="form-select" id="biddingDaySelect">
                            <option value="">è«‹é¸æ“‡å¤©æ•¸</option>
                        </select>
                    </div>
                    <div class="form-group" style="min-width: 120px;">
                        <label class="form-label">æŠ•æ¨™é¡å‹</label>
                        <select class="form-select" id="biddingTypeSelect">
                            <option value="all">å…¨éƒ¨æŠ•æ¨™</option>
                            <option value="buy">è²·å…¥æŠ•æ¨™</option>
                            <option value="sell">è³£å‡ºæŠ•æ¨™</option>
                        </select>
                    </div>
                    <div class="form-group" style="min-width: 100px;">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary" onclick="loadBiddingResults()">æŸ¥è©¢çµæœ</button>
                    </div>
                </div>
            </div>

            <!-- Bidding Results Table -->
            <div id="bidding-results-content">
                <div class="empty-state">
                    ğŸ“Š<br>è«‹é¸æ“‡å¤©æ•¸æŸ¥çœ‹ç«¶æ¨™çµæœ
                </div>
            </div>
        </div>

        <!-- Tab 4: Daily Stats -->
        <div id="daily-stats" class="tab-pane">
            <div class="card">
                <h3>æ¯æ—¥çµ±è¨ˆå ±è¡¨</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="min-width: 120px;">
                        <label class="form-label">é¸æ“‡å¤©æ•¸</label>
                        <select class="form-select" id="statsDaySelect">
                            <option value="">è«‹é¸æ“‡å¤©æ•¸</option>
                        </select>
                    </div>
                    <div class="form-group" style="min-width: 100px;">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary" onclick="loadDailyStats()">æŸ¥çœ‹çµ±è¨ˆ</button>
                    </div>
                </div>
            </div>

            <!-- Daily Stats Content -->
            <div id="daily-stats-content">
                <div class="empty-state">
                    ğŸ“ˆ<br>è«‹é¸æ“‡å¤©æ•¸æŸ¥çœ‹æ¯æ—¥çµ±è¨ˆ
                </div>
            </div>
        </div>

        <!-- Tab 5: Game History -->
        <div id="game-history" class="tab-pane">
            <div class="card">
                <h3>éŠæˆ²æ­·å²ç®¡ç†</h3>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-info" onclick="loadGameHistory()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                    <button class="btn btn-secondary" onclick="exportGameData()">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
                </div>
            </div>

            <!-- Game History Table -->
            <div id="game-history-content">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- Tab 6: QR Code -->
        <div id="qr-code" class="tab-pane">
            <div class="card">
                <h3>ğŸ“± å­¸ç”Ÿç™»å…¥ QR Code</h3>
                <div style="text-align: center; padding: 20px;">
                    <div id="server-info" style="margin-bottom: 20px;">
                        <p style="font-size: 18px; font-weight: bold;">ä¼ºæœå™¨ IP ä½å€ï¼š</p>
                        <p id="server-ip" style="font-size: 24px; color: #1890ff; margin: 10px 0;">åµæ¸¬ä¸­...</p>
                        <p style="font-size: 16px; color: #666;">å­¸ç”Ÿç™»å…¥ç¶²å€ï¼š</p>
                        <p id="student-url" style="font-size: 18px; color: #52c41a; margin: 10px 0;"></p>
                    </div>
                    <div id="qrcode-container" style="display: inline-block; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <!-- QR Code will be generated here -->
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="refreshQRCode()">ğŸ”„ é‡æ–°æ•´ç†</button>
                        <button class="btn btn-secondary" onclick="downloadQRCode()">ğŸ“¥ ä¸‹è¼‰ QR Code</button>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
                        <p style="font-size: 14px; color: #666;">
                            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                            1. å­¸ç”Ÿä½¿ç”¨æ‰‹æ©Ÿæƒæä¸Šæ–¹ QR Code<br>
                            2. æœƒè‡ªå‹•é–‹å•Ÿç™»å…¥é é¢<br>
                            3. è¼¸å…¥å¸³è™Ÿå¯†ç¢¼å³å¯é€²å…¥éŠæˆ²
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentGameId = null;
        let activeGame = null; // New global state for the single active game
        let authToken = localStorage.getItem('token');
        
        // Check authentication
        if (!authToken) {
            window.location.href = 'login.html';
        }

        // Load active game data function
        async function loadActiveGameData(tabId) {
            try {
                const response = await fetch('/api/admin/active-game', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 404) {
                    const error = await response.json();
                    if (error.code === 'NO_ACTIVE_GAME') {
                        // No active game found - show appropriate message
                        showNoActiveGameMessage(tabId);
                        return;
                    }
                }
                
                if (!response.ok) {
                    let detail = '';
                    try {
                        const errorData = await response.json();
                        detail = errorData.code || errorData.error || '';
                    } catch {}
                    const errorMsg = `è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—ï¼š${response.status} ${detail}`;
                    console.error(errorMsg);
                    throw new Error(errorMsg);
                }
                
                activeGame = await response.json();
                currentGameId = activeGame.id; // Update currentGameId for compatibility
                
                // Call appropriate rendering function based on tab
                switch(tabId) {
                    case 'game-control':
                        displayGameControlPanel(activeGame);
                        break;
                    case 'bidding-results':
                        populateDaySelectors();
                        break;
                    case 'daily-stats':
                        populateDaySelectors();
                        break;
                }
                
            } catch (error) {
                console.error('Error loading active game data:', error);
                showError(error.message || 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // Show message when no active game is found
        function showNoActiveGameMessage(tabId) {
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.innerHTML = `
                    <div class="alert alert-warning" style="margin: 20px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„éŠæˆ²</h4>
                        <p style="color: #856404; margin-bottom: 15px;">è«‹å…ˆå‰µå»ºä¸€å€‹æ–°éŠæˆ²å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</p>
                        <button onclick="switchTab('create-game')" class="btn btn-primary">å‰å¾€å‰µå»ºéŠæˆ²</button>
                    </div>
                `;
            }
        }

        // Show error message
        function showError(message) {
            // You can customize this to show errors in a modal or notification
            alert(message);
        }

        // Populate day selectors based on activeGame data
        function populateDaySelectors() {
            if (!activeGame) return;
            
            const currentDay = activeGame.current_day;
            
            // Update bidding results day selector
            const biddingDaySelect = document.getElementById('biddingDaySelect');
            if (biddingDaySelect) {
                biddingDaySelect.innerHTML = '<option value="">é¸æ“‡å¤©æ•¸</option>';
                for (let i = 1; i <= currentDay; i++) {
                    biddingDaySelect.innerHTML += `<option value="${i}">ç¬¬ ${i} å¤©</option>`;
                }
            }
            
            // Update daily stats day selector
            const statsDaySelect = document.getElementById('statsDaySelect');
            if (statsDaySelect) {
                statsDaySelect.innerHTML = '<option value="">é¸æ“‡å¤©æ•¸</option>';
                for (let i = 1; i <= currentDay; i++) {
                    statsDaySelect.innerHTML += `<option value="${i}">ç¬¬ ${i} å¤©</option>`;
                }
            }
        }

        // Tab switching functionality
        function switchTab(tabId) {
            // Clear game control refresh interval when leaving game control tab
            if (window.gameControlRefreshInterval && tabId !== 'game-control') {
                clearInterval(window.gameControlRefreshInterval);
                window.gameControlRefreshInterval = null;
            }
            
            // Update tab navigation
            document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            // Fix: Handle both click events and programmatic calls
            const target = (typeof event !== 'undefined' && event?.target) 
                ? event.target 
                : document.querySelector(`.tab-item[onclick="switchTab('${tabId}')"]`);
            if (target) {
                target.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // Load content based on tab
            switch(tabId) {
                case 'game-control':
                case 'bidding-results':
                case 'daily-stats':
                    // These tabs need active game data
                    loadActiveGameData(tabId);
                    break;
                case 'game-history':
                    loadGameHistory();
                    break;
            }
        }

        // Game creation functionality
        document.getElementById('create-game-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                gameName: document.getElementById('gameName').value,
                totalDays: parseInt(document.getElementById('totalDays').value),
                numTeams: parseInt(document.getElementById('numTeams').value),
                initialBudget: parseInt(document.getElementById('initialBudget').value),
                loanInterestRate: parseFloat(document.getElementById('loanInterestRate').value) / 100,
                unsoldFeePerKg: parseFloat(document.getElementById('unsoldFeePerKg').value),
                targetPriceA: parseInt(document.getElementById('targetPriceA').value),
                targetPriceB: parseInt(document.getElementById('targetPriceB').value),
                fixedUnsoldRatio: parseFloat(document.getElementById('fixedUnsoldRatio').value),
                buyingDuration: parseInt(document.getElementById('buyingDuration').value),
                sellingDuration: parseInt(document.getElementById('sellingDuration').value)
            };

            try {
                const response = await fetch('/api/admin/games/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showGameCreationResult(result);
                    document.getElementById('create-game-form').reset();
                    // Set default values back
                    document.getElementById('totalDays').value = '7';
                    document.getElementById('numTeams').value = '12';
                    document.getElementById('initialBudget').value = '1000000';
                    document.getElementById('loanInterestRate').value = '3';
                    document.getElementById('unsoldFeePerKg').value = '10';
                    document.getElementById('targetPriceA').value = '500';
                    document.getElementById('targetPriceB').value = '300';
                    document.getElementById('fixedUnsoldRatio').value = '2.5';
                    document.getElementById('buyingDuration').value = '7';
                    document.getElementById('sellingDuration').value = '4';
                } else {
                    showAlert('éŠæˆ²å‰µå»ºå¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error creating game:', error);
                showAlert('éŠæˆ²å‰µå»ºå¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        });

        // Show game creation result
        function showGameCreationResult(result) {
            const resultDiv = document.getElementById('game-creation-result');
            
            // å¦‚æœæ²’æœ‰gameUrlï¼Œä½¿ç”¨ç•¶å‰ç¶²å€
            const gameUrl = result.gameUrl || window.location.origin;
            const serverIP = result.serverIP || window.location.hostname;
            const port = result.port || window.location.port || '3000';
            
            resultDiv.innerHTML = `
                <div class="card" style="background: #f6ffed; border: 1px solid #b7eb8f;">
                    <h3 style="color: #389e0d; border-bottom-color: #d9f7be;">âœ… éŠæˆ²å‰µå»ºæˆåŠŸï¼</h3>
                    <div>
                        <p><strong>éŠæˆ² ID:</strong> ${result.gameId}</p>
                        <p><strong>éŠæˆ²åç¨±:</strong> ${result.gameName}</p>
                        <p><strong>éŠæˆ²é€£çµ:</strong> <a href="${gameUrl}" target="_blank">${gameUrl}</a></p>
                        <p><strong>ä¼ºæœå™¨ IP:</strong> ${serverIP}:${port}</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="loadGameInControl(${result.gameId})">
                                ğŸ® ç«‹å³æ§åˆ¶æ­¤éŠæˆ²
                            </button>
                            <button class="btn btn-info" onclick="copyGameInfo('${gameUrl}')">
                                ğŸ“‹ è¤‡è£½éŠæˆ²é€£çµ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Load game in control tab
        function loadGameInControl(gameId) {
            // Set the current game ID
            currentGameId = gameId;
            // Switch to game control tab
            switchTab('game-control');
            // Load the active game data for the control panel
            loadActiveGameData('game-control');
        }

        // Copy game info
        function copyGameInfo(url) {
            navigator.clipboard.writeText(url).then(() => {
                showAlert('éŠæˆ²é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼', 'success');
            });
        }

        
        // Refresh game status
        async function refreshGameStatus() {
            if (!currentGameId) return;
            
            try {
                const response = await fetch(`/api/admin/games/${currentGameId}/status`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const gameStatus = await response.json();
                    updateGameControlPanel(gameStatus);
                }
            } catch (error) {
                console.error('Error refreshing game status:', error);
            }
        }
        
        // Display game control panel
        async function displayGameControlPanel(gameStatus) {
            const panelDiv = document.getElementById('game-control-panel');
            
            // è¼‰å…¥åœ˜éšŠè³‡æ–™
            try {
                const teamsResponse = await fetch(`/api/admin/games/${gameStatus.id}/teams`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (teamsResponse.ok) {
                    gameStatus.teams = await teamsResponse.json();
                }
            } catch (error) {
                console.error('Error loading teams:', error);
            }
            
            const statusClass = gameStatus.status === 'active' ? 'status-active' : 
                              gameStatus.status === 'completed' ? 'status-completed' : 'status-pending';
            const statusText = gameStatus.status === 'active' ? 'é€²è¡Œä¸­' :
                             gameStatus.status === 'completed' ? 'å·²çµæŸ' : 'æº–å‚™ä¸­';
            
            // æ˜ å°„å¾Œç«¯phaseå€¼åˆ°å‰ç«¯æœŸæœ›çš„å€¼
            const phaseMapping = {
                'buying_open': 'buying',
                'selling_open': 'selling',
                'buying_closed': 'buying_closed',
                'selling_closed': 'selling_closed',
                'buy_ended': 'buying_closed',
                'sell_ended': 'selling_closed',
                'settled': 'settled',
                'pending': 'pending'
            };
            const normalizedPhase = phaseMapping[gameStatus.phase] || gameStatus.phase;
            
            const phaseText = getPhaseText(normalizedPhase);
            const phaseClass = getPhaseClass(normalizedPhase);
            
            let html = `
                <div class="card">
                    <h3>ğŸ® éŠæˆ²æ§åˆ¶ - ${gameStatus.gameName}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #1890ff;">${currentGameId}</div>
                            <div style="color: #666;">éŠæˆ² ID</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: ${getStatusBackground(gameStatus.status)}; border-radius: 8px;">
                            <div style="font-size: 18px; font-weight: bold;"><span class="status-badge ${statusClass}">${statusText}</span></div>
                            <div style="color: #666;">éŠæˆ²ç‹€æ…‹</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: ${getPhaseBackground(gameStatus.phase)}; border-radius: 8px;">
                            <div style="font-size: 18px; font-weight: bold;"><span class="status-badge ${phaseClass}">${phaseText}</span></div>
                            <div style="color: #666;">ç•¶å‰éšæ®µ</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #595959;">${gameStatus.currentDay}/${gameStatus.totalDays}</div>
                            <div style="color: #666;">éŠæˆ²é€²åº¦</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Game control buttons
            html += `<div class="card"><h3>ğŸ¯ éŠæˆ²æ“ä½œ</h3><div id="game-control-buttons">`;
            html += generateControlButtons(gameStatus);
            html += `</div></div>`;
            
            // Market parameters (if current day exists)
            if (gameStatus.currentDayData) {
                html += `
                    <div class="card">
                        <h3>ğŸ“Š ç•¶æ—¥å¸‚å ´åƒæ•¸ - ç¬¬ ${gameStatus.currentDay} å¤©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="padding: 15px; background: #e6f7ff; border-radius: 8px;">
                                <div style="font-weight: bold; color: #1890ff;">Aç´šé­šä¾›çµ¦</div>
                                <div style="font-size: 20px; margin-top: 5px;">${(gameStatus.currentDayData.fishASupply || 0).toLocaleString()} kg</div>
                            </div>
                            <div style="padding: 15px; background: #f6ffed; border-radius: 8px;">
                                <div style="font-weight: bold; color: #52c41a;">Bç´šé­šä¾›çµ¦</div>
                                <div style="font-size: 20px; margin-top: 5px;">${(gameStatus.currentDayData.fishBSupply || 0).toLocaleString()} kg</div>
                            </div>
                            <div style="padding: 15px; background: #fff7e6; border-radius: 8px;">
                                <div style="font-weight: bold; color: #fa8c16;">Aç´šé­šé¤å»³é ç®—</div>
                                <div style="font-size: 20px; margin-top: 5px;">$${(gameStatus.currentDayData.fishARestaurantBudget || 0).toLocaleString()}</div>
                            </div>
                            <div style="padding: 15px; background: #fff2f0; border-radius: 8px;">
                                <div style="font-weight: bold; color: #ff4d4f;">Bç´šé­šé¤å»³é ç®—</div>
                                <div style="font-size: 20px; margin-top: 5px;">$${(gameStatus.currentDayData.fishBRestaurantBudget || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Teams overview
            if (gameStatus.teams && gameStatus.teams.length > 0) {
                html += `
                    <div class="card">
                        <h3>ğŸ‘¥ åœ˜éšŠæ¦‚æ³ (${gameStatus.teams.length} çµ„)</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åœ˜éšŠ</th>
                                    <th>ç•¶å‰ç¾é‡‘</th>
                                    <th>ç¸½å€Ÿè²¸</th>
                                    <th>Aç´šé­šåº«å­˜</th>
                                    <th>Bç´šé­šåº«å­˜</th>
                                    <th>ç´¯ç©æ”¶ç›Š</th>
                                    <th>ROI (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                gameStatus.teams.forEach((team, index) => {
                    const roiClass = (team.roi || 0) >= 0 ? 'style="color: #52c41a;"' : 'style="color: #ff4d4f;"';
                    const profitClass = (team.cumulative_profit || 0) >= 0 ? 'style="color: #52c41a;"' : 'style="color: #ff4d4f;"';
                    
                    html += `
                        <tr>
                            <td><strong>${team.team_name || `åœ˜éšŠ${team.username}`}</strong></td>
                            <td>$${(team.current_budget || 0).toLocaleString()}</td>
                            <td>$${(team.total_loan || 0).toLocaleString()}</td>
                            <td>${team.fish_a_inventory || 0} kg</td>
                            <td>${team.fish_b_inventory || 0} kg</td>
                            <td ${profitClass}>$${(team.cumulative_profit || 0).toLocaleString()}</td>
                            <td ${roiClass}>${(team.roi || 0).toFixed(2)}%</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            panelDiv.innerHTML = html;
        }
        
        // Update game control panel (for refresh)
        function updateGameControlPanel(gameStatus) {
            const buttonsDiv = document.getElementById('game-control-buttons');
            if (buttonsDiv) {
                buttonsDiv.innerHTML = generateControlButtons(gameStatus);
            }
        }
        
        // Generate control buttons based on game status
        function generateControlButtons(gameStatus) {
            let html = '';
            
            if (gameStatus.status === 'completed') {
                html += '<div class="alert alert-info">éŠæˆ²å·²çµæŸ</div>';
                return html;
            }
            
            // æ˜ å°„å¾Œç«¯phaseå€¼åˆ°å‰ç«¯æœŸæœ›çš„å€¼
            // è³‡æ–™åº« game_days.status æ¨™æº–å€¼: pending, buying_open, buying_closed, selling_open, selling_closed, settled
            const phaseMapping = {
                'pending': 'pending',
                'buying_open': 'buying',
                'buying_closed': 'buying_closed',
                'selling_open': 'selling',
                'selling_closed': 'selling_closed',
                'settled': 'settled'
            };
            const phase = phaseMapping[gameStatus.phase] || gameStatus.phase;

            // Debug: é¡¯ç¤ºç•¶å‰ç‹€æ…‹
            console.log('ç•¶å‰éŠæˆ²éšæ®µ:', gameStatus.phase, 'â†’ æ˜ å°„å¾Œ:', phase);
            
            // Day advancement
            if (phase === 'pending' || phase === 'day_ended') {
                html += `
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="advanceDay()">
                            â¡ï¸ æ¨é€²åˆ°ç¬¬ ${gameStatus.currentDay + 1} å¤©
                        </button>
                    </div>
                `;
            }
            
            // Buying phase controls
            if (phase === 'pending') {
                html += `
                    <button class="btn btn-primary" onclick="startBuying()">
                        ğŸ›’ é–‹å§‹è²·å…¥æŠ•æ¨™
                    </button>
                `;
            } else if (phase === 'buying') {
                html += `
                    <button class="btn btn-warning" onclick="closeBuying()">
                        â¹ï¸ çµæŸè²·å…¥æŠ•æ¨™
                    </button>
                `;
            }
            
            // Selling phase controls
            if (phase === 'buying_closed') {
                html += `
                    <button class="btn btn-primary" onclick="startSelling()">
                        ğŸ’° é–‹å§‹è³£å‡ºæŠ•æ¨™
                    </button>
                `;
            } else if (phase === 'selling') {
                html += `
                    <button class="btn btn-warning" onclick="closeSelling()">
                        â¹ï¸ çµæŸè³£å‡ºæŠ•æ¨™
                    </button>
                `;
            }
            
            // Settlement
            if (phase === 'selling_closed' || phase === 'settled') {
                html += `
                    <button class="btn btn-success" onclick="settleDailyResults()">
                        ğŸ’ åŸ·è¡Œæ¯æ—¥çµç®—
                    </button>
                `;
            }
            
            return html;
        }
        
        // Helper functions for styling
        function getPhaseText(phase) {
            const phaseMap = {
                'pending': 'ç­‰å¾…é–‹å§‹',
                'buying': 'è²·å…¥æŠ•æ¨™ä¸­',
                'buying_closed': 'è²·å…¥å·²çµæŸ',
                'selling': 'è³£å‡ºæŠ•æ¨™ä¸­',
                'selling_closed': 'è³£å‡ºå·²çµæŸ',
                'settled': 'çµç®—ä¸­',
                'day_ended': 'ç•¶æ—¥çµæŸ'
            };
            return phaseMap[phase] || phase;
        }
        
        function getPhaseClass(phase) {
            if (['buying', 'selling'].includes(phase)) return 'status-active';
            if (['settled', 'buying_closed', 'selling_closed'].includes(phase)) return 'status-pending';
            return 'status-completed';
        }
        
        function getStatusBackground(status) {
            return status === 'active' ? '#f6ffed' : 
                   status === 'completed' ? '#f0f0f0' : '#fff7e6';
        }
        
        function getPhaseBackground(phase) {
            if (['buying', 'selling'].includes(phase)) return '#f6ffed';
            if (['settled', 'buying_closed', 'selling_closed'].includes(phase)) return '#fff7e6';
            return '#f0f0f0';
        }
        
        // Game control actions
        async function advanceDay() {
            if (!confirm('ç¢ºå®šè¦æ¨é€²åˆ°ä¸‹ä¸€å¤©å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/games/${activeGame.id}/next-day`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('æˆåŠŸæ¨é€²åˆ°ä¸‹ä¸€å¤©ï¼', 'success');
                    // Reload active game data to refresh the control panel
                    loadActiveGameData('game-control');
                } else {
                    showAlert('æ¨é€²å¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error advancing day:', error);
                showAlert('æ¨é€²å¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }
        
        async function startBuying() {
            const duration = prompt('è«‹è¼¸å…¥è²·å…¥æŠ•æ¨™æ™‚é–“ (åˆ†é˜):', '7');
            if (!duration) return;
            
            try {
                const response = await fetch(`/api/admin/games/${activeGame.id}/start-buying`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ duration: parseInt(duration) })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`è²·å…¥æŠ•æ¨™å·²é–‹å§‹ï¼Œæ™‚é–“ï¼š${duration} åˆ†é˜`, 'success');
                    // Reload active game data to refresh the control panel
                    loadActiveGameData('game-control');
                } else {
                    showAlert('é–‹å§‹è²·å…¥å¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error starting buying:', error);
                showAlert('é–‹å§‹è²·å…¥å¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }
        
        async function closeBuying() {
            if (!confirm('ç¢ºå®šè¦çµæŸè²·å…¥æŠ•æ¨™å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/games/${activeGame.id}/close-buying`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('è²·å…¥æŠ•æ¨™å·²çµæŸï¼Œæ­£åœ¨è™•ç†æŠ•æ¨™...', 'success');
                    loadActiveGameData('game-control');
                } else {
                    showAlert('çµæŸè²·å…¥å¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error closing buying:', error);
                showAlert('çµæŸè²·å…¥å¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }
        
        async function startSelling() {
            const duration = prompt('è«‹è¼¸å…¥è³£å‡ºæŠ•æ¨™æ™‚é–“ (åˆ†é˜):', '5');
            if (!duration) return;
            
            try {
                const response = await fetch(`/api/admin/games/${activeGame.id}/start-selling`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ duration: parseInt(duration) })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`è³£å‡ºæŠ•æ¨™å·²é–‹å§‹ï¼Œæ™‚é–“ï¼š${duration} åˆ†é˜`, 'success');
                    loadActiveGameData('game-control');
                } else {
                    showAlert('é–‹å§‹è³£å‡ºå¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error starting selling:', error);
                showAlert('é–‹å§‹è³£å‡ºå¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }
        
        async function closeSelling() {
            if (!confirm('ç¢ºå®šè¦çµæŸè³£å‡ºæŠ•æ¨™å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/games/${activeGame.id}/close-selling`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('è³£å‡ºæŠ•æ¨™å·²çµæŸï¼Œæ­£åœ¨è™•ç†æŠ•æ¨™...', 'success');
                    loadActiveGameData('game-control');
                } else {
                    showAlert('çµæŸè³£å‡ºå¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error closing selling:', error);
                showAlert('çµæŸè³£å‡ºå¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }
        
        async function settleDailyResults() {
            if (!confirm('ç¢ºå®šè¦åŸ·è¡Œæ¯æ—¥çµç®—å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/games/${activeGame.id}/settle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('æ¯æ—¥çµç®—å·²å®Œæˆï¼', 'success');
                    loadActiveGameData('game-control');
                } else {
                    showAlert('æ¯æ—¥çµç®—å¤±æ•—: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error settling daily results:', error);
                showAlert('æ¯æ—¥çµç®—å¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }


        // Load bidding results - ä½¿ç”¨æ–°çš„ bid-summary API
        async function loadBiddingResults() {
            if (!activeGame) {
                showAlert('è«‹å…ˆåˆ‡æ›åˆ°æ­¤åˆ†é è¼‰å…¥éŠæˆ²è³‡æ–™', 'error');
                return;
            }

            const day = document.getElementById('biddingDaySelect').value;
            const type = document.getElementById('biddingTypeSelect').value;
            const contentDiv = document.getElementById('bidding-results-content');

            if (!day) {
                showAlert('è«‹é¸æ“‡å¤©æ•¸', 'error');
                return;
            }

            contentDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

            try {
                // ä½¿ç”¨ç¾æœ‰çš„ daily-results API
                const response = await fetch(`/api/admin/games/${activeGame.id}/daily-results/${day}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayBiddingResultsWithStats(data, type);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('è¼‰å…¥å¤±æ•—:', errorData);
                    contentDiv.innerHTML = `<div class="empty-state">âŒ<br>è¼‰å…¥å¤±æ•—<br><small style="color: #999;">${errorData.message || errorData.error || ''}</small></div>`;
                    showAlert('è¼‰å…¥ç«¶æ¨™çµæœå¤±æ•—: ' + (errorData.message || errorData.error || ''), 'error');
                }
            } catch (error) {
                console.error('Error loading bidding results:', error);
                contentDiv.innerHTML = '<div class="empty-state">âŒ<br>è¼‰å…¥å¤±æ•—</div>';
                showAlert('è¼‰å…¥ç«¶æ¨™çµæœå¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }
        
        // Display bidding results with statistics - ä½¿ç”¨ daily-results API æ•¸æ“š
        function displayBiddingResultsWithStats(data, selectedType) {
            const contentDiv = document.getElementById('bidding-results-content');

            // èª¿è©¦ä¿¡æ¯
            console.log('ç«¶æ¨™çµæœæ•¸æ“šï¼š', data);

            // æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§ - daily-results API è¿”å› {dayInfo, bids, teamResults}
            if (!data || !data.dayInfo || !data.bids) {
                contentDiv.innerHTML = '<div class="empty-state">âŒ<br>æ•¸æ“šæ ¼å¼éŒ¯èª¤</div>';
                console.error('æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼š', data);
                return;
            }

            // æŒ‰é¡å‹å’Œé­šç¨®åˆ†çµ„æŠ•æ¨™æ•¸æ“š
            const buyBidsA = data.bids.filter(b => b.bid_type === 'buy' && b.fish_type === 'A');
            const buyBidsB = data.bids.filter(b => b.bid_type === 'buy' && b.fish_type === 'B');
            const sellBidsA = data.bids.filter(b => b.bid_type === 'sell' && b.fish_type === 'A');
            const sellBidsB = data.bids.filter(b => b.bid_type === 'sell' && b.fish_type === 'B');

            const hasBuyBids = (buyBidsA.length > 0 || buyBidsB.length > 0);
            const hasSellBids = (sellBidsA.length > 0 || sellBidsB.length > 0);

            if (!hasBuyBids && !hasSellBids) {
                contentDiv.innerHTML = '<div class="empty-state">ğŸ“Š<br>è©²å¤©å°šç„¡æŠ•æ¨™è³‡æ–™</div>';
                return;
            }

            let html = '';

            // é¡¯ç¤ºå¸‚å ´è³‡è¨Šæ‘˜è¦
            html += `
                <div class="card" style="background: #f0f8ff; margin-bottom: 20px;">
                    <h4>ğŸ“ˆ ç¬¬ ${data.dayInfo.day_number} å¤©å¸‚å ´æ¦‚æ³</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div>
                            <strong>Aé­šä¾›çµ¦é‡ï¼š</strong> ${(data.dayInfo.fish_a_supply || 0).toLocaleString()} kg<br>
                            <strong>Aé­šé¤å»³é ç®—ï¼š</strong> $${(data.dayInfo.fish_a_restaurant_budget || 0).toLocaleString()}
                        </div>
                        <div>
                            <strong>Bé­šä¾›çµ¦é‡ï¼š</strong> ${(data.dayInfo.fish_b_supply || 0).toLocaleString()} kg<br>
                            <strong>Bé­šé¤å»³é ç®—ï¼š</strong> $${(data.dayInfo.fish_b_restaurant_budget || 0).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;

            // æ ¹æ“šé¸æ“‡é¡¯ç¤ºè²·å…¥æˆ–è³£å‡ºæŠ•æ¨™
            if ((selectedType === 'buy' || selectedType === 'all') && hasBuyBids) {
                html += displayBidTable('è²·å…¥æŠ•æ¨™', {fishA: buyBidsA, fishB: buyBidsB}, 'buy', data.dayInfo.day_number);
            }

            if ((selectedType === 'sell' || selectedType === 'all') && hasSellBids) {
                html += displayBidTable('è³£å‡ºæŠ•æ¨™', {fishA: sellBidsA, fishB: sellBidsB}, 'sell', data.dayInfo.day_number);
            }

            contentDiv.innerHTML = html;
        }
        
        // Display bid table - ç°¡åŒ–ç‰ˆæœ¬,ä¸ä¾è³´è¤‡é›œçµ±è¨ˆ
        function displayBidTable(title, bids, bidType, dayNumber) {
            const fishABids = bids.fishA || [];
            const fishBBids = bids.fishB || [];
            
            if (fishABids.length === 0 && fishBBids.length === 0) {
                return `<div class="card"><h4>${title}</h4><p>æš«ç„¡è³‡æ–™</p></div>`;
            }
            
            const isBuy = (bidType === 'buy');
            let html = `<div class="card"><h4>${title} - ç¬¬${dayNumber}å¤©</h4>`;

            // è¨ˆç®—ç°¡å–®çµ±è¨ˆ
            const calcStats = (bids) => {
                const totalSubmitted = bids.reduce((sum, b) => sum + (b.quantity_submitted || 0), 0);
                const totalFulfilled = bids.reduce((sum, b) => sum + (b.quantity_fulfilled || 0), 0);
                const fulfilledBids = bids.filter(b => (b.quantity_fulfilled || 0) > 0);
                const rate = totalSubmitted > 0 ? ((totalFulfilled / totalSubmitted) * 100).toFixed(1) : '0';
                return { totalSubmitted, totalFulfilled, rate, count: bids.length };
            };

            // Aç´šé­šæŠ•æ¨™
            if (fishABids.length > 0) {
                const statsA = calcStats(fishABids);
                html += `
                    <h5 style="margin: 20px 0 10px 0; color: #1890ff;">ğŸŸ Aç´šé­š${title}</h5>

                    <!-- çµ±è¨ˆè³‡è¨Š -->
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>çµ±è¨ˆæ‘˜è¦ï¼š</strong>
                        ç¸½æŠ•æ¨™æ•¸ï¼š${statsA.count} |
                        ç¸½æäº¤é‡ï¼š${statsA.totalSubmitted} kg |
                        ç¸½æˆäº¤é‡ï¼š${statsA.totalFulfilled} kg |
                        æˆäº¤ç‡ï¼š${statsA.rate}%
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>åœ˜éšŠ</th>
                                <th>å‡ºåƒ¹ (å…ƒ/kg)</th>
                                <th>æ•¸é‡ (kg)</th>
                                <th>ç¸½é‡‘é¡</th>
                                <th>æˆäº¤æ•¸é‡</th>
                                <th>æˆäº¤ç‡</th>
                                <th>ç‹€æ…‹</th>
                                <th>æŠ•æ¨™æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // æ ¹æ“šè²·å…¥æˆ–è³£å‡ºæ’åº
                const sortedFishABids = [...fishABids].sort((a, b) => {
                    if (isBuy) {
                        return b.price - a.price; // è²·å…¥ï¼šåƒ¹é«˜å„ªå…ˆ
                    } else {
                        return a.price - b.price; // è³£å‡ºï¼šåƒ¹ä½å„ªå…ˆ
                    }
                });
                
                sortedFishABids.forEach(bid => {
                    const statusClass = bid.status === 'fulfilled' ? 'status-active' :
                                      bid.status === 'partial' ? 'status-pending' :
                                      bid.status === 'failed' ? 'status-completed' : '';
                    const statusText = bid.status === 'fulfilled' ? 'å®Œå…¨æˆäº¤' :
                                     bid.status === 'partial' ? 'éƒ¨åˆ†æˆäº¤' :
                                     bid.status === 'pending' ? 'ç­‰å¾…ä¸­' : 'æœªæˆäº¤';

                    const totalAmount = bid.price * bid.quantity_submitted;
                    const fulfillmentRate = bid.quantity_submitted > 0 ?
                        ((bid.quantity_fulfilled || 0) / bid.quantity_submitted * 100).toFixed(1) : '0';

                    // æª¢æŸ¥æ˜¯å¦ç‚ºå—2.5%æ»¯éŠ·å½±éŸ¿çš„æœ€é«˜åƒ¹æŠ•æ¨™
                    let isHighestPrice = false;
                    let unsoldNote = '';
                    if (!isBuy && fishABids.length > 0) {
                        const maxPrice = Math.max(...fishABids.map(b => b.price));
                        if (bid.price === maxPrice) {
                            isHighestPrice = true;
                            const unsoldQty = Math.ceil(bid.quantity_submitted * 2.5 / 100);
                            unsoldNote = ` (2.5%æ»¯éŠ·: ${unsoldQty}kg)`;
                        }
                    }

                    html += `
                        <tr ${isHighestPrice ? 'style="background-color: #ffebee;"' : ''}>
                            <td>${bid.team_name || `åœ˜éšŠ${bid.team_id}`}</td>
                            <td>$${bid.price.toLocaleString()} ${isHighestPrice ? 'ğŸ”´' : ''}</td>
                            <td>${bid.quantity_submitted.toLocaleString()}${unsoldNote}</td>
                            <td>$${totalAmount.toLocaleString()}</td>
                            <td>${(bid.quantity_fulfilled || 0).toLocaleString()}</td>
                            <td>${fulfillmentRate}%</td>
                            <td><span class="status-badge ${statusClass}">${statusText}${isHighestPrice ? ' (å«æ»¯éŠ·)' : ''}</span></td>
                            <td>${new Date(bid.created_at).toLocaleTimeString('zh-TW')}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            // Bç´šé­šæŠ•æ¨™
            if (fishBBids.length > 0) {
                const statsB = calcStats(fishBBids);
                html += `
                    <h5 style="margin: 20px 0 10px 0; color: #52c41a;">ğŸ  Bç´šé­š${title}</h5>

                    <!-- çµ±è¨ˆè³‡è¨Š -->
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>çµ±è¨ˆæ‘˜è¦ï¼š</strong>
                        ç¸½æŠ•æ¨™æ•¸ï¼š${statsB.count} |
                        ç¸½æäº¤é‡ï¼š${statsB.totalSubmitted} kg |
                        ç¸½æˆäº¤é‡ï¼š${statsB.totalFulfilled} kg |
                        æˆäº¤ç‡ï¼š${statsB.rate}%
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>åœ˜éšŠ</th>
                                <th>å‡ºåƒ¹ (å…ƒ/kg)</th>
                                <th>æ•¸é‡ (kg)</th>
                                <th>ç¸½é‡‘é¡</th>
                                <th>æˆäº¤æ•¸é‡</th>
                                <th>æˆäº¤ç‡</th>
                                <th>ç‹€æ…‹</th>
                                <th>æŠ•æ¨™æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // æ ¹æ“šè²·å…¥æˆ–è³£å‡ºæ’åº
                const sortedFishBBids = [...fishBBids].sort((a, b) => {
                    if (isBuy) {
                        return b.price - a.price; // è²·å…¥ï¼šåƒ¹é«˜å„ªå…ˆ
                    } else {
                        return a.price - b.price; // è³£å‡ºï¼šåƒ¹ä½å„ªå…ˆ
                    }
                });
                
                sortedFishBBids.forEach(bid => {
                    const statusClass = bid.status === 'fulfilled' ? 'status-active' :
                                      bid.status === 'partial' ? 'status-pending' :
                                      bid.status === 'failed' ? 'status-completed' : '';
                    const statusText = bid.status === 'fulfilled' ? 'å®Œå…¨æˆäº¤' :
                                     bid.status === 'partial' ? 'éƒ¨åˆ†æˆäº¤' :
                                     bid.status === 'pending' ? 'ç­‰å¾…ä¸­' : 'æœªæˆäº¤';

                    const totalAmount = bid.price * bid.quantity_submitted;
                    const fulfillmentRate = bid.quantity_submitted > 0 ?
                        ((bid.quantity_fulfilled || 0) / bid.quantity_submitted * 100).toFixed(1) : '0';

                    // æª¢æŸ¥æ˜¯å¦ç‚ºå—2.5%æ»¯éŠ·å½±éŸ¿çš„æœ€é«˜åƒ¹æŠ•æ¨™
                    let isHighestPrice = false;
                    let unsoldNote = '';
                    if (!isBuy && fishBBids.length > 0) {
                        const maxPrice = Math.max(...fishBBids.map(b => b.price));
                        if (bid.price === maxPrice) {
                            isHighestPrice = true;
                            const unsoldQty = Math.ceil(bid.quantity_submitted * 2.5 / 100);
                            unsoldNote = ` (2.5%æ»¯éŠ·: ${unsoldQty}kg)`;
                        }
                    }

                    html += `
                        <tr ${isHighestPrice ? 'style="background-color: #ffebee;"' : ''}>
                            <td>${bid.team_name || `åœ˜éšŠ${bid.team_id}`}</td>
                            <td>$${bid.price.toLocaleString()} ${isHighestPrice ? 'ğŸ”´' : ''}</td>
                            <td>${bid.quantity_submitted.toLocaleString()}${unsoldNote}</td>
                            <td>$${totalAmount.toLocaleString()}</td>
                            <td>${(bid.quantity_fulfilled || 0).toLocaleString()}</td>
                            <td>${fulfillmentRate}%</td>
                            <td><span class="status-badge ${statusClass}">${statusText}${isHighestPrice ? ' (å«æ»¯éŠ·)' : ''}</span></td>
                            <td>${new Date(bid.created_at).toLocaleTimeString('zh-TW')}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            html += '</div>';
            return html;
        }

        // Load daily stats
        async function loadDailyStats() {
            if (!activeGame) {
                showAlert('è«‹å…ˆåˆ‡æ›åˆ°æ­¤åˆ†é è¼‰å…¥éŠæˆ²è³‡æ–™', 'error');
                return;
            }
            
            const day = document.getElementById('statsDaySelect').value;
            const contentDiv = document.getElementById('daily-stats-content');
            
            if (!day) {
                showAlert('è«‹é¸æ“‡å¤©æ•¸', 'error');
                return;
            }
            
            contentDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                const response = await fetch(`/api/admin/games/${activeGame.id}/daily-results/${day}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayDailyStats(data, day);
                } else {
                    contentDiv.innerHTML = '<div class="empty-state">âŒ<br>è¼‰å…¥å¤±æ•—</div>';
                    showAlert('è¼‰å…¥æ¯æ—¥çµ±è¨ˆå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('Error loading daily stats:', error);
                contentDiv.innerHTML = '<div class="empty-state">âŒ<br>è¼‰å…¥å¤±æ•—</div>';
                showAlert('è¼‰å…¥æ¯æ—¥çµ±è¨ˆå¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }
        
        // Display daily stats
        function displayDailyStats(data, day) {
            const contentDiv = document.getElementById('daily-stats-content');
            
            if (!data.results || data.results.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state">ğŸ“ˆ<br>è©²å¤©å°šç„¡çµ±è¨ˆè³‡æ–™</div>';
                return;
            }
            
            let html = `
                <div class="card">
                    <h4>ç¬¬ ${day} å¤© - æ¯æ—¥çµ±è¨ˆå ±è¡¨</h4>
                    <div style="margin: 20px 0;">
                        <strong>å¸‚å ´åƒæ•¸ï¼š</strong>
                        Aç´šé­šä¾›çµ¦: ${data.dayInfo.fish_a_supply || 0} kg | 
                        Bç´šé­šä¾›çµ¦: ${data.dayInfo.fish_b_supply || 0} kg | 
                        Aç´šé­šé¤å»³é ç®—: $${(data.dayInfo.fish_a_restaurant_budget || 0).toLocaleString()} | 
                        Bç´šé­šé¤å»³é ç®—: $${(data.dayInfo.fish_b_restaurant_budget || 0).toLocaleString()}
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>åœ˜éšŠ</th>
                                <th>æœŸåˆç¾é‡‘</th>
                                <th>æœŸæœ«ç¾é‡‘</th>
                                <th>è²·å…¥æˆæœ¬</th>
                                <th>è³£å‡ºæ”¶å…¥</th>
                                <th>æ»¯éŠ·è²»ç”¨</th>
                                <th>åˆ©æ¯æ”¯å‡º</th>
                                <th>ç•¶æ—¥æç›Š</th>
                                <th>ç´¯ç©æç›Š</th>
                                <th>ROI (%)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.results.forEach((result, index) => {
                const profitClass = result.daily_profit >= 0 ? 'style="color: #52c41a;"' : 'style="color: #ff4d4f;"';
                const roiClass = result.roi >= 0 ? 'style="color: #52c41a;"' : 'style="color: #ff4d4f;"';
                
                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td>${result.team_name || `åœ˜éšŠ${result.username}`}</td>
                        <td>$${(result.starting_cash || 0).toLocaleString()}</td>
                        <td>$${(result.ending_cash || 0).toLocaleString()}</td>
                        <td>$${(result.buy_cost || 0).toLocaleString()}</td>
                        <td>$${(result.sell_revenue || 0).toLocaleString()}</td>
                        <td>$${(result.unsold_fee || 0).toLocaleString()}</td>
                        <td>$${(result.interest_paid || 0).toLocaleString()}</td>
                        <td ${profitClass}>$${(result.daily_profit || 0).toLocaleString()}</td>
                        <td ${profitClass}>$${(result.cumulative_profit || 0).toLocaleString()}</td>
                        <td ${roiClass}>${(result.roi || 0).toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            // Add summary statistics
            const totalRevenue = data.results.reduce((sum, r) => sum + (r.sell_revenue || 0), 0);
            const totalCost = data.results.reduce((sum, r) => sum + (r.buy_cost || 0), 0);
            const totalProfit = data.results.reduce((sum, r) => sum + (r.daily_profit || 0), 0);
            
            html += `
                <div class="card">
                    <h4>å¸‚å ´ç¸½çµ</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #1890ff;">$${totalRevenue.toLocaleString()}</div>
                            <div style="color: #666;">ç¸½è³£å‡ºæ”¶å…¥</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fff7e6; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #fa8c16;">$${totalCost.toLocaleString()}</div>
                            <div style="color: #666;">ç¸½è²·å…¥æˆæœ¬</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: ${totalProfit >= 0 ? '#f6ffed' : '#fff2f0'}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: ${totalProfit >= 0 ? '#52c41a' : '#ff4d4f'};">$${totalProfit.toLocaleString()}</div>
                            <div style="color: #666;">å¸‚å ´ç¸½æç›Š</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #595959;">${data.results.length}</div>
                            <div style="color: #666;">åƒèˆ‡åœ˜éšŠæ•¸</div>
                        </div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        }

        // Load game history
        async function loadGameHistory() {
            const contentDiv = document.getElementById('game-history-content');
            contentDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                const response = await fetch('/api/admin/games/history', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayGameHistory(result.games || result); // Handle both formats
                } else {
                    contentDiv.innerHTML = '<div class="empty-state">âŒ<br>è¼‰å…¥å¤±æ•—</div>';
                }
            } catch (error) {
                console.error('Error loading game history:', error);
                contentDiv.innerHTML = '<div class="empty-state">âŒ<br>è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // Display game history
        function displayGameHistory(games) {
            const contentDiv = document.getElementById('game-history-content');
            
            if (!games || games.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state">ğŸ“‹<br>å°šç„¡éŠæˆ²è¨˜éŒ„</div>';
                return;
            }
            
            let html = `
                <div class="card">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>éŠæˆ² ID</th>
                                <th>éŠæˆ²åç¨±</th>
                                <th>ç‹€æ…‹</th>
                                <th>é€²åº¦</th>
                                <th>åƒèˆ‡çµ„æ•¸</th>
                                <th>å‰µå»ºæ™‚é–“</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            games.forEach(game => {
                const gameId = game.game_id || game.id;
                const statusClass = game.status === 'active' ? 'status-active' : 
                                  game.status === 'completed' ? 'status-completed' : 'status-pending';
                const statusText = game.status === 'active' ? 'é€²è¡Œä¸­' :
                                 game.status === 'completed' ? 'å·²çµæŸ' : 'æº–å‚™ä¸­';
                
                const progress = `${game.current_day || 0}/${game.total_days || 7}`;
                
                html += `
                    <tr>
                        <td>${gameId}</td>
                        <td>${game.name || 'æœªå‘½åéŠæˆ²'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${progress} å¤©</td>
                        <td>${game.num_teams || 12} çµ„</td>
                        <td>${new Date(game.created_at).toLocaleString('zh-TW')}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="viewGameDetails(${gameId})">æŸ¥çœ‹è©³æƒ…</button>
                            ${game.status === 'active' ? 
                              `<button class="btn btn-primary btn-sm" onclick="loadGameInControl(${gameId})">æ§åˆ¶éŠæˆ²</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            contentDiv.innerHTML = html;
        }

        // View game details
        function viewGameDetails(gameId) {
            showAlert('éŠæˆ²è©³æƒ…åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
        }

        // Export game data
        function exportGameData() {
            showAlert('è³‡æ–™åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
        }

        // Utility function to show alerts
        function showAlert(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-error' : 'alert-info';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.textContent = message;
            
            // Insert at the top of current tab
            const currentTab = document.querySelector('.tab-pane.active');
            currentTab.insertBefore(alertDiv, currentTab.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // QR Code Functions
        let qrCodeInstance = null;
        
        async function detectServerIP() {
            try {
                // ä½¿ç”¨ç¾æœ‰çš„ network-info API
                const response = await fetch('/api/network-info');
                
                if (response.ok) {
                    const data = await response.json();
                    // ä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„ IP æˆ–ç•¶å‰ hostname
                    const ip = data.ips && data.ips.length > 0 ? data.ips[0] : window.location.hostname;
                    const port = window.location.port || '3000';
                    return { ip, port };
                }
                
                // å¦‚æœ API å¤±æ•—ï¼Œä½¿ç”¨ç•¶å‰ hostname
                const currentHost = window.location.hostname;
                const currentPort = window.location.port || '3000';
                return { ip: currentHost, port: currentPort };
            } catch (error) {
                console.error('Error detecting server IP:', error);
                // ä½¿ç”¨å‚™ç”¨æ–¹æ³•
                return { ip: getLocalIP(), port: '3000' };
            }
        }
        
        function getLocalIP() {
            // å‚™ç”¨æ–¹æ³•ï¼šè¿”å›å¸¸è¦‹çš„æœ¬åœ° IP ç¯„åœæç¤º
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return '192.168.x.x'; // æç¤ºç”¨æˆ¶éœ€è¦æ‰‹å‹•è¼¸å…¥
            }
            return hostname;
        }
        
        async function generateQRCode() {
            try {
                // ç²å–ä¼ºæœå™¨ IP
                const serverInfo = await detectServerIP();
                const serverIP = serverInfo.ip;
                const serverPort = serverInfo.port;
                
                // ç”Ÿæˆå­¸ç”Ÿç™»å…¥ URL
                const studentURL = `http://${serverIP}:${serverPort}/login.html`;
                
                // æ›´æ–°é¡¯ç¤º
                document.getElementById('server-ip').textContent = `${serverIP}:${serverPort}`;
                document.getElementById('student-url').textContent = studentURL;
                
                // æ¸…é™¤èˆŠçš„ QR Code
                const container = document.getElementById('qrcode-container');
                container.innerHTML = '';
                
                // ç”Ÿæˆæ–°çš„ QR Code
                if (typeof QRCode !== 'undefined') {
                    qrCodeInstance = new QRCode(container, {
                        text: studentURL,
                        width: 256,
                        height: 256,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel && QRCode.CorrectLevel.H ? QRCode.CorrectLevel.H : 2
                    });
                } else {
                    // Fallback: é¡¯ç¤ºæ–‡å­—é€£çµ
                    container.innerHTML = `
                        <div style="padding: 20px; border: 2px dashed #ccc; border-radius: 10px;">
                            <p style="margin-bottom: 10px;">QR Code è¼‰å…¥å¤±æ•—ï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹é€£çµï¼š</p>
                            <p style="font-size: 18px; color: #1890ff; word-break: break-all;">${studentURL}</p>
                        </div>
                    `;
                }
                
                // å¦‚æœ IP æ˜¯æç¤ºæ–‡å­—ï¼Œé¡¯ç¤ºè­¦å‘Š
                if (serverIP === '192.168.x.x') {
                    showError('ç„¡æ³•è‡ªå‹•åµæ¸¬ IPï¼Œè«‹æ‰‹å‹•ç¢ºèªä¼ºæœå™¨å¯¦éš› IP ä½å€');
                }
            } catch (error) {
                console.error('Error generating QR Code:', error);
                showError('ç”Ÿæˆ QR Code å¤±æ•—ï¼š' + error.message);
            }
        }
        
        function refreshQRCode() {
            generateQRCode();
        }
        
        function downloadQRCode() {
            const container = document.getElementById('qrcode-container');
            const canvas = container.querySelector('canvas');
            
            if (canvas) {
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const link = document.createElement('a');
                link.download = `fishmarket-qrcode-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } else {
                showError('è«‹å…ˆç”Ÿæˆ QR Code');
            }
        }
        
        // Modify switchTab to handle QR Code tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabId) {
            originalSwitchTab(tabId);
            
            // Generate QR Code when switching to that tab
            if (tabId === 'qr-code') {
                generateQRCode();
            }
        };

        // Logout function
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—?')) {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }

        // Reset all passwords function
        async function resetAllPasswords() {
            if (!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç”¨æˆ¶å¯†ç¢¼å—?\n\né‡ç½®å¾Œ:\n- Admin å¯†ç¢¼: admin\n- å­¸ç”Ÿå¯†ç¢¼: å„è‡ªçš„ç”¨æˆ¶å(01, 02, 03...)\n- æ‰€æœ‰å°çµ„åç¨±å°‡è¢«æ¸…ç©º')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/admin/reset-all-passwords', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'é‡ç½®å¯†ç¢¼å¤±æ•—');
                }

                alert('âœ… ' + data.message + '\n\nAdmin å¯†ç¢¼: admin\nå­¸ç”Ÿå¯†ç¢¼: å„è‡ªçš„ç”¨æˆ¶å');
                console.log('é‡ç½®è©³æƒ…:', data.details);
            } catch (error) {
                console.error('é‡ç½®å¯†ç¢¼éŒ¯èª¤:', error);
                alert('âŒ é‡ç½®å¯†ç¢¼å¤±æ•—: ' + error.message);
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Load game history by default
            loadGameHistory();
        });
    </script>
</body>
</html>