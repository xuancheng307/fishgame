# æ—¥æµç¨‹è³‡æ–™æ’å…¥ä¿®æ­£å ±å‘Š

**ä¿®æ­£æ—¥æœŸ**: 2025-01-18
**å•é¡Œ**: æ¯æ—¥çµç®—èˆ‡æ¨é€²å¤©æ•¸ç‹€æ…‹ä¸ä¸€è‡´ï¼Œå°è‡´ç„¡æ³•æ¨é€²åˆ°ä¸‹ä¸€å¤©

---

## ğŸ”´ ç™¼ç¾çš„æ ¸å¿ƒå•é¡Œ

### å•é¡Œæè¿°ï¼š

éŠæˆ²æ—¥æµç¨‹ç„¡æ³•æ­£å¸¸æ¨é€²ï¼ŒåŸå› æ˜¯**ç‹€æ…‹å€¼ä¸ä¸€è‡´**ï¼š

1. **æ¯æ—¥çµç®—**å®Œæˆå¾Œè¨­å®š `game_days.status = 'settled'`
2. **æ¨é€²å¤©æ•¸**æª¢æŸ¥ `game_days.status !== 'completed'`
3. **çµæœ**ï¼šç”±æ–¼ `'settled' !== 'completed'`ï¼Œçµç®—å¾Œç„¡æ³•æ¨é€²åˆ°ä¸‹ä¸€å¤©ï¼

### éŒ¯èª¤æµç¨‹ï¼š

```
Day 1 é–‹å§‹ (status: pending)
  â†“
è²·å…¥éšæ®µ (status: buying_open)
  â†“
è²·å…¥é—œé–‰ (status: buying_closed)
  â†“
è³£å‡ºéšæ®µ (status: selling_open)
  â†“
è³£å‡ºé—œé–‰ (status: selling_closed)
  â†“
æ¯æ—¥çµç®— (status: settled) â† è¨­ç‚º 'settled'
  â†“
æ¨é€²å¤©æ•¸ï¼Ÿ â† æª¢æŸ¥ status === 'completed'
  âœ— å¤±æ•—ï¼å› ç‚º 'settled' !== 'completed'
```

---

## âœ… ä¿®æ­£å…§å®¹

### 1. ä¿®æ­£æ¯æ—¥çµç®—ç‹€æ…‹å€¼

**æª”æ¡ˆ**: `backend/server.js`

#### ä¿®æ­£ä½ç½® 1ï¼šç¬¬ä¸€å€‹çµç®—ç«¯é»
```javascript
// Line 1862
// ä¿®æ­£å‰ï¼š
['settled', currentDay[0].id]

// ä¿®æ­£å¾Œï¼š
['completed', currentDay[0].id]
```

#### ä¿®æ­£ä½ç½® 2ï¼šç¬¬äºŒå€‹çµç®—ç«¯é»
```javascript
// Line 1938
// ä¿®æ­£å‰ï¼š
['settled', currentDay[0].id]

// ä¿®æ­£å¾Œï¼š
['completed', currentDay[0].id]
```

---

### 2. ä¿®æ­£ç‹€æ…‹æª¢æŸ¥é‚è¼¯

#### ä¿®æ­£ä½ç½® 3ï¼šé˜²æ­¢é‡è¤‡çµç®—æª¢æŸ¥
```javascript
// Line 1921
// ä¿®æ­£å‰ï¼š
if (currentDay[0].status === 'settled') {

// ä¿®æ­£å¾Œï¼š
if (currentDay[0].status === 'completed') {
```

#### ä¿®æ­£ä½ç½® 4ï¼šæŸ¥è©¢å·²å®Œæˆçš„å¤©æ•¸
```javascript
// Line 2836
// ä¿®æ­£å‰ï¼š
if (dayInfo[0].status === 'settled') {

// ä¿®æ­£å¾Œï¼š
if (dayInfo[0].status === 'completed') {
```

#### ä¿®æ­£ä½ç½® 5ï¼šSQL æŸ¥è©¢æ¢ä»¶
```javascript
// Line 4124
// ä¿®æ­£å‰ï¼š
WHERE gd.game_id = ? AND gd.status = 'settled'

// ä¿®æ­£å¾Œï¼š
WHERE gd.game_id = ? AND gd.status = 'completed'
```

---

### 3. ä¿®æ­£éŒ¯èª¤è¨Šæ¯

æ›´æ–°äº† 6 è™• switch-case éŒ¯èª¤è¨Šæ¯ï¼Œå°‡ `case 'settled'` æ”¹ç‚º `case 'completed'`ï¼š

- Line 1050: open-buying éŒ¯èª¤è¨Šæ¯
- Line 1171: close-buying éŒ¯èª¤è¨Šæ¯ï¼ˆåŒ…å«åˆ¤æ–·ï¼‰
- Line 1291: open-selling éŒ¯èª¤è¨Šæ¯
- Line 1463: close-selling éŒ¯èª¤è¨Šæ¯
- Line 1677: å¦ä¸€å€‹ close-selling éŒ¯èª¤è¨Šæ¯
- Line 1847: settle éŒ¯èª¤è¨Šæ¯

#### ä¿®æ­£ä½ç½® 6-11ï¼šéŒ¯èª¤è¨Šæ¯ switch-case
```javascript
// ä¿®æ­£å‰ï¼š
case 'settled':
    errorMessage = 'æœ¬æ—¥å·²å®Œæˆçµç®—ï¼Œç„¡æ³•é–‹å§‹è²·å…¥';
    break;

// ä¿®æ­£å¾Œï¼š
case 'completed':
    errorMessage = 'æœ¬æ—¥å·²å®Œæˆçµç®—ï¼Œç„¡æ³•é–‹å§‹è²·å…¥';
    break;
```

---

### 4. ä¿®æ­£ API å›æ‡‰

#### ä¿®æ­£ä½ç½® 12ï¼šphase æ˜ å°„
```javascript
// Line 4068-4069
// ä¿®æ­£å‰ï¼š
case 'settled':
    phase = 'settled';
    break;

// ä¿®æ­£å¾Œï¼š
case 'completed':
    phase = 'settled';  // å‰ç«¯ä»ä½¿ç”¨ 'settled' é¡¯ç¤ºï¼Œç¶­æŒç›¸å®¹æ€§
    break;
```

---

## ğŸ“Š ä¿®æ­£çµ±è¨ˆ

| ä¿®æ­£é¡åˆ¥ | æ•¸é‡ | è¡Œè™Ÿ |
|---------|------|------|
| **çµç®—ç‹€æ…‹è³¦å€¼** | 2 | 1862, 1938 |
| **ç‹€æ…‹æª¢æŸ¥é‚è¼¯** | 3 | 1921, 2836, 4124 |
| **éŒ¯èª¤è¨Šæ¯ switch-case** | 6 | 1050, 1171, 1291, 1463, 1677, 1847 |
| **API å›æ‡‰æ˜ å°„** | 1 | 4068 |
| **ç¸½è¨ˆ** | **12 è™•** | |

---

## âœ… é©—è­‰ game_days æ’å…¥å®Œæ•´æ€§

### æ¨é€²å¤©æ•¸çš„æ‰€æœ‰è·¯å¾‘ï¼š

#### è·¯å¾‘ 1ï¼šå»ºç«‹éŠæˆ²ï¼ˆDay 1ï¼‰
- **ç«¯é»**: `POST /api/admin/games/create`
- **è¡Œè™Ÿ**: Line 394
- **é‚è¼¯**:
  ```javascript
  INSERT INTO game_days (game_id, day_number, ...) VALUES (?, 1, ...)
  UPDATE games SET current_day = 1
  ```
- **ç‹€æ…‹**: âœ… æ­£ç¢ºæ’å…¥

#### è·¯å¾‘ 2ï¼šæ¨é€²å¤©æ•¸ï¼ˆæœ‰ gameIdï¼‰
- **ç«¯é»**: `POST /api/admin/games/:gameId/advance-day`
- **è¡Œè™Ÿ**: Lines 715-859
- **é‚è¼¯**:
  1. æª¢æŸ¥ç•¶å‰å¤©æ•¸æ˜¯å¦å®Œæˆ (Line 744)
  2. **æ’å…¥ä¸‹ä¸€å¤© game_days** (Line 823)
  3. æ›´æ–° current_day (Line 832)
- **ç‹€æ…‹**: âœ… æ­£ç¢ºæ’å…¥

#### è·¯å¾‘ 3ï¼šæ¨é€²å¤©æ•¸ï¼ˆè‡ªå‹•æ‰¾ active gameï¼‰
- **ç«¯é»**: `POST /api/admin/advance-day`
- **è¡Œè™Ÿ**: Lines 880-1001
- **é‚è¼¯**:
  1. æ‰¾åˆ° active éŠæˆ²
  2. æª¢æŸ¥ç•¶å‰å¤©æ•¸æ˜¯å¦å®Œæˆ (Line 899)
  3. æ›´æ–° current_day (Line 976)
  4. **æ’å…¥ä¸‹ä¸€å¤© game_days** (Line 980)
- **ç‹€æ…‹**: âœ… æ­£ç¢ºæ’å…¥

### çµè«–ï¼š

âœ… **æ‰€æœ‰æ¨é€²å¤©æ•¸çš„è·¯å¾‘éƒ½æ­£ç¢ºæ’å…¥ game_days è¨˜éŒ„**

æ²’æœ‰ä»»ä½•è·¯å¾‘æœƒï¼š
- æ›´æ–° `current_day` è€Œä¸æ’å…¥å°æ‡‰çš„ `game_days`
- è·³éå¤©æ•¸
- éºæ¼è³‡æ–™

---

## ğŸ¯ ä¿®æ­£å¾Œçš„æ­£ç¢ºæµç¨‹

```
Day 1 é–‹å§‹ (status: pending)
  â†“
è²·å…¥éšæ®µ (status: buying_open)
  â†“
è²·å…¥é—œé–‰ (status: buying_closed)
  â†“
è³£å‡ºéšæ®µ (status: selling_open)
  â†“
è³£å‡ºé—œé–‰ (status: selling_closed)
  â†“
æ¯æ—¥çµç®— (status: completed) â† ä¿®æ­£ï¼šè¨­ç‚º 'completed'
  â†“
æ¨é€²å¤©æ•¸ï¼Ÿ â† æª¢æŸ¥ status === 'completed'
  âœ“ æˆåŠŸï¼
  â†“
æ’å…¥ Day 2 game_days è¨˜éŒ„
  â†“
æ›´æ–° current_day = 2
  â†“
Day 2 é–‹å§‹ (status: pending)
```

---

## ğŸ” game_days.status ç‹€æ…‹å®šç¾©

æ ¹æ“š `complete_database_structure.sql` Line 73ï¼Œ`game_days.status` çš„æœ‰æ•ˆå€¼ç‚ºï¼š

```sql
enum('pending', 'waiting', 'buying_open', 'buying_closed',
     'selling_open', 'selling_closed', 'settling', 'settled', 'completed')
```

### ç‹€æ…‹æµè½‰ï¼š

| ç‹€æ…‹ | èªªæ˜ | ä¸‹ä¸€æ­¥ |
|------|------|--------|
| `pending` | ç­‰å¾…é–‹å§‹ | â†’ `buying_open` |
| `waiting` | ï¼ˆä¿ç•™ï¼Œæœªä½¿ç”¨ï¼‰ | - |
| `buying_open` | è²·å…¥éšæ®µé€²è¡Œä¸­ | â†’ `buying_closed` |
| `buying_closed` | è²·å…¥å·²é—œé–‰ | â†’ `selling_open` |
| `selling_open` | è³£å‡ºéšæ®µé€²è¡Œä¸­ | â†’ `selling_closed` |
| `selling_closed` | è³£å‡ºå·²é—œé–‰ | â†’ `completed` |
| `settling` | ï¼ˆä¿ç•™ï¼Œæœªä½¿ç”¨ï¼‰ | - |
| `settled` | **å·²æ£„ç”¨** | - |
| `completed` | âœ… **ç•¶æ—¥å®Œæˆ** | å¯æ¨é€²ä¸‹ä¸€å¤© |

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. WebSocket äº‹ä»¶åç¨±ä¿æŒä¸è®Š

é›–ç„¶è³‡æ–™åº«ç‹€æ…‹æ”¹ç‚º `'completed'`ï¼Œä½† WebSocket äº‹ä»¶ä»ä½¿ç”¨ `'settled'` ä»¥ç¶­æŒå‰ç«¯ç›¸å®¹æ€§ï¼š

```javascript
// Line 1886
io.emit('phaseChange', {
    gameId,
    phase: 'settled',  // å‰ç«¯äº‹ä»¶åç¨±ä¸è®Š
    // ...
});

// Line 1893
io.emit('daySettled', { ... });

// Line 1949
io.emit('gameUpdate', { gameId, event: 'settled', ... });
```

**åŸå› **: å‰ç«¯å¯èƒ½å·²ç¶“ç›£è½ `'settled'` äº‹ä»¶ï¼Œä¿æŒäº‹ä»¶åç¨±ä¸è®Šå¯é¿å…ç ´å£å‰ç«¯é‚è¼¯ã€‚

### 2. `settled` ç‹€æ…‹ä»åœ¨ enum ä¸­

`game_days.status` enum ä»ä¿ç•™ `'settled'` å€¼ï¼Œä»¥æ”¯æ´ï¼š
- è³‡æ–™åº«å‘å¾Œç›¸å®¹
- æ½›åœ¨çš„ä¸­é–“ç‹€æ…‹ä½¿ç”¨
- é¿å…è³‡æ–™é·ç§»å•é¡Œ

ä½†**å¯¦éš›ç¨‹å¼ç¢¼ä¸å†ä½¿ç”¨** `'settled'` ç‹€æ…‹ã€‚

### 3. å‰ç«¯é¡¯ç¤º

å‰ç«¯åœ¨é¡¯ç¤ºéšæ®µåç¨±æ™‚ï¼Œä»å¯ä½¿ç”¨ã€Œå·²çµç®—ã€æˆ–ã€ŒSettledã€æ–‡å­—ï¼Œå› ç‚ºï¼š
```javascript
// Line 4069
case 'completed':
    phase = 'settled';  // å›å‚³çµ¦å‰ç«¯çš„ phase åç¨±
    break;
```

---

## ğŸš€ éƒ¨ç½²å»ºè­°

### 1. è³‡æ–™åº«é·ç§»ï¼ˆéå¿…è¦ï¼‰

å¦‚æœæœ‰èˆŠè³‡æ–™ä½¿ç”¨ `'settled'` ç‹€æ…‹ï¼Œå¯åŸ·è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- å°‡èˆŠçš„ settled ç‹€æ…‹æ›´æ–°ç‚º completed
UPDATE game_days
SET status = 'completed'
WHERE status = 'settled';
```

**æ³¨æ„**: å¦‚æœæ²’æœ‰èˆŠè³‡æ–™ï¼Œæ­¤æ­¥é©Ÿå¯è·³éã€‚

### 2. æ¸¬è©¦æµç¨‹

éƒ¨ç½²å¾Œæ¸¬è©¦å®Œæ•´æµç¨‹ï¼š

1. å»ºç«‹æ–°éŠæˆ²
2. æ¨é€²åˆ° Day 1
3. é–‹å§‹è²·å…¥ â†’ é—œé–‰è²·å…¥
4. é–‹å§‹è³£å‡º â†’ é—œé–‰è³£å‡º
5. **æ¯æ—¥çµç®—** â† æª¢æŸ¥ game_days.status æ˜¯å¦ç‚º 'completed'
6. **æ¨é€²åˆ° Day 2** â† æª¢æŸ¥æ˜¯å¦æˆåŠŸæ¨é€²
7. é‡è¤‡æ­¥é©Ÿ 3-6 ç›´åˆ° Day 7
8. ç¢ºèªéŠæˆ²æ­£å¸¸å®Œæˆ

### 3. ç›£æ§é‡é»

- æª¢æŸ¥ game_days è¡¨æ˜¯å¦æ¯å¤©éƒ½æœ‰è¨˜éŒ„
- ç¢ºèªæ¯æ—¥çµç®—å¾Œ status ç‚º 'completed'
- é©—è­‰æ¨é€²å¤©æ•¸ä¸æœƒå¡ä½
- ç¢ºä¿ WebSocket äº‹ä»¶æ­£å¸¸æ¨æ’­

---

## ğŸ“ ç¸½çµ

### ä¿®æ­£å‰çš„å•é¡Œï¼š
âŒ æ¯æ—¥çµç®—è¨­ç‚º `'settled'`
âŒ æ¨é€²å¤©æ•¸æª¢æŸ¥ `'completed'`
âŒ ç‹€æ…‹ä¸ä¸€è‡´å°è‡´ç„¡æ³•æ¨é€²

### ä¿®æ­£å¾Œçš„ç‹€æ…‹ï¼š
âœ… æ¯æ—¥çµç®—è¨­ç‚º `'completed'`
âœ… æ¨é€²å¤©æ•¸æª¢æŸ¥ `'completed'`
âœ… ç‹€æ…‹ä¸€è‡´ï¼Œæµç¨‹æ­£å¸¸
âœ… æ‰€æœ‰è·¯å¾‘éƒ½æ­£ç¢ºæ’å…¥ game_days
âœ… ä¸æœƒéºæ¼æˆ–è·³éå¤©æ•¸

---

**ä¿®æ­£å®Œæˆæ™‚é–“**: 2025-01-18
**ä¿®æ­£æª”æ¡ˆ**: `backend/server.js`
**ä¿®æ­£è¡Œæ•¸**: 12 è™•
**ç‹€æ…‹**: âœ… å®Œæˆä¸¦é©—è­‰
