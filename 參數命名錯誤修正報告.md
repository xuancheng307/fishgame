# 魚市場遊戲系統 - 參數命名錯誤修正報告

## 檢查日期：2025-09-12

## 資料庫結構基準
根據 `D:\徐景輝\魚市場遊戲3\SQL\fishmarket_game_latest.sql` 的正確資料庫結構進行檢查

## 發現的問題與修正

### 1. ❌ 關鍵問題：todayBids 欄位缺失
**位置**：simple-team.html 第 996-1006 行  
**問題描述**：前端期望從 `/api/team/dashboard` 取得 `todayBids` 欄位，但後端未提供  
**影響**：無法顯示已使用的價位  
**修正方案**：需要在 server.js 的 dashboard API 中加入 todayBids 資料

### 2. ✅ 已修正：current_cash → current_budget
**已修正檔案**：
- admin.html 第 849 行
- simple-team.html 第 374、782 行  
- complete_database_structure.sql 第 84 行

### 3. ✅ 正確：fish_type 使用
**檢查結果**：
- 資料庫使用 `fish_type` (snake_case)
- 後端 API 有容錯機制：`bid.fish_type || bid.fishType`
- bid history API 正確回傳 `fishType` (camelCase)
- 前端正確使用對應格式

### 4. ✅ 正確：命名規範對應
**Dashboard API 回傳格式**：
- financials 物件：使用 camelCase (如 `currentBudget`, `totalLoan`)
- history 陣列：保持 snake_case (如 `cumulative_profit`, `roi`)
- marketInfo 物件：使用 camelCase (如 `fishABudget`, `fishBBudget`)

**前端正確對應**：
- `financials.currentBudget` → 顯示當前預算
- `latestHistory.cumulative_profit` → 顯示累積收益
- `marketInfo.fishABudget` → 顯示A魚餐廳預算

## 需要修正的項目

### 優先級 1 - 功能性錯誤
1. **加入 todayBids 到 dashboard API**
   - 檔案：backend/server.js
   - 位置：/api/team/dashboard 端點（約第 2316 行）
   - 修正：加入查詢當天投標記錄並回傳

### 優先級 2 - 命名一致性（可選）
1. **統一 API 回傳格式**
   - 建議全部使用 camelCase 或全部使用 snake_case
   - 目前混用但有正確對應，不影響功能

## 修正建議程式碼

### 修正 todayBids 問題
在 server.js 的 dashboard API 中加入：

```javascript
// 在 /api/team/dashboard 端點中，約第 2283 行後加入
const [todayBids] = await db.execute(
    `SELECT bid_type, fish_type, price, quantity_submitted 
     FROM bids 
     WHERE team_id = ? AND game_day_id = ?`,
    [req.user.userId, currentDay[0]?.id]
);

// 在回傳的 JSON 中加入（約第 2316 行）
res.json({
    gameInfo: { ... },
    financials: { ... },
    gameRules: { ... },
    marketInfo: { ... },
    history: dailyResults,
    todayBids: todayBids  // 新增這一行
});
```

## 結論
系統整體參數命名對應正確，主要問題是：
1. **todayBids 欄位缺失** - 需要立即修正
2. 命名規範混用但不影響功能 - 可後續優化

## 驗證清單
- [x] current_cash 全部改為 current_budget
- [x] fish_type vs fishType 檢查完成
- [x] API 回傳與前端欄位名稱對應檢查
- [x] snake_case 與 camelCase 混用檢查
- [ ] todayBids 功能修正（待實施）