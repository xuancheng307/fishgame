# 魚市場遊戲 - 完整功能測試計劃

## 測試環境準備

### 前置條件
1. 確保 MySQL 數據庫已啟動
2. 執行 `complete_database_structure.sql` 初始化資料庫
3. 執行 `seed_demo_game.sql` 創建示範遊戲
4. 啟動後端: `node backend/server.js`
5. 訪問前端: `http://localhost:3000`

### 測試帳號
- 管理員: `admin` / `123`
- 學生團隊: `01`-`10` / 對應密碼 `01`-`10`

---

## 1. 核心邏輯測試（自動化）

### 1.1 邏輯單元測試
**執行命令**: `node backend/test-logic.js`

**測試項目**:
- ✅ 滯銷計算：2.5% 固定比例，從最高價分配
- ✅ 利息計算：3% 日複利（不除以100）
- ✅ 資金池邏輯：只減不增，收入不加回
- ✅ ROI 計算：(累積利潤 / 總投資) × 100%

**預期結果**: 所有4項測試通過

---

## 2. 參數可配置性測試

### 2.1 檢查 defaultGameParameters
**位置**: `backend/server.js:26-40`

**必須包含的參數**:
```javascript
{
    initialBudget: 1000000,          // 初始預算
    loanInterestRate: 0.03,          // 貸款利率 3%
    maxLoanRatio: 0.50,              // 最大貸款比例 50%
    unsoldFeePerKg: 10,              // 滯銷費用 $10/kg
    fixedUnsoldRatio: 2.50,          // 固定滯銷比例 2.5%
    distributorFloorPriceA: 100,     // A級魚底價
    targetPriceA: 150,               // A級魚目標價
    distributorFloorPriceB: 100,     // B級魚底價
    targetPriceB: 120,               // B級魚目標價
    numTeams: 10,                    // 參與隊伍數
    totalDays: 7,                    // 遊戲天數
    buyingDuration: 7,               // 買入階段時間(分鐘)
    sellingDuration: 4               // 賣出階段時間(分鐘)
}
```

### 2.2 檢查參數從資料庫讀取（無硬編碼）

**測試點1**: `processSellBids` 函數 (server.js:3445-3450)
```javascript
// ✅ 正確：從資料庫讀取
const [gameInfo] = await connection.execute(
    'SELECT unsold_fee_per_kg, fixed_unsold_ratio FROM games WHERE id = ?',
    [gameDay.game_id]
);
const fixedUnsoldRatio = gameInfo[0].fixed_unsold_ratio || 2.5;
```

**測試點2**: 買入投標檢查 (server.js:2416-2421)
```javascript
// ✅ 正確：從資料庫讀取
const maxLoanRatio = game.max_loan_ratio || 0.5;
const maxTotalLoan = initialBudget * maxLoanRatio;
```

### 2.3 創建遊戲時參數儲存測試

**測試步驟**:
1. 以管理員登入
2. 創建新遊戲
3. 驗證所有參數正確儲存到 `games` 表

**檢查的欄位**:
- `initial_budget`
- `loan_interest_rate`
- `max_loan_ratio` ⭐ 新增
- `unsold_fee_per_kg`
- `fixed_unsold_ratio` ⭐ 新增
- `distributor_floor_price_a`
- `distributor_floor_price_b`
- `target_price_a`
- `target_price_b`
- `num_teams` ⭐ 新增
- `total_days`
- `buying_duration`
- `selling_duration`

---

## 3. A/B 級魚分開處理測試

### 3.1 買入階段分離測試

**測試步驟**:
1. 管理員開啟第1天買入階段
2. 設定 A 級魚供給 1000kg，B 級魚供給 500kg
3. 團隊01 提交：A級魚 $150×100kg, B級魚 $130×50kg
4. 管理員結束買入並處理

**預期結果**:
- A 級魚和 B 級魚各自獨立處理
- 庫存更新：`fish_a_inventory = 100`, `fish_b_inventory = 50`
- 交易記錄分開記錄在 `transactions` 表

**驗證 SQL**:
```sql
SELECT fish_type, SUM(quantity) as total
FROM bids
WHERE game_day_id = 1 AND team_id = 1 AND bid_type = 'buy'
GROUP BY fish_type;
```

### 3.2 賣出階段分離測試

**測試步驟**:
1. 管理員開啟賣出階段
2. 設定 A 級魚預算 $20000, B 級魚預算 $10000
3. 團隊01 提交：A級魚 $180×100kg, B級魚 $150×50kg
4. 管理員結束賣出並處理

**預期結果**:
- A/B 各自計算 2.5% 滯銷
- A 級魚滯銷：100kg × 2.5% = 3kg
- B 級魚滯銷：50kg × 2.5% = 2kg
- 各自獨立匹配餐廳預算

### 3.3 結算階段分離測試

**驗證代碼**: `enhancedDailySettlement` (server.js:3664-3695)

**檢查點**:
```javascript
// ✅ 分開統計
if (bid.fish_type === 'A') {
    fishABought += bid.quantity_fulfilled || 0;
} else {
    fishBBought += bid.quantity_fulfilled || 0;
}

// ✅ 分開計算滯銷
const fishAUnsold = Math.max(0, fishABought - fishASold);
const fishBUnsold = Math.max(0, fishBBought - fishBSold);
```

---

## 4. 投標限制測試

### 4.1 買入投標限制

**合理限制** (不應修改):
1. ✅ 每種魚最多2個不同價格 (server.js:2392)
2. ✅ 投標總額不超過可用資金+可借貸額度 (server.js:2430)
3. ✅ 5秒防重複提交 (server.js:2456)
4. ✅ 必須在 `buying_open` 階段 (server.js:2349)

**測試步驟**:
1. 團隊01 提交 A 級魚 3 個不同價格 → 應拒絕
2. 團隊01 提交超過資金+借貸上限的投標 → 應拒絕
3. 團隊01 快速連續提交2次 → 第2次應拒絕

### 4.2 賣出投標限制

**合理限制** (不應修改):
1. ✅ 每種魚最多2個不同價格 (server.js:2570)
2. ✅ 賣出總量必須等於庫存 (server.js:2600)
3. ✅ 5秒防重複提交 (server.js:2627)
4. ✅ 必須在 `selling_open` 階段 (server.js:2535)

**測試步驟**:
1. 團隊01 庫存 100kg A級魚，但只提交 90kg → 應拒絕
2. 團隊01 提交 110kg (超過庫存) → 應拒絕
3. 團隊01 提交剛好 100kg → 應成功

**設計理由**: 根據遊戲規則，每日庫存歸零，必須全部提交賣出

---

## 5. 滯銷順序測試（銷售前扣除）

### 5.1 滯銷計算時機驗證

**代碼位置**: `processSellBids` (server.js:3466-3576)

**正確流程**:
```
步驟1 (3466-3468): 計算總投標量 × 2.5% = 固定滯銷量
步驟2 (3472-3478): 按價格降序、時間升序排列
步驟3 (3480-3495): 從最高價分配滯銷量 ⭐ 在銷售前
步驟4 (3498-3576): 處理銷售，扣除已分配的滯銷量
```

### 5.2 實際測試案例

**設定**:
- 團隊01: A級魚 $200×100kg (10:00:00)
- 團隊02: A級魚 $200×100kg (10:00:05) ← 晚5秒
- 團隊03: A級魚 $180×200kg (10:00:03)

**計算**:
- 總投標量: 400kg
- 固定滯銷: 400kg × 2.5% = 10kg

**分配順序**:
1. 價格 $200 > $180，先處理 $200
2. 同為 $200，晚投標的團隊02 優先滯銷
3. 團隊02 分配 10kg 滯銷 ✅

**銷售處理**:
```javascript
// server.js:3508-3515
const bidUnsoldQuantity = unsoldAllocation.get(bid.id) || 0;
availableQuantity = bid.quantity_submitted - bidUnsoldQuantity;
// 團隊02: availableQuantity = 100 - 10 = 90kg 可賣
```

---

## 6. 完整遊戲流程測試

### 6.1 第1天完整流程

#### 管理員操作
1. **開始遊戲** → 狀態變為 `active`
2. **開啟第1天** → 創建 `game_days` 記錄
3. **設定魚市供給量**:
   - A級魚: 1000kg
   - B級魚: 800kg
4. **開啟買入階段** → 啟動7分鐘倒數計時
5. 等待學生投標...
6. **結束買入並處理** → 執行 `processBuyBids()`
7. **設定餐廳預算**:
   - A級魚: $180,000
   - B級魚: $120,000
8. **開啟賣出階段** → 啟動4分鐘倒數計時
9. 等待學生投標...
10. **結束賣出並處理** → 執行 `processSellBids()`
11. **執行結算** → 執行 `enhancedDailySettlement()`

#### 學生操作 (團隊01為例)

**買入階段**:
1. 登入團隊01帳號
2. 查看當前資金: $1,000,000
3. 提交買入投標:
   - A級魚: $150×100kg, $140×50kg
   - B級魚: $130×100kg
4. 系統計算總額: $37,000
5. 扣除資金，增加庫存

**賣出階段**:
1. 查看庫存: A級魚 150kg, B級魚 100kg
2. 提交賣出投標:
   - A級魚: $180×100kg, $170×50kg
   - B級魚: $150×100kg
3. 系統計算滯銷:
   - A級魚總投標 150kg → 滯銷 4kg
   - B級魚總投標 100kg → 滯銷 3kg
4. 匹配成交，扣除庫存

**結算階段**:
1. 系統計算每日利潤
2. 計算利息（如有借貸）
3. 扣除滯銷費用
4. 更新累積利潤
5. 庫存歸零

### 6.2 借貸測試

**場景**: 團隊資金不足時自動借貸

**測試步驟**:
1. 團隊01 當前資金: $100,000
2. 提交買入投標總額: $150,000
3. 系統計算借貸需求: $50,000
4. 檢查借貸上限: $1,000,000 × 50% = $500,000 ✅
5. 自動借貸 $50,000
6. 更新 `total_loan` 和 `total_loan_principal`

**結算時利息**:
```javascript
// server.js:3705-3707
const interestIncurred = currentLoan.times(loanInterestRate);
// $50,000 × 0.03 = $1,500
const newTotalLoan = currentLoan.plus(interestIncurred);
// $50,000 + $1,500 = $51,500
```

### 6.3 破產測試

**場景**: 資金+借貸上限仍不足

**測試步驟**:
1. 團隊01 資金: $100,000，已借貸: $500,000（達上限）
2. 提交投標: $200,000
3. 可用資金: $100,000 + ($500,000 - $500,000) = $100,000
4. 投標被拒絕 → 錯誤訊息

---

## 7. 按鈕功能完整測試

### 7.1 管理員介面按鈕

| 按鈕 | 功能 | 測試方法 | 預期結果 |
|------|------|----------|----------|
| **創建遊戲** | 創建新遊戲 | 點擊按鈕，填寫參數 | 新遊戲出現在列表 |
| **開始遊戲** | 啟動遊戲 | 點擊按鈕 | 狀態變為 `active` |
| **開啟第N天** | 開始新的一天 | 點擊按鈕 | 創建 `game_days` 記錄 |
| **設定魚市供給** | 輸入A/B魚供給量 | 輸入數值並提交 | 數據儲存到 `game_days` |
| **開啟買入** | 開啟買入階段 | 點擊按鈕 | 狀態變為 `buying_open`，啟動計時器 |
| **結束買入** | 結束買入階段 | 點擊按鈕 | 狀態變為 `buying_closed` |
| **處理買入投標** | 執行買入匹配 | 點擊按鈕 | 執行 `processBuyBids()`，更新庫存 |
| **設定餐廳預算** | 輸入A/B餐廳預算 | 輸入數值並提交 | 數據儲存到 `game_days` |
| **開啟賣出** | 開啟賣出階段 | 點擊按鈕 | 狀態變為 `selling_open`，啟動計時器 |
| **結束賣出** | 結束賣出階段 | 點擊按鈕 | 狀態變為 `selling_closed` |
| **處理賣出投標** | 執行賣出匹配 | 點擊按鈕 | 執行 `processSellBids()`，計算滯銷 |
| **執行結算** | 每日結算 | 點擊按鈕 | 執行 `enhancedDailySettlement()`，更新利潤 |
| **查看排行榜** | 顯示 ROI 排名 | 點擊按鈕 | 顯示所有團隊排名 |
| **查看投標記錄** | 查看所有投標 | 點擊按鈕 | 顯示 `bids` 表數據 |
| **查看交易記錄** | 查看所有交易 | 點擊按鈕 | 顯示 `transactions` 表數據 |
| **強制結束遊戲** | 提前結束遊戲 | 點擊按鈕 | 計算最終 ROI，狀態變為 `completed` |

### 7.2 學生介面按鈕

| 按鈕 | 功能 | 測試方法 | 預期結果 |
|------|------|----------|----------|
| **登入** | 學生登入 | 輸入帳號密碼 | 顯示團隊資訊 |
| **提交買入投標** | 提交買入標單 | 填寫價格和數量 | 投標儲存到 `bids` 表 |
| **提交賣出投標** | 提交賣出標單 | 填寫價格和數量 | 投標儲存到 `bids` 表 |
| **查看我的狀態** | 查看團隊資料 | 點擊按鈕 | 顯示資金、庫存、借貸 |
| **查看我的投標** | 查看歷史投標 | 點擊按鈕 | 顯示本團隊投標記錄 |
| **查看排行榜** | 查看 ROI 排名 | 點擊按鈕 | 顯示所有團隊排名 |

### 7.3 WebSocket 即時更新測試

**測試項目**:
1. 管理員開啟買入 → 學生介面即時顯示計時器
2. 學生提交投標 → 管理員即時看到投標數量更新
3. 管理員處理投標 → 學生即時看到成交結果
4. 管理員執行結算 → 學生即時看到利潤更新

**測試方法**: 開啟2個瀏覽器視窗（管理員+學生），觀察即時同步

---

## 8. 邊界條件測試

### 8.1 極端數值測試

| 測試項目 | 輸入 | 預期行為 |
|----------|------|----------|
| 投標價格為0 | $0×100kg | 拒絕（價格必須>0） |
| 投標數量為0 | $100×0kg | 拒絕（數量必須>0） |
| 供給量為0 | A級魚 0kg | 所有買入投標失敗 |
| 餐廳預算為0 | $0 | 所有賣出投標失敗 |
| 借貸達到上限 | $500,000 | 無法再借貸 |

### 8.2 併發測試

**場景**: 多個學生同時提交投標

**測試步驟**:
1. 10個團隊同時提交買入投標
2. 檢查資料庫事務是否正確處理
3. 驗證每個投標都正確儲存

---

## 9. 回歸測試清單

執行任何代碼修改後，必須完成以下檢查:

- [ ] `node --check backend/server.js` 語法檢查通過
- [ ] `node backend/test-logic.js` 邏輯測試通過
- [ ] 數據庫 schema 與代碼一致
- [ ] 所有參數從資料庫讀取（無硬編碼）
- [ ] A/B 魚分開處理
- [ ] 滯銷在銷售前計算
- [ ] 資金池只減不增
- [ ] 利息計算正確（3%不除以100）
- [ ] ROI 計算正確
- [ ] 所有按鈕功能正常

---

## 10. 測試報告模板

### 測試結果記錄

**測試日期**: ___________
**測試人員**: ___________
**版本**: ___________

#### 核心邏輯測試
- [ ] 滯銷計算：PASS / FAIL
- [ ] 利息計算：PASS / FAIL
- [ ] 資金池邏輯：PASS / FAIL
- [ ] ROI 計算：PASS / FAIL

#### 參數配置測試
- [ ] 所有參數可調整：PASS / FAIL
- [ ] 無硬編碼值：PASS / FAIL

#### A/B 分離測試
- [ ] 買入分離：PASS / FAIL
- [ ] 賣出分離：PASS / FAIL
- [ ] 結算分離：PASS / FAIL

#### 完整流程測試
- [ ] 第1天流程：PASS / FAIL
- [ ] 借貸功能：PASS / FAIL
- [ ] 結算功能：PASS / FAIL

#### 按鈕功能測試
- [ ] 管理員按鈕：PASS / FAIL
- [ ] 學生按鈕：PASS / FAIL
- [ ] 即時更新：PASS / FAIL

**問題記錄**:
___________________________________________
___________________________________________

**建議改進**:
___________________________________________
___________________________________________

---

## 11. 已知修正項目

### 已完成的修正 ✅

1. **資金池邏輯** (server.js:3550-3558, 3710-3711)
   - 修正：銷售收入不加回資金池
   - 影響：遊戲難度和真實性

2. **滯銷計算** (server.js:3466-3495)
   - 修正：從每筆2.5%改為總量2.5%
   - 影響：滯銷分配公平性

3. **利息計算** (server.js:3624-3625)
   - 修正：移除除以100（0.03已是小數）
   - 影響：利息從$30變為$3000（正確）

4. **狀態檢查** (server.js:739, 894, 3986)
   - 修正：'settled' → 'completed'
   - 影響：可正確進入下一天

5. **參數化配置** (server.js:26-40, 3446, 2417)
   - 修正：添加 maxLoanRatio, fixedUnsoldRatio, numTeams
   - 修正：從資料庫讀取而非硬編碼
   - 影響：所有參數可調整

### 資料庫 Schema 更新 ✅

- 添加 `games.max_loan_ratio` 欄位
- 添加 `games.fixed_unsold_ratio` 欄位
- 添加 `games.num_teams` 欄位
- 完善 `game_days.status` enum
- 添加所有欠缺的欄位

---

## 12. 測試執行順序建議

1. **自動化測試** (5分鐘)
   ```bash
   node --check backend/server.js
   node backend/test-logic.js
   ```

2. **參數配置測試** (10分鐘)
   - 檢查 defaultGameParameters
   - 驗證參數從資料庫讀取
   - 測試創建遊戲

3. **A/B 分離測試** (15分鐘)
   - 買入階段測試
   - 賣出階段測試
   - 結算階段測試

4. **滯銷順序測試** (10分鐘)
   - 3團隊測試案例
   - 驗證分配順序

5. **完整流程測試** (30分鐘)
   - 第1天完整流程
   - 借貸測試
   - 結算測試

6. **按鈕功能測試** (20分鐘)
   - 管理員介面所有按鈕
   - 學生介面所有按鈕
   - WebSocket 即時更新

7. **邊界條件測試** (10分鐘)
   - 極端數值測試
   - 併發測試

**總計測試時間**: 約 100 分鐘

---

## 附錄：測試數據範例

### 範例遊戲設定
```json
{
  "gameName": "測試遊戲",
  "initialBudget": 1000000,
  "loanInterestRate": 0.03,
  "maxLoanRatio": 0.50,
  "unsoldFeePerKg": 10,
  "fixedUnsoldRatio": 2.50,
  "distributorFloorPriceA": 100,
  "distributorFloorPriceB": 80,
  "targetPriceA": 150,
  "targetPriceB": 120,
  "numTeams": 10,
  "totalDays": 7
}
```

### 範例買入投標
```json
{
  "buyBids": [
    {"fish_type": "A", "price": 150, "quantity": 100},
    {"fish_type": "A", "price": 140, "quantity": 50},
    {"fish_type": "B", "price": 130, "quantity": 100}
  ]
}
```

### 範例賣出投標
```json
{
  "sellBids": [
    {"fish_type": "A", "price": 180, "quantity": 100},
    {"fish_type": "A", "price": 170, "quantity": 50},
    {"fish_type": "B", "price": 150, "quantity": 100}
  ]
}
```

---

**文檔版本**: 1.0
**最後更新**: 2025-01-18
**維護人員**: Claude Code
