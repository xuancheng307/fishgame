# Railway è³‡æ–™åº«é·ç§»å ±å‘Š

**åŸ·è¡Œæ—¥æœŸ**: 2025-01-19
**è³‡æ–™åº«**: Railway MySQL (hopper.proxy.rlwy.net:17950)
**ç‹€æ…‹**: âœ… å®Œæˆ

---

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

Railway ç”Ÿç”¢è³‡æ–™åº«åŸæœ¬ä½¿ç”¨èˆŠç‰ˆçµæ§‹ï¼ˆ14å€‹æ¬„ä½ï¼‰ï¼Œç¼ºå°‘æœ€è¿‘æ›´æ–°çš„4å€‹æ¬„ä½ã€‚æœ¬æ¬¡é·ç§»æˆåŠŸæ·»åŠ æ‰€æœ‰ç¼ºå°‘çš„æ¬„ä½ï¼Œç¢ºä¿è³‡æ–™åº«çµæ§‹èˆ‡å¾Œç«¯ç¨‹å¼ç¢¼ä¸€è‡´ã€‚

## âš ï¸ é·ç§»å‰ç‹€æ…‹

### ç¼ºå°‘çš„æ¬„ä½

| æ¬„ä½åç¨± | ç”¨é€” | å½±éŸ¿ |
|---------|------|------|
| `team_names` | éšŠä¼è‡ªè¨‚åç¨± | ç„¡æ³•ä½¿ç”¨è‡ªè¨‚éšŠååŠŸèƒ½ |
| `is_force_ended` | å¼·åˆ¶çµæŸæ¨™è¨˜ | force-end åŠŸèƒ½ç„¡æ³•æ­£å¸¸é‹ä½œ |
| `force_ended_at` | å¼·åˆ¶çµæŸæ™‚é–“ | ç„¡æ³•è¨˜éŒ„å¼·åˆ¶çµæŸæ™‚é–“é» |
| `force_end_day` | å¼·åˆ¶çµæŸå¤©æ•¸ | ç„¡æ³•é¡¯ç¤ºéŠæˆ²åœ¨ç¬¬å¹¾å¤©è¢«å¼·åˆ¶çµæŸ |

### è³‡æ–™åº«åŸå§‹çµæ§‹

```
games è¡¨ (14 å€‹æ¬„ä½):
1. id
2. name
3. description
4. status (enum: pending, active, completed) âœ…
5. phase
6. total_days
7. current_day
8. initial_budget
9. daily_interest_rate
10. max_loan_ratio
11. unsold_fee_per_kg (é è¨­å€¼: 10.00) âœ…
12. fixed_unsold_ratio
13. created_at
14. updated_at
```

---

## ğŸ”§ åŸ·è¡Œçš„é·ç§»

### Migration 001: æ·»åŠ  team_names æ¬„ä½

```sql
ALTER TABLE games
ADD COLUMN team_names json DEFAULT NULL
COMMENT 'éšŠä¼åç¨±æ˜ å°„ {teamId: displayName}';
```

**çµæœ**: âœ… æˆåŠŸæ·»åŠ 

### Migration 002: æ·»åŠ  force-end æ¬„ä½

```sql
ALTER TABLE games
ADD COLUMN is_force_ended BOOLEAN DEFAULT FALSE
COMMENT 'æ˜¯å¦å¼·åˆ¶çµæŸ';

ALTER TABLE games
ADD COLUMN force_ended_at TIMESTAMP NULL
COMMENT 'å¼·åˆ¶çµæŸæ™‚é–“';

ALTER TABLE games
ADD COLUMN force_end_day INT NULL
COMMENT 'å¼·åˆ¶çµæŸæ–¼ç¬¬å¹¾å¤©';
```

**çµæœ**: âœ… ä¸‰å€‹æ¬„ä½å…¨éƒ¨æˆåŠŸæ·»åŠ 

---

## âœ… é·ç§»å¾Œç‹€æ…‹

### å®Œæ•´æ¬„ä½åˆ—è¡¨ (18 å€‹æ¬„ä½)

```
games è¡¨å®Œæ•´çµæ§‹:
æ¬„ä½åç¨±                è³‡æ–™å‹æ…‹                       å¯ç©ºå€¼  é è¨­å€¼
--------------------------------------------------------------------------
id                      int                          NO      NULL
name                    varchar(100)                 NO      NULL
description             text                         YES     NULL
status                  enum('pending','active','completed') NO  pending
phase                   enum('waiting','buying','selling','settling','day_ended') YES waiting
total_days              int                          NO      7
current_day             int                          NO      0
initial_budget          decimal(12,2)                NO      1000000.00
daily_interest_rate     decimal(5,4)                 NO      0.0300
max_loan_ratio          decimal(5,2)                 NO      0.50
unsold_fee_per_kg       decimal(10,2)                NO      10.00 âœ…
fixed_unsold_ratio      decimal(5,2)                 NO      2.50
created_at              timestamp                    NO      CURRENT_TIMESTAMP
updated_at              timestamp                    NO      CURRENT_TIMESTAMP
team_names              json                         YES     NULL âœ… æ–°å¢
is_force_ended          tinyint(1)                   YES     0 âœ… æ–°å¢
force_ended_at          timestamp                    YES     NULL âœ… æ–°å¢
force_end_day           int                          YES     NULL âœ… æ–°å¢
```

### é©—è­‰çµæœ

| æª¢æŸ¥é …ç›® | ç‹€æ…‹ | çµæœ |
|---------|------|------|
| games è¡¨å­˜åœ¨ | âœ… | é€šé |
| team_names æ¬„ä½ | âœ… | å­˜åœ¨ (json) |
| is_force_ended æ¬„ä½ | âœ… | å­˜åœ¨ (tinyint) |
| force_ended_at æ¬„ä½ | âœ… | å­˜åœ¨ (timestamp) |
| force_end_day æ¬„ä½ | âœ… | å­˜åœ¨ (int) |
| unsold_fee_per_kg é è¨­å€¼ | âœ… | 10.00 (æ­£ç¢º) |
| status ENUM å®šç¾© | âœ… | pending, active, completed (æ­£ç¢º) |
| ç¾æœ‰éŠæˆ² | â„¹ï¸ | 1 å€‹éŠæˆ²é€²è¡Œä¸­ |

---

## ğŸ›¡ï¸ å®‰å…¨æ€§æªæ–½

### 1. å°é€²è¡Œä¸­éŠæˆ²çš„å½±éŸ¿

- âœ… **ç„¡å½±éŸ¿**ï¼šæ‰€æœ‰é·ç§»éƒ½æ˜¯ `ADD COLUMN`ï¼Œä¸æœƒä¿®æ”¹æˆ–åˆªé™¤ç¾æœ‰è³‡æ–™
- âœ… **é è¨­å€¼å®‰å…¨**ï¼šæ–°å¢æ¬„ä½éƒ½æœ‰åˆç†çš„é è¨­å€¼ (NULL æˆ– FALSE)
- âœ… **é€²è¡Œä¸­éŠæˆ²**ï¼š1å€‹é€²è¡Œä¸­çš„éŠæˆ²ä¸å—å½±éŸ¿ï¼Œå¯ç¹¼çºŒæ­£å¸¸é‹ä½œ

### 2. é·ç§»è…³æœ¬ç‰¹æ€§

- **å†ªç­‰æ€§ (Idempotent)**ï¼šåŸ·è¡Œå‰æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨ï¼Œå¯é‡è¤‡åŸ·è¡Œ
- **éŒ¯èª¤è™•ç†**ï¼šä½¿ç”¨ try-catch åŒ…è£¹æ‰€æœ‰è³‡æ–™åº«æ“ä½œ
- **é©—è­‰æ©Ÿåˆ¶**ï¼šåŸ·è¡Œå¾Œè‡ªå‹•é©—è­‰æ‰€æœ‰æ¬„ä½æ˜¯å¦æˆåŠŸæ·»åŠ 

---

## ğŸ“ ç›¸é—œæª”æ¡ˆ

### é·ç§»è…³æœ¬

| æª”æ¡ˆ | ç”¨é€” |
|------|------|
| `backend/run_migrations_final.js` | åŸ·è¡Œé·ç§»çš„ Node.js è…³æœ¬ |
| `backend/check_railway_db.js` | æª¢æŸ¥è³‡æ–™åº«çµæ§‹çš„é©—è­‰è…³æœ¬ |
| `backend/check_games_structure.js` | æŸ¥çœ‹ games è¡¨å®Œæ•´çµæ§‹ |

### åŸå§‹é·ç§»æª”æ¡ˆ

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `migrations/001_add_team_names.sql` | æ·»åŠ éšŠä¼åç¨±æ¬„ä½ |
| `migrations/002_add_force_end_fields.sql` | æ·»åŠ å¼·åˆ¶çµæŸç›¸é—œæ¬„ä½ |
| `migrations/004_update_unsold_fee.sql` | æ›´æ–°æ»¯éŠ·è²»é è¨­å€¼ (æœ¬æ¬¡ä¸éœ€åŸ·è¡Œ) |

### é€£ç·šé…ç½®

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `.env.railway` | Railway MySQL é€£ç·šè³‡è¨Š |

---

## ğŸš€ å¾ŒçºŒæ­¥é©Ÿ

### 1. âœ… è³‡æ–™åº«é·ç§»å®Œæˆ

- [x] æ·»åŠ  team_names æ¬„ä½
- [x] æ·»åŠ  is_force_ended æ¬„ä½
- [x] æ·»åŠ  force_ended_at æ¬„ä½
- [x] æ·»åŠ  force_end_day æ¬„ä½
- [x] é©—è­‰æ‰€æœ‰æ¬„ä½å­˜åœ¨
- [x] ç¢ºèªé è¨­å€¼æ­£ç¢º

### 2. â³ å¾Œç«¯ç¨‹å¼ç¢¼éƒ¨ç½² (å¾…åŸ·è¡Œ)

ç›®å‰å¾Œç«¯ç¨‹å¼ç¢¼å·²åœ¨æœ¬åœ°æ›´æ–°ï¼ŒåŒ…å«ï¼š
- æ»¯éŠ·è²»é è¨­å€¼çµ±ä¸€ç‚º 10 å…ƒ/kg
- åˆªé™¤é‡è¤‡çš„ advance-day è·¯å¾‘
- è£œé½Šæ¨é€²å¤©æ•¸çš„å®Œæ•´é‚è¼¯

**éƒ¨ç½²æ–¹å¼**ï¼š
```bash
# 1. æäº¤ä¿®æ”¹åˆ° Git
git add backend/server.js
git commit -m "fix: çµ±ä¸€æ»¯éŠ·è²»é è¨­å€¼èˆ‡å„ªåŒ– advance-day API"

# 2. æ¨é€åˆ° GitHub
git push origin main

# 3. Railway æœƒè‡ªå‹•å¾ GitHub éƒ¨ç½²
```

### 3. â³ åŠŸèƒ½æ¸¬è©¦ (éƒ¨ç½²å¾ŒåŸ·è¡Œ)

æ¸¬è©¦é …ç›®ï¼š
- [ ] æ¸¬è©¦æ¨é€²å¤©æ•¸åŠŸèƒ½ï¼ˆåº«å­˜æ¸…ç©ºã€åˆ©æ¯è¨ˆç®—ï¼‰
- [ ] æ¸¬è©¦å¼·åˆ¶çµæŸåŠŸèƒ½ï¼ˆéœ€è¦æœ‰æ–°æ¬„ä½ï¼‰
- [ ] æ¸¬è©¦éšŠä¼è‡ªè¨‚åç¨±åŠŸèƒ½
- [ ] é©—è­‰æ»¯éŠ·è²»è¨ˆç®—ä½¿ç”¨æ­£ç¢ºé è¨­å€¼

---

## ğŸ“Š æŠ€è¡“ç´°ç¯€

### é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

#### å•é¡Œ 1: `IF NOT EXISTS` èªæ³•ä¸æ”¯æ´

**éŒ¯èª¤è¨Šæ¯**:
```
You have an error in your SQL syntax near 'IF NOT EXISTS'
```

**åŸå› **: Railway MySQL ç‰ˆæœ¬è¼ƒèˆŠï¼Œä¸æ”¯æ´ `ALTER TABLE ADD COLUMN IF NOT EXISTS` èªæ³•

**è§£æ±ºæ–¹æ¡ˆ**:
- æ”¹ç”¨ JavaScript è…³æœ¬å…ˆæŸ¥è©¢æ¬„ä½æ˜¯å¦å­˜åœ¨
- å­˜åœ¨å‰‡è·³éï¼Œä¸å­˜åœ¨æ‰åŸ·è¡Œ ADD COLUMN

#### å•é¡Œ 2: `AFTER num_teams` æ¬„ä½ä¸å­˜åœ¨

**éŒ¯èª¤è¨Šæ¯**:
```
Unknown column 'num_teams' in 'games'
```

**åŸå› **: åŸå§‹é·ç§»æª”æ¡ˆå‡è¨­ `num_teams` æ¬„ä½å­˜åœ¨ï¼Œä½† Railway è³‡æ–™åº«çš„èˆŠçµæ§‹æ²’æœ‰é€™å€‹æ¬„ä½

**è§£æ±ºæ–¹æ¡ˆ**:
- ç§»é™¤ `AFTER num_teams` å­å¥
- ç›´æ¥å°‡æ–°æ¬„ä½æ·»åŠ åˆ°è¡¨æœ«å°¾

---

## ğŸ” é©—è­‰æŒ‡ä»¤

### æª¢æŸ¥è³‡æ–™åº«çµæ§‹

```bash
cd backend
node check_railway_db.js
```

### æŸ¥çœ‹ games è¡¨çµæ§‹

```bash
cd backend
node check_games_structure.js
```

### é‡æ–°åŸ·è¡Œé·ç§» (å®‰å…¨ï¼Œå¯é‡è¤‡åŸ·è¡Œ)

```bash
cd backend
node run_migrations_final.js
```

---

## ğŸ“ æ³¨æ„äº‹é …

1. **è³‡æ–™åº«é€£ç·šè³‡è¨Š** (`.env.railway`) åŒ…å«æ•æ„Ÿè³‡è¨Šï¼Œä¸æ‡‰æäº¤åˆ° Git
2. **é€²è¡Œä¸­çš„éŠæˆ²**ï¼šç›®å‰æœ‰1å€‹éŠæˆ²åœ¨é€²è¡Œï¼Œé·ç§»æœªé€ æˆå½±éŸ¿
3. **å¾Œç«¯éƒ¨ç½²**ï¼šä¿®æ”¹çš„ `server.js` éœ€è¦éƒ¨ç½²åˆ° Railway æ‰æœƒç”Ÿæ•ˆ
4. **å‘ä¸‹ç›¸å®¹**ï¼šæ–°å¢æ¬„ä½éƒ½æ˜¯å¯ç©ºæˆ–æœ‰é è¨­å€¼ï¼ŒèˆŠè³‡æ–™ä¸å—å½±éŸ¿

---

## âœ… çµè«–

Railway è³‡æ–™åº«é·ç§»å·²æˆåŠŸå®Œæˆï¼Œæ‰€æœ‰å¿…è¦æ¬„ä½å·²æ·»åŠ ï¼Œè³‡æ–™åº«çµæ§‹ç¾å·²èˆ‡æœ€æ–°çš„å¾Œç«¯ç¨‹å¼ç¢¼å®Œå…¨ä¸€è‡´ã€‚å¯ä»¥å®‰å…¨åœ°éƒ¨ç½²æ›´æ–°å¾Œçš„å¾Œç«¯ç¨‹å¼ç¢¼ã€‚

**é·ç§»çµ±è¨ˆ**ï¼š
- åŸ·è¡Œé·ç§»æ•¸é‡: 2 å€‹
- æ–°å¢æ¬„ä½æ•¸é‡: 4 å€‹
- å½±éŸ¿çš„è¡¨: 1 å€‹ (games)
- è³‡æ–™éºå¤±: 0
- åœæ©Ÿæ™‚é–“: 0

**è³‡æ–™åº«ç‹€æ…‹**: âœ… å¥åº·ï¼Œå¯æ­£å¸¸é‹ä½œ
