# é­šå¸‚å ´éŠæˆ²å°ˆæ¡ˆä¿®æ­£å®Œæˆå ±å‘Š

## åŸ·è¡Œæ—¥æœŸ
2025-11-18

## ä¿®æ­£æ¦‚è¿°
æ ¹æ“šéŠæˆ²èªªæ˜ï¼ˆéŠæˆ²èªªæ˜.htmlï¼‰ä¸­çš„å®Œæ•´è¦æ ¼ï¼Œå°å°ˆæ¡ˆé€²è¡Œå…¨é¢æª¢æŸ¥å’Œä¿®æ­£ï¼Œç¢ºä¿éŠæˆ²é‚è¼¯ç¬¦åˆè¨­è¨ˆè¦ç¯„ã€‚

---

## ğŸ”´ é‡å¤§ä¿®æ­£ï¼ˆCRITICAL FIXESï¼‰

### 1. **è³‡é‡‘æ± é‚è¼¯ä¿®æ­£** â­ æœ€é‡è¦
**å•é¡Œï¼š** åŸç¨‹å¼ç¢¼ä¸­ï¼Œè³£å‡ºé­šè²¨çš„æ”¶å…¥æœƒåŠ å›åˆ°åœ˜éšŠçš„è³‡é‡‘æ± ï¼ˆcurrent_budgetï¼‰ï¼Œé€™é•åäº†éŠæˆ²è¦å‰‡ã€‚

**éŠæˆ²è¦å‰‡ï¼ˆéŠæˆ²èªªæ˜.htmlï¼‰ï¼š**
> "âš ï¸ é‡è¦ï¼šè³‡é‡‘æ± åªæ¸›ä¸å¢"
> "è³£å‡ºé­šè²¨çš„æ”¶å…¥ä¸æœƒåŠ å›è³‡é‡‘æ± "
> "è³‡é‡‘æ± åªæœƒå› ç‚ºè²·å…¥æˆæœ¬ã€æ»¯éŠ·è²»ã€åˆ©æ¯è€Œæ¸›å°‘"

**ä¿®æ­£å…§å®¹ï¼š**

#### æª”æ¡ˆï¼š`backend/server.js`

**ä¿®æ­£1ï¼šprocessSellBids å‡½æ•¸ (ç´„ç¬¬ 3540 è¡Œ)**
```javascript
// ä¿®æ­£å‰ï¼š
UPDATE game_participants
SET current_budget = current_budget + ?, // âŒ éŒ¯èª¤ï¼šåŠ å›æ”¶å…¥
    fish_a_inventory = fish_a_inventory - ?

// ä¿®æ­£å¾Œï¼š
UPDATE game_participants
SET fish_a_inventory = fish_a_inventory - ? // âœ… æ­£ç¢ºï¼šåªæ‰£åº«å­˜ï¼Œä¸åŠ æ”¶å…¥
```

**ä¿®æ­£2ï¼šenhancedDailySettlement å‡½æ•¸ (ç´„ç¬¬ 3698 è¡Œ)**
```javascript
// ä¿®æ­£å‰ï¼š
let newBudget = currentBudget.plus(totalRevenue).minus(totalCost).minus(unsoldFee).minus(interestIncurred);
// âŒ éŒ¯èª¤ï¼šåŠ ä¸ŠéŠ·å”®æ”¶å…¥

// ä¿®æ­£å¾Œï¼š
let newBudget = currentBudget.minus(unsoldFee).minus(interestIncurred);
// âœ… æ­£ç¢ºï¼šåªæ‰£é™¤æ»¯éŠ·è²»å’Œåˆ©æ¯ï¼Œä¸åŠ æ”¶å…¥ï¼Œä¸æ‰£æˆæœ¬ï¼ˆæˆæœ¬å·²åœ¨è²·å…¥æ™‚æ‰£é™¤ï¼‰
```

**å½±éŸ¿ï¼š**
- ç¾åœ¨è³‡é‡‘æ± æœƒæŒçºŒæ¸›å°‘ï¼Œæ¨¡æ“¬çœŸå¯¦å•†æ¥­ç’°å¢ƒçš„ç¾é‡‘æµç®¡ç†
- åœ˜éšŠå¿…é ˆæ›´è¬¹æ…åœ°ç®¡ç†è³‡é‡‘
- ROI è¨ˆç®—æœƒæ›´æº–ç¢ºåæ˜ æŠ•è³‡æ•ˆç‡

---

## ğŸ“Š è³‡æ–™åº«çµæ§‹ä¿®æ­£

### 2. **games è¡¨æ–°å¢æ¬„ä½**
**å•é¡Œï¼š** server.js ç¨‹å¼ç¢¼å¼•ç”¨äº†è³‡æ–™åº«ä¸­ä¸å­˜åœ¨çš„æ¬„ä½

**æ–°å¢æ¬„ä½ï¼š**
```sql
`num_teams` int(11) DEFAULT 10 COMMENT 'åƒèˆ‡éšŠä¼æ•¸é‡'
`loan_interest_rate` decimal(5,4) DEFAULT 0.0300 COMMENT 'è²¸æ¬¾åˆ©ç‡(å…¼å®¹æ¬„ä½)'
`distributor_floor_price_a` decimal(10,2) DEFAULT 100.00 COMMENT 'Aç´šé­šç¸½ä»£ç†åº•åƒ¹'
`distributor_floor_price_b` decimal(10,2) DEFAULT 80.00 COMMENT 'Bç´šé­šç¸½ä»£ç†åº•åƒ¹'
`target_price_a` decimal(10,2) DEFAULT 150.00 COMMENT 'Aç´šé­šç›®æ¨™åƒ¹æ ¼'
`target_price_b` decimal(10,2) DEFAULT 120.00 COMMENT 'Bç´šé­šç›®æ¨™åƒ¹æ ¼'
`buying_duration` int(11) DEFAULT 7 COMMENT 'è²·å…¥éšæ®µæ™‚é–“(åˆ†é˜)'
`selling_duration` int(11) DEFAULT 4 COMMENT 'è³£å‡ºéšæ®µæ™‚é–“(åˆ†é˜)'
```

**ä¿®æ­£æª”æ¡ˆï¼š** `complete_database_structure.sql`

---

### 3. **transactions è¡¨æ–°å¢æ¬„ä½**
**å•é¡Œï¼š** INSERT èªå¥ä½¿ç”¨çš„æ¬„ä½åç¨±èˆ‡è³‡æ–™åº«å®šç¾©ä¸ä¸€è‡´

**æ–°å¢æ¬„ä½ï¼š**
```sql
`game_id` int(11) NOT NULL
`day_number` int(11) NOT NULL
`price` decimal(10,2) DEFAULT NULL COMMENT 'å–®åƒ¹'
```

**ä¿®æ­£æª”æ¡ˆï¼š** `complete_database_structure.sql`

---

### 4. **daily_results è¡¨æ–°å¢æ¬„ä½**
**å•é¡Œï¼š** ç¨‹å¼ç¢¼ä½¿ç”¨çš„æ¬„ä½åç¨±èˆ‡è³‡æ–™åº«å®šç¾©ä¸ä¸€è‡´

**æ–°å¢æ¬„ä½ï¼š**
```sql
`game_id` int(11) NOT NULL
`closing_budget` decimal(12,2) DEFAULT 0.00 COMMENT 'çµç®—å¾Œé ç®—(å…¼å®¹æ¬„ä½)'
`closing_loan` decimal(12,2) DEFAULT 0.00 COMMENT 'çµç®—å¾Œè²¸æ¬¾(å…¼å®¹æ¬„ä½)'
`cost` decimal(12,2) DEFAULT 0.00 COMMENT 'æˆæœ¬(å…¼å®¹æ¬„ä½)'
`revenue` decimal(12,2) DEFAULT 0.00 COMMENT 'æ”¶å…¥(å…¼å®¹æ¬„ä½)'
`interest_incurred` decimal(12,2) DEFAULT 0.00 COMMENT 'åˆ©æ¯æ”¯å‡º(å…¼å®¹æ¬„ä½)'
```

**ä¿®æ­£æª”æ¡ˆï¼š** `complete_database_structure.sql`

---

## ğŸ—‚ï¸ ç¨®å­è³‡æ–™ä¿®æ­£

### 5. **seed_demo_game.sql æ›´æ–°**
**ä¿®æ­£ï¼š** æ›´æ–°ç¤ºç¯„éŠæˆ²çš„ INSERT èªå¥ï¼ŒåŒ…å«æ‰€æœ‰æ–°å¢çš„æ¬„ä½

**æ–°å¢åƒæ•¸ï¼š**
- num_teams = 10
- distributor_floor_price_a = 100.00
- distributor_floor_price_b = 80.00
- target_price_a = 150.00
- target_price_b = 120.00
- buying_duration = 7 (åˆ†é˜)
- selling_duration = 4 (åˆ†é˜)

**ä¿®æ­£æª”æ¡ˆï¼š** `seed_demo_game.sql`

---

## âœ… å·²ç¢ºèªæ­£ç¢ºçš„åŠŸèƒ½

### 6. **è²·å…¥æŠ•æ¨™é‚è¼¯**
âœ… æ¯ç¨®é­šæœ€å¤š 2 å€‹ä¸åŒåƒ¹æ ¼çš„æŠ•æ¨™ï¼ˆserver.js ç¬¬ 2391-2395 è¡Œï¼‰
âœ… è³‡é‡‘æª¢æŸ¥ï¼šç¸½å‡ºåƒ¹ä¸è¶…é ç¾é‡‘ + å‰©é¤˜å€Ÿè²¸é¡åº¦
âœ… æˆäº¤åˆ†é…ï¼šåƒ¹æ ¼ç”±é«˜åˆ°ä½åˆ†é…ä¾›æ‡‰é‡
âœ… è‡ªå‹•å€Ÿè²¸ï¼šæˆäº¤é‡‘é¡è¶…éç¾é‡‘æ™‚è‡ªå‹•å€Ÿè²¸

### 7. **è³£å‡ºæŠ•æ¨™é‚è¼¯**
âœ… å›ºå®šæ»¯éŠ·æ©Ÿåˆ¶ï¼šå…¨éƒ¨æˆäº¤é‡çš„ 2.5% æœ€è²´çš„éƒ¨åˆ†æœƒæ»¯éŠ·ï¼ˆserver.js ç¬¬ 3446 è¡Œï¼‰
âœ… åŒåƒ¹æ ¼è™•ç†ï¼šæ™šæŠ•æ¨™è€…å„ªå…ˆæ»¯éŠ·ï¼ˆé¼“å‹µæ—©æŠ•æ¨™ï¼‰
âœ… æˆäº¤åˆ†é…ï¼šåƒ¹æ ¼ç”±ä½åˆ°é«˜æˆäº¤ï¼Œç›´åˆ°é¤å»³é ç®—ç”¨å®Œ
âœ… æ»¯éŠ·è²»ï¼šæ¯å…¬æ–¤ $10

### 8. **æ¯æ—¥çµç®—é‚è¼¯**
âœ… åˆ©æ¯è¨ˆç®—ï¼š3% è¤‡åˆ©ï¼ˆserver.js ç¬¬ 3694 è¡Œï¼‰
```javascript
const interestIncurred = currentLoan.times(loanInterestRate);
const newTotalLoan = currentLoan.plus(interestIncurred);
```

âœ… ROI è¨ˆç®—ï¼ˆserver.js ç¬¬ 3735-3740 è¡Œï¼‰
```javascript
// ROI = (ç´¯ç©åˆ©æ½¤ / ç¸½æŠ•è³‡é‡‘é¡) Ã— 100%
// ç¸½æŠ•è³‡é‡‘é¡ = åˆå§‹è³‡é‡‘ + ç¸½å€Ÿè²¸æœ¬é‡‘
const totalInvestment = initialBudget.plus(newLoanPrincipal);
roi = cumulativeProfit.dividedBy(totalInvestment).times(100);
```

âœ… åº«å­˜æ¸…é›¶ï¼šæ¯æ—¥çµæŸå¾Œæ‰€æœ‰åº«å­˜è‡ªå‹•æ¸…é›¶ï¼ˆserver.js ç¬¬ 3689-3691 è¡Œï¼‰
âœ… æ»¯éŠ·è²»è¨ˆç®—ï¼šæœªå”®å‡ºæ•¸é‡ Ã— $10/kg

---

## ğŸ“‹ éœ€è¦åŸ·è¡Œçš„éƒ¨ç½²æ­¥é©Ÿ

### æ–¹æ³•ä¸€ï¼šé‡æ–°å»ºç«‹è³‡æ–™åº«ï¼ˆæ¨è–¦ï¼‰
```bash
# 1. é€£æ¥åˆ° Railway MySQL
# 2. åˆªé™¤èˆŠè³‡æ–™åº«ä¸¦é‡æ–°å»ºç«‹
DROP DATABASE IF EXISTS fishmarket_game;
SOURCE complete_database_structure.sql;
SOURCE seed_users.sql;
SOURCE seed_demo_game.sql;
```

### æ–¹æ³•äºŒï¼šåŸ·è¡Œ ALTER TABLE èªå¥
å¦‚æœä¸æƒ³åˆªé™¤ç¾æœ‰è³‡æ–™ï¼Œå¯ä»¥åŸ·è¡Œä»¥ä¸‹ SQL èªå¥æ›´æ–°è¡¨çµæ§‹ï¼š

```sql
-- æ›´æ–° games è¡¨
ALTER TABLE games
ADD COLUMN num_teams int(11) DEFAULT 10 COMMENT 'åƒèˆ‡éšŠä¼æ•¸é‡' AFTER current_day,
ADD COLUMN loan_interest_rate decimal(5,4) DEFAULT 0.0300 COMMENT 'è²¸æ¬¾åˆ©ç‡' AFTER daily_interest_rate,
ADD COLUMN distributor_floor_price_a decimal(10,2) DEFAULT 100.00 COMMENT 'Aç´šé­šç¸½ä»£ç†åº•åƒ¹' AFTER fixed_unsold_ratio,
ADD COLUMN distributor_floor_price_b decimal(10,2) DEFAULT 80.00 COMMENT 'Bç´šé­šç¸½ä»£ç†åº•åƒ¹' AFTER distributor_floor_price_a,
ADD COLUMN target_price_a decimal(10,2) DEFAULT 150.00 COMMENT 'Aç´šé­šç›®æ¨™åƒ¹æ ¼' AFTER distributor_floor_price_b,
ADD COLUMN target_price_b decimal(10,2) DEFAULT 120.00 COMMENT 'Bç´šé­šç›®æ¨™åƒ¹æ ¼' AFTER target_price_a,
ADD COLUMN buying_duration int(11) DEFAULT 7 COMMENT 'è²·å…¥éšæ®µæ™‚é–“' AFTER target_price_b,
ADD COLUMN selling_duration int(11) DEFAULT 4 COMMENT 'è³£å‡ºéšæ®µæ™‚é–“' AFTER buying_duration;

-- æ›´æ–° transactions è¡¨
ALTER TABLE transactions
ADD COLUMN game_id int(11) NOT NULL AFTER id,
ADD COLUMN day_number int(11) NOT NULL AFTER game_day_id,
ADD COLUMN price decimal(10,2) DEFAULT NULL COMMENT 'å–®åƒ¹' AFTER quantity,
ADD CONSTRAINT fk_tx_game FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE;

-- æ›´æ–° daily_results è¡¨
ALTER TABLE daily_results
ADD COLUMN game_id int(11) NOT NULL AFTER id,
ADD COLUMN closing_budget decimal(12,2) DEFAULT 0.00 COMMENT 'çµç®—å¾Œé ç®—' AFTER ending_cash,
ADD COLUMN closing_loan decimal(12,2) DEFAULT 0.00 COMMENT 'çµç®—å¾Œè²¸æ¬¾' AFTER ending_loan,
ADD COLUMN cost decimal(12,2) DEFAULT 0.00 COMMENT 'æˆæœ¬' AFTER buy_cost,
ADD COLUMN revenue decimal(12,2) DEFAULT 0.00 COMMENT 'æ”¶å…¥' AFTER sell_revenue,
ADD COLUMN interest_incurred decimal(12,2) DEFAULT 0.00 COMMENT 'åˆ©æ¯æ”¯å‡º' AFTER interest_paid,
ADD CONSTRAINT fk_results_game FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE;
```

---

## ğŸš€ é‡æ–°éƒ¨ç½²åˆ° Railway

### 1. æ›´æ–°è³‡æ–™åº«
åŸ·è¡Œä¸Šè¿° SQL èªå¥æ›´æ–° Railway MySQL è³‡æ–™åº«çµæ§‹

### 2. é‡æ–°éƒ¨ç½²å¾Œç«¯
```bash
# Railway æœƒè‡ªå‹•åµæ¸¬åˆ° backend/server.js çš„è®Šæ›´ä¸¦é‡æ–°éƒ¨ç½²
git add .
git commit -m "ä¿®æ­£è³‡é‡‘æ± é‚è¼¯å’Œè³‡æ–™åº«çµæ§‹"
git push
```

### 3. é©—è­‰ä¿®æ­£
éƒ¨ç½²å¾Œè«‹æ¸¬è©¦ä»¥ä¸‹æµç¨‹ï¼š
- âœ… æ¨é€²åˆ°ç¬¬ä¸€å¤©
- âœ… è²·å…¥æŠ•æ¨™
- âœ… è²·å…¥çµç®—
- âœ… è³£å‡ºæŠ•æ¨™
- âœ… è³£å‡ºçµç®—
- âœ… æ¯æ—¥çµç®—ï¼ˆæª¢æŸ¥è³‡é‡‘æ± æ˜¯å¦åªæ¸›ä¸å¢ï¼‰
- âœ… ROI è¨ˆç®—

---

## ğŸ“ ä¿®æ­£ç¸½çµ

### å·²å®Œæˆçš„ä¿®æ­£ï¼š
1. âœ… ä¿®æ­£è³‡é‡‘æ± é‚è¼¯ï¼ˆ**æœ€é‡è¦**ï¼‰
2. âœ… å®Œå–„ games è¡¨çµæ§‹ï¼ˆæ–°å¢ 8 å€‹æ¬„ä½ï¼‰
3. âœ… å®Œå–„ transactions è¡¨çµæ§‹ï¼ˆæ–°å¢ 3 å€‹æ¬„ä½ï¼‰
4. âœ… å®Œå–„ daily_results è¡¨çµæ§‹ï¼ˆæ–°å¢ 6 å€‹æ¬„ä½ï¼‰
5. âœ… æ›´æ–° seed_demo_game.sql
6. âœ… ç¢ºèªè²·å…¥/è³£å‡º/çµç®—é‚è¼¯ç¬¦åˆéŠæˆ²è¦å‰‡

### æ ¸å¿ƒéŠæˆ²é‚è¼¯é©—è­‰ï¼š
- âœ… è²·å…¥æŠ•æ¨™ï¼šæœ€å¤š 2 å€‹åƒ¹æ ¼ï¼Œåƒ¹é«˜è€…å¾—
- âœ… è³£å‡ºæŠ•æ¨™ï¼š2.5% å›ºå®šæ»¯éŠ·ï¼Œåƒ¹ä½è€…å¾—
- âœ… è³‡é‡‘ç®¡ç†ï¼šè³‡é‡‘æ± åªæ¸›ä¸å¢ â­
- âœ… å€Ÿè²¸æ©Ÿåˆ¶ï¼šè‡ªå‹•å€Ÿè²¸ï¼Œ3% è¤‡åˆ©
- âœ… ROI è¨ˆç®—ï¼š(ç´¯ç©åˆ©æ½¤ / ç¸½æŠ•è³‡) Ã— 100%
- âœ… åº«å­˜ç®¡ç†ï¼šæ¯æ—¥æ¸…é›¶ï¼Œæ»¯éŠ·è²» $10/kg

---

## âš ï¸ é‡è¦æé†’

1. **è³‡é‡‘æ± é‚è¼¯è®Šæ›´å½±éŸ¿é‡å¤§**ï¼šåŸæœ¬éŠ·å”®æ”¶å…¥æœƒåŠ å›è³‡é‡‘æ± ï¼Œç¾åœ¨ä¸æœƒã€‚é€™æœƒè®“éŠæˆ²é›£åº¦å¤§å¹…æå‡ï¼Œæ›´ç¬¦åˆçœŸå¯¦å•†æ¥­ç’°å¢ƒã€‚

2. **å¿…é ˆé‡æ–°æ¸¬è©¦**ï¼šç”±æ–¼ä¿®æ­£äº†æ ¸å¿ƒé‚è¼¯ï¼Œå»ºè­°åœ¨ Railway ä¸Šé‡æ–°æ¸¬è©¦å®Œæ•´éŠæˆ²æµç¨‹ã€‚

3. **ç¾æœ‰éŠæˆ²è³‡æ–™**ï¼šå¦‚æœ Railway ä¸Šæœ‰é€²è¡Œä¸­çš„éŠæˆ²ï¼Œå»ºè­°å®Œæˆå¾Œå†éƒ¨ç½²æ›´æ–°ï¼Œé¿å…è³‡æ–™ä¸ä¸€è‡´ã€‚

---

## ğŸ“ å¾ŒçºŒæ”¯æ´

å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–éœ€è¦é€²ä¸€æ­¥èª¿æ•´ï¼Œè«‹éš¨æ™‚å‘ŠçŸ¥ï¼

---

**ä¿®æ­£å®Œæˆæ™‚é–“ï¼š** 2025-11-18
**ä¿®æ­£æª”æ¡ˆæ•¸é‡ï¼š** 3 å€‹
- `complete_database_structure.sql`
- `seed_demo_game.sql`
- `backend/server.js`
