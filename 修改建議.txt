問題定位（根因）

階段值不一致導致一直被禁用

你在 loadTeamSummary() 內用 updatePhaseControls(data.phase) 來決定是否啟用輸入，但 dashboard 回傳的實際欄位是 data.gameInfo.dayStatus（像 buying_open/selling_open 這種），同時你在 updateTeamDisplay() 也把 currentPhase 設成這個欄位值，而不是 data.phase。結果就是丟給 updatePhaseControls 的是 undefined，它就把所有 input, button 全部禁用。

simple-team

 

simple-team

更進一步，updatePhaseControls 目前是整個 tab 底下的所有按鈕都禁用，包含「A 魚 / B 魚」切換頁籤的 button，自然也就「按不到 B 魚」。

simple-team

（次要）已使用價位檢查邏輯有兩個明顯 bug

用了不存在的欄位 price_per_unit，應該是 price。

new Set([.oldPrices, .pricesNow]) 語法錯誤，正確是展開陣列 new Set([...oldPrices, ...pricesNow])。這段一旦被跑到會直接丟錯。

simple-team

最小修改建議（不破壞前端現有流程）
A. 統一並正規化階段字串

後端 dayStatus 可能是 buying_open/selling_open/buying_closed/selling_closed，而你的 UI 期望的是 buying/selling/buy_closed/sell_closed。新增一個 mapping，所有地方一律丟正規化後的 phase：

function normalizePhase(dayStatus) {
  const map = {
    pending: 'waiting',
    buying_open: 'buying',
    buying_closed: 'buy_closed',
    selling_open: 'selling',
    selling_closed: 'sell_closed',
    settled: 'settling' // 或 'day_ended' 依你的 UI 顯示習慣
  };
  return map[dayStatus] || dayStatus || 'waiting';
}


在 loadTeamSummary() 成功後改成：

const normalized = normalizePhase(data.gameInfo?.dayStatus);
currentPhase = normalized;
updatePhaseControls(normalized);


（不要再傳 data.phase 了）

simple-team

 

simple-team

在「即時更新」那支也一併呼叫，避免輪詢把 UI 狀態又蓋回去：

// updateGameStatus() 裡，在 updatePhaseBanner(gameStatus.phase) 後面補：
// const normalized = normalizePhase(gameStatus.phase);
// currentPhase = normalized;
// updatePhaseControls(normalized);


（目前你只更新橫幅沒有更新禁用狀態）

simple-team

B. 只禁用「輸入框＋送出鈕」，不要禁用頁籤按鈕

把 updatePhaseControls() 的 selector 從 input, button 改成更精準的元素，避免把 .fish-tab（A 魚 / B 魚）與上方「買入/賣出」頁籤按鈕一起鎖死：

function updatePhaseControls(phase) {
  const buyTab = document.getElementById('buyTab');
  const sellTab = document.getElementById('sellTab');

  // 僅鎖 input[type=number] 與送出按鈕（給送出鈕加個 class="submit-btn"）
  const buyInputs = buyTab.querySelectorAll('input[type="number"], .submit-btn');
  const sellInputs = sellTab.querySelectorAll('input[type="number"], .submit-btn');

  buyInputs.forEach(el => el.disabled = (phase !== 'buying'));
  sellInputs.forEach(el => el.disabled = (phase !== 'selling'));
}


目前的寫法會把 .fish-tab 也 disable，導致 B 魚按不下；同時你既然用 switchFish() 來切 content，頁籤按鈕就不該被鎖。

simple-team

 

simple-team

同時在 HTML 送出按鈕上加 class（四個送出鈕都要）：

<button class="btn btn-success submit-btn" onclick="submitBid('buy','A')">…</button>

C. 修正「已使用價位」檢查兩個 bug

把 submitBid() 中檢查價位的區塊改成：

// 檢查是否超過兩個不同價位（包含已送出的價位）
const pricesNow = bids.map(b => b.price);              // <- 修正欄位
const oldPrices = usedPrices[bidType][fishType] || [];
const merged = new Set([...oldPrices, ...pricesNow]);  // <- 修正語法
if (merged.size > 2) {
  showMessage('每魚種「全日」最多兩個不同價格（含已送出的）', 'error');
  return;
}


（這段原本 price_per_unit 與 new Set([.oldPrices, .pricesNow]) 都是錯的）

simple-team

為什麼套了這三個改動就會好

phase 正規化+正確傳入 → updatePhaseControls() 會在「買入階段」只開買入區，「賣出階段」只開賣出區，不會再是整頁都被 disable（能輸入數字）。

simple-team

精準禁用 → A/B 魚 tab 與買/賣 tab 不再被 disable（能切到 B 魚）。

simple-team

已使用價位檢查修正 → 不會在送單時無故報錯或直接 throw 例外卡死提交流程。

simple-team