# 暫停功能定義與需求分析

**分析日期**: 2025-01-18
**遊戲類型**: 教學用魚市場交易模擬遊戲
**目的**: 確定暫停功能的實際作用和需求

---

## 🎮 遊戲特性分析

### 1. 遊戲流程（線性、有時間限制）

```
推進新一天
    ↓ (管理員操作)
買入投標階段 (7分鐘)
    ↓ (計時器)
買入結算
    ↓ (管理員操作)
賣出投標階段 (4分鐘)
    ↓ (計時器)
賣出結算
    ↓ (系統自動)
每日結算
    ↓ (循環)
下一天...
```

### 2. 關鍵特點

| 特性 | 說明 | 對暫停的影響 |
|------|------|------------|
| **有時間限制** | 買入7分鐘、賣出4分鐘 | 暫停需停止計時器 |
| **教學情境** | 課堂使用，團隊協作 | 可能需要中斷講解 |
| **實時性** | 時間到自動結算 | 暫停會影響公平性 |
| **管理員控制** | 推進階段需手動操作 | 暫停可能影響流程控制 |
| **WebSocket 即時更新** | 狀態即時推播 | 暫停需廣播給所有玩家 |

### 3. 當前實現狀態

**後端**:
- ✅ 有 pause/resume API 端點
- ❌ 邏輯錯誤（全域替換 paused 造成）
- ❌ enum 沒有 paused 狀態

**前端**:
- ❌ **沒有暫停/恢復按鈕**
- ❌ 沒有暫停狀態顯示
- ❌ 沒有調用 pause/resume API

**結論**: 暫停功能是**後端預留但前端未實現**的功能

---

## 💡 暫停功能的可能作用

### 場景 1: 技術問題處理 🔧

**情境**:
- 伺服器需要重啟
- 網路斷線
- 系統維護

**需求**:
- 停止所有計時器
- 禁止玩家提交投標
- 保持當前遊戲狀態
- 問題解決後恢復

**重要性**: 🟡 中等（技術問題時可以用「強制結束」代替）

---

### 場景 2: 課堂教學中斷 📚

**情境**:
- 下課休息
- 老師需要暫停講解策略
- 學生需要更多討論時間
- 突發事件（火災演習等）

**需求**:
- 立即停止計時器
- 凍結當前狀態
- 稍後繼續遊戲
- 不影響已投標的資料

**重要性**: 🟢 高（這是教學遊戲的核心需求）

---

### 場景 3: 公平性保障 ⚖️

**情境**:
- 某個團隊網路斷線
- 設備故障
- 等待所有團隊就緒

**需求**:
- 暫停計時器
- 廣播給所有玩家
- 等待問題解決
- 公平恢復遊戲

**重要性**: 🟢 高（保證遊戲公平性）

---

### 場景 4: 延長討論時間 ⏰

**情境**:
- 學生需要更多時間討論策略
- 老師想延長某個階段
- 複雜情況需要分析

**需求**:
- 暫停計時器
- 允許繼續討論
- 彈性控制遊戲節奏

**重要性**: 🟡 中等（也可以通過設定更長的時間限制解決）

---

### 場景 5: 管理員操作失誤 🔄

**情境**:
- 誤點推進天數
- 設定參數錯誤
- 需要回退狀態

**需求**:
- 暫停遊戲
- 修正錯誤
- 重新開始

**重要性**: 🔴 低（暫停無法回退狀態，需要其他機制）

---

## 🔍 暫停功能應該做什麼？

### 核心需求

根據遊戲特性和使用場景，暫停功能應該：

#### 1. **停止計時器** ⏸️

```javascript
// 買入階段計時器
if (game.phase === 'buying_open' && game.is_paused) {
    // 暫停計時器，不自動關閉買入階段
    clearTimeout(buyingTimer);
}

// 賣出階段計時器
if (game.phase === 'selling_open' && game.is_paused) {
    // 暫停計時器，不自動關閉賣出階段
    clearTimeout(sellingTimer);
}
```

**實現難點**: 需要記錄剩餘時間，恢復時繼續倒數

#### 2. **禁止玩家操作** 🚫

```javascript
// 檢查暫停狀態
if (game.is_paused) {
    return res.status(400).json({
        error: '遊戲已暫停',
        message: '請等待管理員恢復遊戲'
    });
}
```

**影響的端點**:
- `POST /api/team/submit-buy-bids` - 提交買入投標
- `POST /api/team/submit-sell-bids` - 提交賣出投標

#### 3. **禁止管理員推進** 🛑

```javascript
// 暫停時不允許推進天數或階段
if (game.is_paused) {
    return res.status(400).json({
        error: '遊戲已暫停',
        message: '請先恢復遊戲再推進'
    });
}
```

**影響的端點**:
- `POST /api/admin/games/:gameId/advance-day` - 推進天數
- `POST /api/admin/games/:gameId/open-buying` - 開啟買入
- `POST /api/admin/games/:gameId/close-buying` - 關閉買入
- `POST /api/admin/games/:gameId/process-buy` - 處理買入
- 其他推進階段的端點

#### 4. **廣播暫停狀態** 📡

```javascript
// Socket.IO 推播
io.to(`game-${gameId}`).emit('gameStatusUpdate', {
    status: 'active',
    isPaused: true,
    message: '遊戲已暫停，請等待管理員恢復',
    pausedAt: new Date(),
    pausedPhase: game.phase
});
```

**前端顯示**:
- 顯示「已暫停」橫幅
- 禁用投標按鈕
- 停止倒數計時器
- 顯示暫停原因（可選）

#### 5. **記錄暫停資訊** 📝

```sql
-- 需要記錄的資訊
is_paused: BOOLEAN          -- 是否暫停
paused_at: TIMESTAMP        -- 暫停時間
paused_phase: ENUM          -- 暫停時的階段
remaining_time: INT         -- 剩餘秒數（如果在計時階段）
pause_reason: VARCHAR       -- 暫停原因（可選）
```

#### 6. **恢復遊戲** ▶️

```javascript
// 恢復時需要：
1. 設定 is_paused = FALSE
2. 清除暫停資訊
3. 重新啟動計時器（使用剩餘時間）
4. 廣播恢復狀態
5. 記錄到 game_logs
```

---

## 📊 暫停功能複雜度分析

### 簡單實現（不考慮計時器）

**適用場景**: 管理員手動控制所有階段（無自動計時器）

```javascript
// 暫停：禁止所有操作
if (game.is_paused) {
    return res.status(400).json({ error: '遊戲已暫停' });
}

// 恢復：允許操作
UPDATE games SET is_paused = FALSE WHERE id = ?
```

**複雜度**: 🟢 低（15 分鐘）
**限制**: 無法處理自動計時器

---

### 完整實現（包含計時器控制）

**適用場景**: 有自動倒數計時器的階段

```javascript
// 暫停時：
1. 停止計時器
2. 記錄剩餘時間
3. 禁止操作
4. 廣播狀態

// 恢復時：
1. 讀取剩餘時間
2. 重新啟動計時器（使用剩餘時間）
3. 允許操作
4. 廣播狀態
```

**複雜度**: 🔴 高（60 分鐘 + 測試）
**需要修改**:
- 計時器管理邏輯
- WebSocket 事件處理
- 前端計時器顯示
- 狀態同步機制

---

## 🎯 建議方案

### 根據當前狀態分析

**發現**:
1. ❌ 前端**完全沒有**暫停按鈕或功能
2. ❌ 後端 pause/resume 邏輯**完全錯誤**
3. ❌ 沒有計時器暫停機制
4. ❌ 沒有剩餘時間記錄

**結論**: 暫停功能**從未完整實現過**

---

### 方案對比

#### 方案 A: 移除暫停功能 ❌

**理由**:
- ❌ 教學遊戲**確實需要**暫停功能
- ❌ 課堂中斷是常見需求
- ❌ 公平性問題需要暫停機制

**不推薦**，除非：
- 遊戲完全由管理員手動控制（無自動計時器）
- 課堂時間充裕，不需要中斷

---

#### 方案 B: 簡單暫停（無計時器控制）🟡

**實現**:
1. 添加 `is_paused` 欄位
2. 暫停時禁止玩家投標
3. 恢復時允許投標
4. **不處理計時器**（管理員手動關閉階段）

**優點**:
- 實現簡單（20 分鐘）
- 不需修改複雜的計時器邏輯
- 適合手動控制的教學情境

**缺點**:
- 無法暫停自動倒數
- 需要管理員持續關注

**適用**: 如果遊戲主要由管理員手動推進各階段

---

#### 方案 C: 完整暫停（包含計時器）✅

**實現**:
1. 添加完整暫停欄位（is_paused, paused_at, remaining_time）
2. 實現計時器暫停/恢復機制
3. 前端顯示暫停狀態和倒數
4. WebSocket 同步所有客戶端
5. 記錄暫停歷史

**優點**:
- 完整功能
- 最佳用戶體驗
- 適合自動化遊戲流程

**缺點**:
- 實現複雜（60 分鐘）
- 需要徹底測試
- 可能有邊界情況

**適用**: 如果遊戲有自動計時器並需要精確控制

---

## ❓ 需要您決定的問題

### 問題 1: 遊戲是否有自動計時器？

**A. 有自動計時器**
- 買入階段開始後，7分鐘自動關閉
- 賣出階段開始後，4分鐘自動關閉
→ 需要**完整暫停功能**（方案 C）

**B. 手動控制**
- 管理員決定何時關閉買入階段
- 管理員決定何時關閉賣出階段
→ 只需**簡單暫停功能**（方案 B）

**C. 沒有計時器**
- 無時間限制
- 完全由管理員控制節奏
→ **不需要暫停功能**（方案 A）

---

### 問題 2: 教學中是否需要暫停？

**A. 經常需要**
- 需要暫停講解策略
- 學生需要更多討論時間
- 課堂會有中斷情況
→ **建議保留暫停功能**

**B. 偶爾需要**
- 主要是技術問題
- 可以用強制結束代替
→ **可以簡化或移除**

**C. 不需要**
- 課堂時間充裕
- 遊戲流程順暢
→ **可以移除暫停功能**

---

### 問題 3: 實現複雜度 vs 需求優先級

| 方案 | 實現時間 | 測試時間 | 維護成本 | 用戶體驗 |
|------|---------|---------|---------|---------|
| **A. 移除** | 5 分鐘 | 5 分鐘 | 低 | ❌ 無暫停 |
| **B. 簡單暫停** | 20 分鐘 | 15 分鐘 | 低 | 🟡 基本功能 |
| **C. 完整暫停** | 60 分鐘 | 30 分鐘 | 高 | ✅ 完整功能 |

---

## 📝 我的建議

基於您是**教學用遊戲**，我的建議是：

### 🎯 推薦：方案 B（簡單暫停）

**理由**:
1. ✅ 滿足基本需求（課堂中斷、技術問題）
2. ✅ 實現簡單快速（20 分鐘）
3. ✅ 易於維護
4. ✅ 如果管理員手動控制階段，完全足夠

**實現步驟**:
```sql
-- 添加欄位
ALTER TABLE games
ADD COLUMN `is_paused` BOOLEAN DEFAULT FALSE,
ADD COLUMN `paused_at` TIMESTAMP NULL,
ADD COLUMN `pause_reason` VARCHAR(255) NULL;
```

```javascript
// pause 端點
if (game[0].status !== 'active') return 400;
UPDATE games SET is_paused = TRUE, paused_at = NOW();
io.emit('gamePaused', ...);

// resume 端點
if (!game[0].is_paused) return 400;
UPDATE games SET is_paused = FALSE, paused_at = NULL;
io.emit('gameResumed', ...);

// 在投標端點檢查
if (game.is_paused) {
    return res.status(400).json({
        error: '遊戲已暫停，請等待管理員恢復'
    });
}
```

**前端**:
- 添加暫停/恢復按鈕
- 顯示暫停狀態橫幅
- 禁用投標按鈕

---

## ✅ 下一步

**請回答以下問題**，以便我提供最適合的方案：

1. **遊戲有自動計時器嗎？**
   - [ ] 是，買入/賣出階段會自動倒數並關閉
   - [ ] 否，完全由管理員手動控制

2. **課堂中需要暫停功能嗎？**
   - [ ] 經常需要（下課、講解、討論）
   - [ ] 偶爾需要（技術問題）
   - [ ] 不需要

3. **您希望的實現方式？**
   - [ ] **簡單暫停**（20分鐘，禁止操作即可）
   - [ ] **完整暫停**（60分鐘，包含計時器控制）
   - [ ] **移除功能**（5分鐘，停用端點）

---

**文檔完成**: 2025-01-18
**分析者**: Claude Code
**待決定**: 暫停功能實現方案
