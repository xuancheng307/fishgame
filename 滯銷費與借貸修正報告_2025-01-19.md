# æ»¯éŠ·è²»èˆ‡å€Ÿè²¸é¡åº¦ä¿®æ­£å ±å‘Š

**ä¿®æ­£æ—¥æœŸ**: 2025-01-19
**å•é¡Œä¾†æº**: åŠŸèƒ½ API æª¢æŸ¥èˆ‡éŠæˆ²è¦å‰‡æ¾„æ¸…

---

## ğŸ“‹ ä¿®æ­£ç¸½è¦½

æœ¬æ¬¡ä¿®æ­£è§£æ±ºäº†ä»¥ä¸‹å•é¡Œï¼š
1. âœ… æ»¯éŠ·è²»é è¨­å€¼éŒ¯èª¤ ($10 â†’ $20)
2. âœ… è²·å…¥çµç®—ç¼ºå°‘å€Ÿè²¸é¡åº¦æª¢æŸ¥
3. âœ… æ¯æ—¥çµç®—ç¼ºå°‘å€Ÿè²¸é¡åº¦æª¢æŸ¥
4. âœ… æ¾„æ¸…æ»¯éŠ·æ©Ÿåˆ¶çš„è¨ˆç®—æ–¹å¼

---

## ğŸ”´ å•é¡Œ 1ï¼šæ»¯éŠ·è²»é è¨­å€¼éŒ¯èª¤

### å•é¡Œæè¿°ï¼š

æ ¹æ“šéŠæˆ²èªªæ˜ï¼Œæ»¯éŠ·è™•ç†è²»æ‡‰ç‚º **$20/kg**ï¼Œä½†ç¨‹å¼ç¢¼å’Œè³‡æ–™åº«ä½¿ç”¨çš„æ˜¯ **$10/kg**ã€‚

### å½±éŸ¿ç¯„åœï¼š

- `backend/server.js` line 3397
- `complete_database_structure.sql` line 50
- æ‰€æœ‰ç¾æœ‰éŠæˆ²çš„æ»¯éŠ·è²»è¨ˆç®—

### ä¿®æ­£å…§å®¹ï¼š

#### 1. ä¿®æ­£ server.js

**æª”æ¡ˆ**: `backend/server.js`
**è¡Œè™Ÿ**: 3397

```javascript
// ä¿®æ­£å‰ï¼š
const unsoldFeePerKg = gameInfo[0].unsold_fee_per_kg || 10;

// ä¿®æ­£å¾Œï¼š
const unsoldFeePerKg = gameInfo[0].unsold_fee_per_kg || 20;
```

#### 2. ä¿®æ­£è³‡æ–™åº« Schema

**æª”æ¡ˆ**: `complete_database_structure.sql`
**è¡Œè™Ÿ**: 50

```sql
-- ä¿®æ­£å‰ï¼š
`unsold_fee_per_kg` decimal(10,2) NOT NULL DEFAULT 10.00,

-- ä¿®æ­£å¾Œï¼š
`unsold_fee_per_kg` decimal(10,2) NOT NULL DEFAULT 20.00,
```

#### 3. å»ºç«‹è³‡æ–™åº«é·ç§»è…³æœ¬

**æª”æ¡ˆ**: `migrations/004_update_unsold_fee.sql`

```sql
-- æ›´æ–°æ»¯éŠ·è²»é è¨­å€¼å¾ $10/kg æ”¹ç‚º $20/kg
ALTER TABLE `games`
MODIFY COLUMN `unsold_fee_per_kg` decimal(10,2) NOT NULL DEFAULT 20.00;

-- æ›´æ–°ç¾æœ‰éŠæˆ²çš„æ»¯éŠ·è²»
UPDATE `games`
SET `unsold_fee_per_kg` = 20.00
WHERE `unsold_fee_per_kg` = 10.00;
```

---

## ğŸ”´ å•é¡Œ 2ï¼šè²·å…¥çµç®—ç¼ºå°‘å€Ÿè²¸é¡åº¦æª¢æŸ¥

### å•é¡Œæè¿°ï¼š

`processBuyBids` å‡½æ•¸åœ¨è‡ªå‹•å€Ÿè²¸æ™‚ï¼Œæ²’æœ‰æª¢æŸ¥æ˜¯å¦è¶…éå€Ÿè²¸é¡åº¦ä¸Šé™ï¼ˆåˆå§‹é ç®— Ã— 50%ï¼‰ã€‚

é›–ç„¶æäº¤æŠ•æ¨™ API (`/api/team/submit-buy-bids`) å·²ç¶“æœ‰æª¢æŸ¥ï¼Œä½†ç‚ºäº†ç©©å¥æ€§ï¼Œçµç®—æ™‚ä¹Ÿæ‡‰è©²æœ‰ä¿è­·æ€§æª¢æŸ¥ã€‚

### ä¿®æ­£å…§å®¹ï¼š

**æª”æ¡ˆ**: `backend/server.js`
**è¡Œè™Ÿ**: 3334-3353

```javascript
// ä¿®æ­£å‰ï¼š
if (participant[0].current_budget < totalCost) {
    const loanNeeded = totalCost - participant[0].current_budget;
    await connection.execute(
        `UPDATE game_participants
         SET total_loan = total_loan + ?,
             total_loan_principal = total_loan_principal + ?,
             current_budget = current_budget + ?
         WHERE game_id = ? AND team_id = ?`,
        [loanNeeded, loanNeeded, loanNeeded, gameDay.game_id, bid.team_id]
    );
}

// ä¿®æ­£å¾Œï¼š
if (participant[0].current_budget < totalCost) {
    const loanNeeded = totalCost - participant[0].current_budget;

    // æª¢æŸ¥å€Ÿè²¸é¡åº¦é™åˆ¶
    const maxLoan = game[0].initial_budget * game[0].max_loan_ratio;
    const newLoanPrincipal = participant[0].total_loan_principal + loanNeeded;

    if (newLoanPrincipal > maxLoan) {
        throw new Error(`åœ˜éšŠ ${bid.team_id} å€Ÿè²¸è¶…éé¡åº¦é™åˆ¶ (éœ€è¦ ${newLoanPrincipal}, ä¸Šé™ ${maxLoan})`);
    }

    await connection.execute(
        `UPDATE game_participants
         SET total_loan = total_loan + ?,
             total_loan_principal = total_loan_principal + ?,
             current_budget = current_budget + ?
         WHERE game_id = ? AND team_id = ?`,
        [loanNeeded, loanNeeded, loanNeeded, gameDay.game_id, bid.team_id]
    );
}
```

---

## ğŸ”´ å•é¡Œ 3ï¼šæ¯æ—¥çµç®—ç¼ºå°‘å€Ÿè²¸é¡åº¦æª¢æŸ¥

### å•é¡Œæè¿°ï¼š

`enhancedDailySettlement` å‡½æ•¸åœ¨æ‰£é™¤æ»¯éŠ·è²»å’Œåˆ©æ¯å¾Œï¼Œå¦‚æœç¾é‡‘ä¸è¶³æœƒè‡ªå‹•å€Ÿè²¸ï¼Œä½†æ²’æœ‰æª¢æŸ¥å€Ÿè²¸é¡åº¦ä¸Šé™ã€‚

### ä¿®æ­£å…§å®¹ï¼š

**æª”æ¡ˆ**: `backend/server.js`
**è¡Œè™Ÿ**: 3673-3686

```javascript
// ä¿®æ­£å‰ï¼š
if (newBudget.lessThan(0)) {
    additionalLoan = newBudget.abs();
    newBudget = new Decimal(0);
}

// ä¿®æ­£å¾Œï¼š
if (newBudget.lessThan(0)) {
    additionalLoan = newBudget.abs();

    // æª¢æŸ¥å€Ÿè²¸é¡åº¦é™åˆ¶
    const maxLoan = initialBudget.times(new Decimal(gameInfo.max_loan_ratio));
    const newLoanPrincipal = currentLoanPrincipal.plus(additionalLoan);

    if (newLoanPrincipal.greaterThan(maxLoan)) {
        throw new Error(`åœ˜éšŠ ${participant.team_id} æ¯æ—¥çµç®—æ™‚å€Ÿè²¸è¶…éé¡åº¦é™åˆ¶ (éœ€è¦ ${newLoanPrincipal.toFixed(2)}, ä¸Šé™ ${maxLoan.toFixed(2)})`);
    }

    newBudget = new Decimal(0);
}
```

---

## âœ… æ¾„æ¸…ï¼šæ»¯éŠ·æ©Ÿåˆ¶çš„è¨ˆç®—æ–¹å¼

### ç”¨æˆ¶æ¾„æ¸…å…§å®¹ï¼š

æ»¯éŠ·åŒ…å«**å…©å€‹éƒ¨åˆ†**ï¼š

1. **å›ºå®š 2.5% æ»¯éŠ·**ï¼š
   - å¾æ‰€æœ‰è³£å‡ºæŠ•æ¨™çš„ç¸½é‡è¨ˆç®— 2.5%
   - å¾åƒ¹æ ¼æœ€é«˜çš„æŠ•æ¨™é–‹å§‹åˆ†é…æ»¯éŠ·é‡
   - åŒåƒ¹æ ¼æ™‚ï¼Œæ™šæŠ•æ¨™è€…å„ªå…ˆæ»¯éŠ·

2. **é ç®—ä¸è¶³æ»¯éŠ·**ï¼š
   - æ‰£é™¤å›ºå®š 2.5% å¾Œï¼Œå‰©ä¸‹çš„å¾ä½åƒ¹é–‹å§‹æˆäº¤
   - ç´¯è¨ˆæˆäº¤é‡‘é¡ç›´åˆ°é¤å»³é ç®—ç”¨å®Œ
   - å‰©ä¸‹æ²’æœ‰æˆäº¤çš„éƒ¨åˆ†ä¹Ÿåˆ—å…¥æ»¯éŠ·

### æ»¯éŠ·è²»è¨ˆç®—ï¼š

```
ç¸½æ»¯éŠ·é‡ = å›ºå®š 2.5% æ»¯éŠ· + é ç®—ä¸è¶³æ»¯éŠ·
ç¸½æ»¯éŠ·é‡ = è²·å…¥é‡ - è³£å‡ºé‡

æ»¯éŠ·è²» = ç¸½æ»¯éŠ·é‡ Ã— $20/kg
```

### ç•¶å‰ç¨‹å¼ç¢¼ç‹€æ…‹ï¼š

âœ… **ç¨‹å¼ç¢¼é‚è¼¯æ­£ç¢º**ï¼

åœ¨ `enhancedDailySettlement` ä¸­ï¼š
```javascript
const fishAUnsold = Math.max(0, fishABought - fishASold);
const fishBUnsold = Math.max(0, fishBBought - fishBSold);
const unsoldFee = unsoldFeePerKg.times(fishAUnsold + fishBUnsold);
```

**ç‚ºä»€éº¼æ­£ç¢º**ï¼š
- `fishABought` = å¯¦éš›è²·å…¥é‡ï¼ˆå¾ buy bids çš„ quantity_fulfilledï¼‰
- `fishASold` = å¯¦éš›è³£å‡ºé‡ï¼ˆå¾ sell bids çš„ quantity_fulfilledï¼‰
- åœ¨ `processSellBids` ä¸­ï¼Œ`quantity_fulfilled` åªè¨˜éŒ„å¯¦éš›æˆäº¤çš„é‡
- å›ºå®š 2.5% æ»¯éŠ·å’Œé ç®—ä¸è¶³æ»¯éŠ·éƒ½ä¸æœƒè¢«è¨˜å…¥ `quantity_fulfilled`
- å› æ­¤ `fishABought - fishASold` æ­£ç¢ºè¨ˆç®—äº†æ‰€æœ‰æ»¯éŠ·

---

## ğŸ“Š ä¿®æ­£çµ±è¨ˆ

| ä¿®æ­£é …ç›® | æª”æ¡ˆ | ä¿®æ­£æ•¸é‡ |
|---------|------|---------|
| æ»¯éŠ·è²»é è¨­å€¼ | server.js | 1 è™• |
| æ»¯éŠ·è²»é è¨­å€¼ | complete_database_structure.sql | 1 è™• |
| è²·å…¥çµç®—å€Ÿè²¸æª¢æŸ¥ | server.js | 1 è™• |
| æ¯æ—¥çµç®—å€Ÿè²¸æª¢æŸ¥ | server.js | 1 è™• |
| **ç¸½è¨ˆ** | **3 å€‹æª”æ¡ˆ** | **4 è™•** |

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. åŸ·è¡Œè³‡æ–™åº«é·ç§»

```bash
# æ›´æ–°æ»¯éŠ·è²»é è¨­å€¼ä¸¦ä¿®æ­£ç¾æœ‰éŠæˆ²
mysql -u root -p fishmarket_game < migrations/004_update_unsold_fee.sql
```

### 2. éƒ¨ç½²å¾Œç«¯

```bash
# è¤‡è£½ä¿®æ­£å¾Œçš„ server.js
cp backend/server.js /path/to/production/backend/

# é‡å•Ÿæœå‹™
pm2 restart fishmarket-backend
# æˆ–
npm run start
```

### 3. é©—è­‰æ¸¬è©¦

#### æ¸¬è©¦ 1: æ»¯éŠ·è²»è¨ˆç®—
1. å»ºç«‹æ–°éŠæˆ²
2. é€²è¡Œå®Œæ•´çš„è²·å…¥ â†’ è³£å‡ºæµç¨‹
3. æª¢æŸ¥æ¯æ—¥çµç®—ä¸­çš„æ»¯éŠ·è²»ï¼š
   ```sql
   SELECT unsold_fee FROM daily_results WHERE day_number = 1;
   -- æ‡‰è©²ä½¿ç”¨ $20/kg è¨ˆç®—
   ```

#### æ¸¬è©¦ 2: å€Ÿè²¸é¡åº¦æª¢æŸ¥ï¼ˆè²·å…¥ï¼‰
1. åœ˜éšŠå˜—è©¦æŠ•æ¨™è¶…é (ç¾é‡‘ + å‰©é¤˜å€Ÿè²¸é¡åº¦) çš„é‡‘é¡
2. æ‡‰è©²åœ¨æäº¤æŠ•æ¨™æ™‚è¢«æ‹’çµ•
3. å¦‚æœé€šéæª¢æŸ¥ä½†çµç®—æ™‚è¶…é¡ï¼Œæ‡‰è©²è§¸ç™¼éŒ¯èª¤ä¸¦ rollback

#### æ¸¬è©¦ 3: å€Ÿè²¸é¡åº¦æª¢æŸ¥ï¼ˆæ¯æ—¥çµç®—ï¼‰
1. è¨­å®šä¸€å€‹æ¥è¿‘å€Ÿè²¸ä¸Šé™çš„åœ˜éšŠ
2. ç”¢ç”Ÿå¤§é‡æ»¯éŠ·è²»å’Œåˆ©æ¯
3. å¦‚æœç¾é‡‘ä¸è¶³ä¸”å€Ÿè²¸æœƒè¶…é¡ï¼Œæ‡‰è©²è§¸ç™¼éŒ¯èª¤

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### 1. æ»¯éŠ·è²»è®Šæ›´å½±éŸ¿

- ç¾æœ‰éŠæˆ²å¦‚æœé‚„åœ¨ä½¿ç”¨ $10/kgï¼Œæœƒè¢«é·ç§»è…³æœ¬æ›´æ–°ç‚º $20/kg
- é€™æœƒå½±éŸ¿æ­£åœ¨é€²è¡Œä¸­çš„éŠæˆ²çš„æç›Šè¨ˆç®—
- **å»ºè­°**ï¼šåœ¨éŠæˆ²è¼ªæ¬¡ä¹‹é–“ï¼ˆéé€²è¡Œä¸­ï¼‰åŸ·è¡Œé·ç§»

### 2. å€Ÿè²¸é¡åº¦æª¢æŸ¥

- è²·å…¥æŠ•æ¨™æ™‚å·²æœ‰å‰ç½®æª¢æŸ¥ï¼Œçµç®—æ™‚çš„æª¢æŸ¥æ˜¯**é›™é‡ä¿è­·**
- æ­£å¸¸æƒ…æ³ä¸‹ä¸æ‡‰è©²è§¸ç™¼çµç®—æ™‚çš„é¡åº¦éŒ¯èª¤
- å¦‚æœè§¸ç™¼ï¼Œè¡¨ç¤ºï¼š
  1. æäº¤æŠ•æ¨™æ™‚çš„æª¢æŸ¥è¢«ç¹é
  2. æˆ–è³‡æ–™ä¸ä¸€è‡´ï¼ˆéœ€è¦èª¿æŸ¥ï¼‰

### 3. éŒ¯èª¤è™•ç†

å…©è™•å€Ÿè²¸æª¢æŸ¥éƒ½ä½¿ç”¨ `throw new Error()`ï¼š
- æœƒå°è‡´äº‹å‹™ rollback
- å‰é¢å·²è™•ç†çš„æŠ•æ¨™æœƒè¢«æ’¤éŠ·
- é€™æ˜¯é æœŸè¡Œç‚ºï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´æ€§

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- `åŠŸèƒ½APIæª¢æŸ¥æ¸…å–®.md` - å·²æ›´æ–°ï¼Œæ¨™è¨˜å·²å®Œæˆé …ç›®
- `éŠæˆ²èªªæ˜.html` - éŠæˆ²è¦å‰‡åƒè€ƒä¾†æº
- `migrations/004_update_unsold_fee.sql` - è³‡æ–™åº«é·ç§»è…³æœ¬

---

## âœ… é©—è­‰æ¸…å–®

- [x] æ»¯éŠ·è²»é è¨­å€¼ä¿®æ­£ç‚º $20/kg
- [x] è³‡æ–™åº« schema æ›´æ–°
- [x] å»ºç«‹è³‡æ–™åº«é·ç§»è…³æœ¬
- [x] è²·å…¥çµç®—æ·»åŠ å€Ÿè²¸é¡åº¦æª¢æŸ¥
- [x] æ¯æ—¥çµç®—æ·»åŠ å€Ÿè²¸é¡åº¦æª¢æŸ¥
- [x] æ›´æ–°åŠŸèƒ½æª¢æŸ¥æ¸…å–®
- [x] å»ºç«‹ä¿®æ­£å ±å‘Š

---

**ä¿®æ­£å®Œæˆæ™‚é–“**: 2025-01-19
**ä¿®æ­£æª”æ¡ˆ**: 3 å€‹
**ä¿®æ­£è¡Œæ•¸**: 4 è™•
**ç‹€æ…‹**: âœ… å…¨éƒ¨å®Œæˆï¼Œå¯éƒ¨ç½²
