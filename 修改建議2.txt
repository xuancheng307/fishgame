魚市場遊戲系統完整改進報告
總體評價
首先，這是一套架構完整、功能豐富的遊戲系統。從前後端分離的設計、即時通訊的引入，到詳細的遊戲規則文件，都體現了清晰的設計思路。本報告旨在現有良好基礎上，找出潛在問題並提供具體、可行的改進方案，讓系統更趨穩定、公平且易於維護。

1. 核心功能與安全問題 (Critical Functional & Security Issues)
此類問題應最優先處理，因其直接影響遊戲的正確運行、公平性與系統安全。

1.1 利息扣款機制錯誤
問題描述：遊戲規則文件 (遊戲完整說明.md) 明確指出，每日利息會「從現金中扣除」。然而，伺服器 server.js 的結算函式 (enhancedDailySettlement) 僅將利息累加至總負債 (total_loan)，並未從團隊的現金 (current_budget) 中扣除。

根本影響：這是一個重大的遊戲機制錯誤。它使得高額貸款的團隊不會感受到現金流壓力，極大地削弱了風險管理和資金規劃的策略性，影響了遊戲的公平與挑戰性。

改進建議：在 server.js 的 enhancedDailySettlement 函式中，計算出 interestIncurred (每日利息) 後，必須明確地從團隊的現金 (current_budget) 中扣除這筆費用。

1.2 買入貸款時機錯誤
問題描述：在 server.js 的 /api/team/submit-buy-bids API 中，當團隊提交買入投標時，系統會立即計算所需貸款並更新團隊的總貸款額。然而，投標僅是意向，貸款應在「買入結算」階段，確認成交且資金不足時才實際發生。

根本影響：團隊會因為提交了最終未成交的標單而被錯誤地計入貸款，這是不公平的。

改進建議：從「提交買入投標」的 API 中移除更新團隊貸款的邏輯。該 API 只需檢查投標總額是否在「現金 + 可用貸款額度」的上限內即可。實際的貸款操作應統一在 processBuyBids 函式中，於投標成功結算時執行。

1.3 倒數計時機制缺乏持久化
問題描述：您提到計時器應設定一個所有玩家共享的結束時間，這是正確的設計思路。目前 server.js 的 startTimer 函式確實設定了計時器，但這個結束時間 (endTime) 僅存在於伺服器的記憶體中，並未儲存到資料庫 game_days 表的 buy_end_time 或 sell_end_time 欄位。

根本影響：若伺服器在投標期間重啟，記憶體中的計時器將會丟失，導致該投標階段永遠不會自動結束，遊戲流程將被卡住，必須由管理員手動介入。

改進建議：修改 start-buying 和 start-selling API，在啟動計時器的同時，將計算出的 endTime 寫入資料庫 game_days 表的對應欄位。如此一來，即使伺服器重啟，也能從資料庫讀取這個權威的結束時間，讓所有玩家的倒數計時器保持一致且可靠。

1.4 嚴重安全漏洞：儲存明文密碼
問題描述：users 表中存在 plain_password 欄位，並且 server.js 的登入邏輯會使用它進行驗證。

根本影響：這是極高的安全風險。一旦資料庫洩漏，所有帳號的密碼將直接曝光。

改進建議：立即移除 plain_password 欄位及相關的登入判斷邏輯，強制所有密碼驗證都通過 bcrypt 雜湊比對進行。

2. 規則實作與文件不一致 (Inconsistencies)
此類問題會造成玩家和開發者的困惑，應修正以確保遊戲的透明度和可維護性。

2.1 「固定滯銷」規則實作偏差
問題描述：遊戲說明文件 (遊戲完整說明.md) 指出，在處理最高價 2.5% 的固定滯銷時，應「晚出價者優先滯銷」。但 server.js 的 processSellBids 函式在處理時，是按照投標時間由早到晚的順序進行，邏輯與規則恰好相反。

根本影響：扭曲了遊戲策略，懲罰了較早出高價的玩家。

改進建議：在 processSellBids 函式中，篩選出所有最高價的標單後，應將這些標單按照 created_at 降序排列，然後再從頭開始分配滯銷數量。

2.2 市場參數生成邏輯不符
問題描述：遊戲完整說明.md 描述每日市場參數是在基準值上進行 ±20% 的隨機浮動。但 server.js 的 advance-day 函式中，實際邏輯是基於每日固定的、可預測的係數，再疊加一個 ±5% 的小幅隨機浮動。

根本影響：文件誤導了玩家對市場隨機性的認知，玩家可能會試圖去預測市場的「規律」，而非應對隨機性。

改進建議：應統一文件和程式碼的邏輯。如果希望保留目前的規律性，則應在遊戲說明中誠實地反映這一點。

3. 使用者體驗與程式碼品質 (UX & Code Quality)
此類改進能讓系統更有效率、更易用、更易於維護。

3.1 學生端未使用即時通訊
問題描述：server.js 已經建立了 Socket.IO 服務，並會在遊戲階段變更時廣播事件。但學生端介面 (simple-team.html) 卻是使用 setInterval 定時輪詢 API 來獲取更新，完全沒有利用到即時通訊的優勢。

根本影響：介面更新存在延遲，使用者體驗不佳，且會產生大量不必要的 API 請求，增加伺服器負擔。

改進建議：在 simple-team.html 中引入 Socket.IO 客戶端，監聽後端發送的 phaseChange, timer 等事件，以實現真正即時、高效的介面更新。

3.2 後端 API 結構冗餘
問題描述：後端存在多個功能重複的 API，例如 advance-day 等操作同時存在帶 :gameId 的舊版本和不帶 ID 的新版本。

根本影響：程式碼冗餘，增加維護成本和混淆的可能性。

改進建議：統一前端（主要是 admin.html）的 API 呼叫，全部使用自動尋找當前遊戲的新版本 API，然後安全地移除舊的 API 路由和函式。