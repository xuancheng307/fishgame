# **🐟 魚市場遊戲 \- 資料庫結構完整說明書 (v2)**

## **📋 檔案概述**

來源檔案: fishmarket\_game\_latest.sql  
資料庫名稱: fishmarket\_game  
核心設計思想: 本資料庫結構旨在支援一個多團隊、回合制的經濟模擬遊戲。其設計核心在於清晰地分離遊戲設定、每日動態、團隊決策和財務結果，並透過嚴格的狀態管理 (status 欄位) 來驅動整個遊戲流程。

## **📊 主要資料表結構**

### **1\. 👑 權限與使用者管理 (Authentication & Users)**

#### **users \- 使用者主表**

* **功能**: 儲存所有可登入系統的實體，是所有權限和身份的基礎。**這是目前系統中唯一應該被使用的使用者相關表格。**  
* **欄位詳解**:  
  * id (INT, 主鍵): 唯一的數字ID，用於所有內部關聯。  
  * username (VARCHAR, UNIQUE): 登入帳號，例如 'admin', '01', '02'。  
  * password\_hash (VARCHAR): 使用 bcrypt 加密後的密碼雜湊，用於安全驗證。  
  * plain\_password (VARCHAR): **\[教學輔助\]** 明文密碼，用於簡化課堂管理。  
  * team\_name (VARCHAR): 團隊可自訂的名稱，例如「第一小隊」。  
  * role (ENUM: 'admin', 'team'): 決定用戶權限。  
  * is\_ingame, current\_game\_id, last\_active: **\[可選擴充\]** 用於追蹤使用者即時狀態，目前核心邏輯未使用。

### **2\. 🎮 遊戲核心控制 (Game Core)**

#### **games \- 遊戲主控表**

* **功能**: 定義一場遊戲的所有靜態規則和整體進度。系統中 status \= 'active' 的紀錄應最多只有一筆。  
* **欄位詳解**:  
  * id (INT, 主鍵): 遊戲的唯一ID。  
  * game\_name (VARCHAR): 遊戲名稱。  
  * status (ENUM): **\[流程核心\]** 遊戲的總體狀態。  
    * 'pending': 已創建但未開始。  
    * 'active': **進行中**。  
    * 'paused': 由管理員手動暫停。  
    * 'finished': 正常完成所有天數。  
    * 'force\_ended': 被管理員強制提前結束。  
  * current\_day & total\_days (INT): 當前天數與總天數。  
  * num\_teams (INT): 參與團隊數量。  
  * team\_names (JSON): 儲存隊伍編號與自訂名稱的對應關係，例如 {"1": "海霸王"}。  
  * **財務規則**: initial\_budget, loan\_interest\_rate, unsold\_fee\_per\_kg, fixed\_unsold\_ratio。  
  * **市場參考價**: distributor\_floor\_price\_a/b, target\_price\_a/b。

#### **game\_days \- 每日動態數據表**

* **功能**: 記錄每一天的市場動態參數和流程階段。  
* **欄位詳解**:  
  * id (INT, 主鍵): 當日記錄的唯一ID。  
  * game\_id (INT, 外鍵): 關聯到 games 表。  
  * day\_number (INT): 天數編號 (1, 2, 3...)。  
  * status (ENUM): **\[流程核心\]** 當天的即時階段。  
    * 'pending': 等待開始。  
    * 'buying\_open': **買入投標中**。  
    * 'buying\_closed': 買入投標已結束。  
    * 'selling\_open': **賣出投標中**。  
    * 'selling\_closed': 賣出投標已結束。  
    * 'settled': 當日所有流程已結束。  
  * **市場參數**: fish\_a\_supply, fish\_b\_supply, fish\_a\_restaurant\_budget, fish\_b\_restaurant\_budget。  
  * **時間控制**: buy\_start\_time, buy\_end\_time, sell\_start\_time, sell\_end\_time。

#### **game\_participants \- 遊戲參與者即時狀態表**

* **功能**: 追蹤每個團隊在遊戲中的即時財務狀況和庫存。  
* **欄位詳解**:  
  * id, game\_id, team\_id: 關聯ID。  
  * current\_budget (DECIMAL): **\[名稱注意\]** 團隊當前的**現金**。  
  * total\_loan & total\_loan\_principal (DECIMAL): 總負債(含息)與本金。  
  * fish\_a\_inventory & fish\_b\_inventory (INT): 當前庫存。  
  * cumulative\_profit (DECIMAL): 累計總損益。

### **3\. 📈 交易與決策 (Transactions & Decisions)**

#### **bids \- 統一投標記錄表**

* **功能**: 記錄每一筆由團隊提交的買入或賣出投標。**這是目前系統中唯一應該被使用的投標相關表格。**  
* **欄位詳解**:  
  * id, game\_id, game\_day\_id, team\_id, day\_number: 關聯ID。  
  * bid\_type (ENUM: 'buy', 'sell'): 買單或賣單。  
  * fish\_type (ENUM: 'A', 'B'): 魚種。  
  * price (DECIMAL): 出價。  
  * quantity\_submitted (INT): 希望交易的數量。  
  * quantity\_fulfilled (INT): **\[結算後填入\]** 實際成交數量。  
  * status (ENUM): **\[結算後更新\]** 投標最終狀態 ('pending', 'fulfilled', 'partial', 'failed')。  
  * created\_at (TIMESTAMP): 投標提交時間。

### **4\. 📊 結果與日誌 (Results & Logs)**

#### **daily\_results \- 每日結算報表**

* **功能**: 儲存每日結算後，每個團隊的最終財務報表。  
* **欄位詳解**:  
  * id, game\_id, game\_day\_id, team\_id, day\_number: 關聯ID。  
  * **財務摘要**: revenue, cost, unsold\_fee, interest\_incurred, daily\_profit, cumulative\_profit。  
  * roi (DECIMAL): 當日的投資報酬率 (%)。  
  * closing\_budget & closing\_loan (DECIMAL): 當日結算後的最終現金與總負債。

#### **game\_logs \- 系統操作日誌表**

* **功能**: 記錄管理員或系統的關鍵操作，用於事後追蹤和除錯。  
* **欄位詳解**:  
  * id, game\_id: 日誌ID和關聯的遊戲ID。  
  * action (VARCHAR): 操作類型，例如 'force\_ended'。  
  * details (TEXT): 操作的詳細描述。

## **📦 舊版或已棄用的資料表**

**重要提示**: 以下資料表存在於您的 .sql 檔案中，但其功能已被上述主要表格取代。為確保系統邏輯清晰，**強烈建議在程式碼中不要使用它們**。

* admins: **\[已棄用\]** 功能由 users 表 (role \= 'admin') 取代。  
* teams: **\[已棄用\]** 功能由 users 表 (role \= 'team') 取代。  
* buy\_bids: **\[已棄用\]** 功能由統一的 bids 表 (bid\_type \= 'buy') 取代。  
* sell\_bids: **\[已棄用\]** 功能由統一的 bids 表 (bid\_type \= 'sell') 取代。  
* transactions: **\[功能重疊\]** 此表功能可由 bids 和 daily\_results 表的資訊組合推導出來，為簡化系統可考慮不使用。

## **👓 檢視表 (View)**

#### **v\_team\_rankings \- 團隊排名即時檢視表**

* **功能**: 這不是一個實體資料表，而是一個**虛擬的檢視表 (View)**。它的作用是將 daily\_results, game\_days, games, users 這些表複雜地關聯起來，並**即時計算出每個團隊在每一天的 ROI 和排名**。  
* **使用方式**: 在程式碼中，您可以像查詢普通資料表一樣查詢它 (\`SELECT \* FROM v