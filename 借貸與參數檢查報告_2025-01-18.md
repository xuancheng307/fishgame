# å€Ÿè²¸é‚è¼¯èˆ‡åƒæ•¸åç¨±æª¢æŸ¥å ±å‘Š

**æª¢æŸ¥æ—¥æœŸ**: 2025-01-18
**æª¢æŸ¥é …ç›®**:
1. å€Ÿè²¸é‚è¼¯æ˜¯å¦æ­£ç¢ºåŠ å…¥è³‡é‡‘æ± 
2. æ˜¯å¦æœ‰é‡è¤‡å€Ÿè²¸å•é¡Œ
3. åƒæ•¸åç¨±ä¸€è‡´æ€§

**ç‹€æ…‹**: âœ… æ‰€æœ‰å•é¡Œå·²ä¿®æ­£

---

## ğŸ” æª¢æŸ¥çµæœç¸½è¦½

| æª¢æŸ¥é …ç›® | ç™¼ç¾å•é¡Œ | ç‹€æ…‹ |
|---------|---------|------|
| å€Ÿè²¸é‚è¼¯ | âŒ submit-buy-bids å€Ÿè²¸æœªåŠ å…¥è³‡é‡‘æ±  | âœ… å·²ä¿®æ­£ |
| é‡è¤‡å€Ÿè²¸ | âŒ å…©è™•éƒ½æœ‰å€Ÿè²¸é‚è¼¯ | âœ… å·²ä¿®æ­£ |
| åƒæ•¸å‘½å - daily_results | âŒ ä½¿ç”¨å…¼å®¹æ¬„ä½è€Œéä¸»è¦æ¬„ä½ | âœ… å·²ä¿®æ­£ |
| åƒæ•¸å‘½å - å…¶ä»–è¡¨ | âœ… å‘½åä¸€è‡´ | âœ… é€šé |
| èªæ³•æª¢æŸ¥ | âœ… ç„¡éŒ¯èª¤ | âœ… é€šé |

---

## 1ï¸âƒ£ å€Ÿè²¸é‚è¼¯å•é¡Œèˆ‡ä¿®æ­£

### å•é¡Œ1: submit-buy-bids å€Ÿè²¸é‚è¼¯éŒ¯èª¤

**ä½ç½®**: `server.js:2494-2503` (å·²åˆªé™¤)

**ç™¼ç¾çš„å•é¡Œ**:

```javascript
// âŒ éŒ¯èª¤çš„å¯¦ç¾
// 2494-2503 (å·²åˆªé™¤)
if (loanNeeded > 0) {
    await db.execute(
        `UPDATE game_participants
         SET total_loan = total_loan + ?,
             total_loan_principal = total_loan_principal + ?
         WHERE team_id = ? AND game_id = ?`,
        [loanNeeded, loanNeeded, teamId, gameId]
    );
}
```

**å•é¡Œåˆ†æ**:
1. âŒ å€Ÿè²¸é‡‘é¡æ²’æœ‰åŠ å…¥ `current_budget`ï¼ˆè³‡é‡‘æ± ï¼‰
2. âŒ é•åäº†è¨»è§£èªªæ˜ï¼ˆ2447è¡Œè¨»è§£èªª"ä¸åœ¨æ­¤è™•æ›´æ–°è²¸æ¬¾"ï¼‰
3. âŒ æœƒèˆ‡ processBuyBids ä¸­çš„å€Ÿè²¸é‚è¼¯é‡è¤‡

**ä¿®æ­£æªæ–½**:
```javascript
// âœ… ä¿®æ­£å¾Œï¼šå®Œå…¨åˆªé™¤æ­¤æ®µä»£ç¢¼
// 2494è¡Œæ”¹ç‚ºï¼š
// è²¸æ¬¾å°‡åœ¨è²·å…¥è™•ç†æ™‚æ ¹æ“šå¯¦éš›æˆäº¤é‡‘é¡è‡ªå‹•åŸ·è¡Œï¼Œä¸åœ¨æ­¤è™•é å…ˆå€Ÿè²¸
```

### å•é¡Œ2: processBuyBids ä¸­çš„å€Ÿè²¸é‚è¼¯ï¼ˆæ­£ç¢ºå¯¦ç¾ï¼‰

**ä½ç½®**: `server.js:3390-3399`

**å¯¦ç¾åˆ†æ**:

```javascript
// âœ… æ­£ç¢ºçš„å¯¦ç¾
if (participant[0].current_budget < totalCost) {
    const loanNeeded = totalCost - participant[0].current_budget;
    await connection.execute(
        `UPDATE game_participants
         SET total_loan = total_loan + ?,
             total_loan_principal = total_loan_principal + ?,
             current_budget = current_budget + ?  // âœ… åŠ å…¥è³‡é‡‘æ± 
         WHERE game_id = ? AND team_id = ?`,
        [loanNeeded, loanNeeded, loanNeeded, gameDay.game_id, bid.team_id]
    );
}

// ç„¶å¾Œæ‰£é™¤æˆæœ¬
await connection.execute(
    `UPDATE game_participants
     SET current_budget = current_budget - ?,
         ${fishType === 'A' ? 'fish_a_inventory' : 'fish_b_inventory'} =
         ${fishType === 'A' ? 'fish_a_inventory' : 'fish_b_inventory'} + ?
     WHERE game_id = ? AND team_id = ?`,
    [totalCost, fulfilledQuantity, gameDay.game_id, bid.team_id]
);
```

**æ­£ç¢ºæ€§é©—è­‰**:
1. âœ… æª¢æŸ¥å¯¦éš›æˆäº¤é‡‘é¡æ˜¯å¦è¶…éè³‡é‡‘
2. âœ… å€Ÿè²¸é‡‘é¡åŠ å…¥ `current_budget`ï¼ˆè³‡é‡‘æ± ï¼‰
3. âœ… æ›´æ–° `total_loan` å’Œ `total_loan_principal`
4. âœ… å€Ÿè²¸å¾Œçš„è³‡é‡‘å¯ä»¥ç¹¼çºŒä½¿ç”¨
5. âœ… æ¯å¤©æœƒè¨ˆç®—3%è¤‡åˆ©ï¼ˆåœ¨ enhancedDailySettlement ä¸­ï¼‰

### æ­£ç¢ºçš„å€Ÿè²¸æµç¨‹

```
1. å­¸ç”Ÿæäº¤è²·å…¥æŠ•æ¨™
   â””â”€ submit-buy-bids: åªæª¢æŸ¥æ˜¯å¦è¶…éå€Ÿè²¸ä¸Šé™ï¼Œä¸å¯¦éš›å€Ÿè²¸

2. ç®¡ç†å“¡è™•ç†è²·å…¥æŠ•æ¨™
   â””â”€ processBuyBids:
       â”œâ”€ éæ­·æ¯å€‹æˆäº¤çš„æŠ•æ¨™
       â”œâ”€ æª¢æŸ¥è³‡é‡‘æ˜¯å¦è¶³å¤ 
       â”œâ”€ å¦‚æœä¸è¶³ï¼Œè‡ªå‹•å€Ÿè²¸
       â”‚   â”œâ”€ æ›´æ–° total_loan += loanNeeded
       â”‚   â”œâ”€ æ›´æ–° total_loan_principal += loanNeeded
       â”‚   â””â”€ æ›´æ–° current_budget += loanNeeded  â­ åŠ å…¥è³‡é‡‘æ± 
       â””â”€ æ‰£é™¤æˆæœ¬ï¼Œå¢åŠ åº«å­˜

3. æ¯æ—¥çµç®—
   â””â”€ enhancedDailySettlement:
       â”œâ”€ è¨ˆç®—åˆ©æ¯: interestIncurred = total_loan Ã— 3%
       â”œâ”€ æ›´æ–°å€Ÿè²¸: total_loan += interestIncurred
       â”œâ”€ æ‰£é™¤åˆ©æ¯: current_budget -= interestIncurred
       â””â”€ æ‰£é™¤æ»¯éŠ·è²»: current_budget -= unsoldFee
```

### å€Ÿè²¸é‡‘é¡çš„ç”Ÿå‘½é€±æœŸ

```
éšæ®µ1: æäº¤æŠ•æ¨™
  current_budget: $100,000
  total_loan: $0
  æŠ•æ¨™ç¸½é¡: $150,000
  â†’ æª¢æŸ¥: $150,000 â‰¤ $100,000 + ($1,000,000 Ã— 50%) = $600,000 âœ…

éšæ®µ2: è™•ç†æŠ•æ¨™ï¼ˆå¯¦éš›å€Ÿè²¸ï¼‰
  éœ€è¦å€Ÿè²¸: $150,000 - $100,000 = $50,000

  åŸ·è¡Œå€Ÿè²¸:
    total_loan: $0 â†’ $50,000
    total_loan_principal: $0 â†’ $50,000
    current_budget: $100,000 â†’ $150,000  â­ å€Ÿä¾†çš„éŒ¢åŠ å…¥è³‡é‡‘æ± 

  æ‰£é™¤æˆæœ¬:
    current_budget: $150,000 â†’ $0
    inventory: 0kg â†’ æŸæ•¸é‡

éšæ®µ3: ç¬¬1å¤©çµç®—
  è¨ˆç®—åˆ©æ¯:
    interest = $50,000 Ã— 3% = $1,500
    total_loan: $50,000 â†’ $51,500
    current_budget: $0 - $1,500 â†’ -$1,500

  è‡ªå‹•å†å€Ÿè²¸ï¼ˆå¦‚æœé ç®—ç‚ºè² ï¼‰:
    additional_loan = $1,500
    total_loan: $51,500 â†’ $53,000
    total_loan_principal: $50,000 â†’ $51,500
    current_budget: -$1,500 â†’ $0

éšæ®µ4: å¾ŒçºŒå¤©æ•¸
  æ¯å¤©ç´¯ç© 3% è¤‡åˆ©
  ç¬¬2å¤©: $53,000 Ã— 3% = $1,590
  ç¬¬3å¤©: $54,590 Ã— 3% = $1,637.70
  ...
```

---

## 2ï¸âƒ£ åƒæ•¸åç¨±ä¸€è‡´æ€§å•é¡Œèˆ‡ä¿®æ­£

### å•é¡Œ: daily_results è¡¨ä½¿ç”¨éŒ¯èª¤çš„å…¼å®¹æ¬„ä½

**è³‡æ–™åº«è¨­è¨ˆ**:

`daily_results` è¡¨æœ‰å…©å¥—æ¬„ä½åç¨±ï¼š

| ä¸»è¦æ¬„ä½ (æ‡‰ä½¿ç”¨) | å…¼å®¹æ¬„ä½ (èˆŠç‰ˆæœ¬) | èªªæ˜ |
|------------------|------------------|------|
| `starting_cash` | - | é–‹å§‹æ™‚çš„è³‡é‡‘ |
| `ending_cash` | `closing_budget` âŒ | çµæŸæ™‚çš„è³‡é‡‘ |
| `starting_loan` | - | é–‹å§‹æ™‚çš„å€Ÿè²¸ |
| `ending_loan` | `closing_loan` âŒ | çµæŸæ™‚çš„å€Ÿè²¸ |
| `buy_cost` | `cost` âŒ | è²·å…¥æˆæœ¬ |
| `sell_revenue` | `revenue` âŒ | è³£å‡ºæ”¶å…¥ |
| `interest_paid` | `interest_incurred` âŒ | åˆ©æ¯æ”¯å‡º |
| `fish_a_bought` | - | Aç´šé­šè²·å…¥é‡ |
| `fish_a_sold` | - | Aç´šé­šè³£å‡ºé‡ |
| `fish_a_unsold` | - | Aç´šé­šæ»¯éŠ·é‡ |
| `fish_b_bought` | - | Bç´šé­šè²·å…¥é‡ |
| `fish_b_sold` | - | Bç´šé­šè³£å‡ºé‡ |
| `fish_b_unsold` | - | Bç´šé­šæ»¯éŠ·é‡ |

### ä¿®æ­£1: INSERT èªå¥ä½¿ç”¨æ­£ç¢ºæ¬„ä½

**ä½ç½®**: `server.js:3774-3814`

**ä¿®æ­£å‰** (ä½¿ç”¨å…¼å®¹æ¬„ä½):
```javascript
// âŒ éŒ¯èª¤çš„å¯¦ç¾
await connection.execute(
    `INSERT INTO daily_results (
        game_id, game_day_id, day_number, team_id,
        revenue, cost, unsold_fee, interest_incurred,  // âŒ å…¼å®¹æ¬„ä½
        daily_profit, cumulative_profit, roi,
        closing_budget, closing_loan  // âŒ å…¼å®¹æ¬„ä½
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [...]
);
```

**ä¿®æ­£å¾Œ** (ä½¿ç”¨ä¸»è¦æ¬„ä½):
```javascript
// âœ… æ­£ç¢ºçš„å¯¦ç¾
await connection.execute(
    `INSERT INTO daily_results (
        game_id, game_day_id, day_number, team_id,
        starting_cash, ending_cash,                    // âœ… ä¸»è¦æ¬„ä½
        starting_loan, ending_loan,                    // âœ… ä¸»è¦æ¬„ä½
        fish_a_bought, fish_a_sold, fish_a_unsold,    // âœ… å®Œæ•´è³‡æ–™
        fish_b_bought, fish_b_sold, fish_b_unsold,    // âœ… å®Œæ•´è³‡æ–™
        buy_cost, sell_revenue, unsold_fee, interest_paid,  // âœ… ä¸»è¦æ¬„ä½
        daily_profit, cumulative_profit, roi
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [
        gameId,
        gameDayId,
        dayNumber,
        participant.team_id,
        currentBudget.toFixed(2),          // starting_cash
        newBudget.toFixed(2),              // ending_cash
        currentLoan.toFixed(2),            // starting_loan
        finalTotalLoan.toFixed(2),         // ending_loan
        fishABought,                       // fish_a_bought
        fishASold,                         // fish_a_sold
        fishAUnsold,                       // fish_a_unsold
        fishBBought,                       // fish_b_bought
        fishBSold,                         // fish_b_sold
        fishBUnsold,                       // fish_b_unsold
        totalCost.toFixed(2),              // buy_cost
        totalRevenue.toFixed(2),           // sell_revenue
        unsoldFee.toFixed(2),              // unsold_fee
        interestIncurred.toFixed(2),       // interest_paid
        dailyProfit.toFixed(2),            // daily_profit
        cumulativeProfit.toFixed(2),       // cumulative_profit
        roi.toFixed(2)                     // roi
    ]
);
```

**æ”¹é€²**:
1. âœ… ä½¿ç”¨ä¸»è¦æ¬„ä½è€Œéå…¼å®¹æ¬„ä½
2. âœ… æ·»åŠ  `starting_cash`, `starting_loan`
3. âœ… æ·»åŠ å®Œæ•´çš„é­šé¡è²·è³£çµ±è¨ˆï¼ˆA/Bå„3å€‹æ¬„ä½ï¼‰
4. âœ… æ¬„ä½èªæ„æ›´æ¸…æ™°ï¼ˆbuy_cost vs costï¼‰

### ä¿®æ­£2: SELECT èªå¥ä½¿ç”¨æ­£ç¢ºæ¬„ä½

**ä½ç½®**: `server.js:2834-2853`

**ä¿®æ­£å‰** (ä½¿ç”¨å…¼å®¹æ¬„ä½):
```javascript
// âŒ éŒ¯èª¤çš„å¯¦ç¾
const [results] = await db.execute(
    `SELECT dr.id, dr.game_day_id, dr.team_id, dr.day_number,
            dr.revenue, dr.cost, dr.unsold_fee, dr.interest_incurred,  // âŒ
            dr.daily_profit, dr.cumulative_profit, dr.roi,
            dr.closing_budget, dr.closing_loan,  // âŒ
            u.username, u.team_name
     FROM daily_results dr
     ...`
);
```

**ä¿®æ­£å¾Œ** (ä½¿ç”¨ä¸»è¦æ¬„ä½):
```javascript
// âœ… æ­£ç¢ºçš„å¯¦ç¾
const [results] = await db.execute(
    `SELECT dr.id, dr.game_day_id, dr.team_id, dr.day_number,
            dr.starting_cash, dr.ending_cash,  // âœ…
            dr.starting_loan, dr.ending_loan,  // âœ…
            dr.fish_a_bought, dr.fish_a_sold, dr.fish_a_unsold,  // âœ…
            dr.fish_b_bought, dr.fish_b_sold, dr.fish_b_unsold,  // âœ…
            dr.buy_cost, dr.sell_revenue, dr.unsold_fee, dr.interest_paid,  // âœ…
            dr.daily_profit, dr.cumulative_profit, dr.roi,
            u.username, u.team_name
     FROM daily_results dr
     ...`
);
```

---

## 3ï¸âƒ£ å…¶ä»–åƒæ•¸åç¨±æª¢æŸ¥

### âœ… é€šéï¼šå…¼å®¹æ€§è™•ç†æ­£ç¢º

å¤§å¤šæ•¸åƒæ•¸åœ¨ä»£ç¢¼ä¸­éƒ½æœ‰æ­£ç¢ºçš„å…¼å®¹æ€§è™•ç†ï¼š

**ç¤ºä¾‹1: fishType**
```javascript
// å…¼å®¹å‰ç«¯å¯èƒ½å‚³ä¾†çš„å…©ç¨®å‘½å
const fishType = bid.fish_type || bid.fishType;
```

**ç¤ºä¾‹2: initialBudget**
```javascript
// å…¼å®¹å‰ç«¯å¯èƒ½å‚³ä¾†çš„å…©ç¨®å‘½å
const initialBudget = b.initialBudget ?? b.initial_budget;
```

**å‘½åè¦å‰‡**:
- SQL æ¬„ä½: `snake_case` (ä¾‹: `initial_budget`)
- JavaScript è®Šæ•¸: `camelCase` (ä¾‹: `initialBudget`)
- req.body: å…¼å®¹å…©ç¨® (ä¾‹: `b.initialBudget ?? b.initial_budget`)

### âš ï¸ æ³¨æ„ï¼šloan_interest_rate vs daily_interest_rate

**è³‡æ–™åº«è¨­è¨ˆ**:
```sql
`daily_interest_rate` decimal(5,4) NOT NULL DEFAULT 0.0300,
`loan_interest_rate` decimal(5,4) NOT NULL DEFAULT 0.0300 COMMENT 'è²¸æ¬¾åˆ©ç‡(å…¼å®¹æ¬„ä½)',
```

**ç¾æ³åˆ†æ**:
- `daily_interest_rate` æ˜¯ä¸»è¦æ¬„ä½
- `loan_interest_rate` æ¨™è¨˜ç‚ºå…¼å®¹æ¬„ä½
- **ä½†ä»£ç¢¼ä¸­ä½¿ç”¨ `loan_interest_rate`**

**æ±ºç­–**: ä¿æŒç¾ç‹€

**ç†ç”±**:
1. âœ… `loan_interest_rate` èªæ„æ›´æº–ç¢ºï¼ˆé€™æ˜¯è²¸æ¬¾åˆ©ç‡ï¼‰
2. âœ… ä»£ç¢¼ä¸­å·²å»£æ³›ä½¿ç”¨ `loan_interest_rate`
3. âœ… å…©å€‹æ¬„ä½å€¼ç›¸åŒï¼Œä¸å½±éŸ¿åŠŸèƒ½
4. âš ï¸ å»ºè­°æœªä¾†çµ±ä¸€ä½¿ç”¨ `loan_interest_rate` ä¸¦ç§»é™¤ `daily_interest_rate`

---

## 4ï¸âƒ£ å®Œæ•´çš„åƒæ•¸å°ç…§è¡¨

### games è¡¨

| è³‡æ–™åº«æ¬„ä½ | JavaScript è®Šæ•¸ | ç‹€æ…‹ |
|-----------|----------------|------|
| `initial_budget` | `initialBudget` | âœ… ä¸€è‡´ |
| `loan_interest_rate` | `loanInterestRate` | âœ… ä½¿ç”¨ä¸­ |
| `daily_interest_rate` | - | âš ï¸ æœªä½¿ç”¨ï¼ˆå…¼å®¹ï¼‰ |
| `max_loan_ratio` | `maxLoanRatio` | âœ… ä¸€è‡´ |
| `unsold_fee_per_kg` | `unsoldFeePerKg` | âœ… ä¸€è‡´ |
| `fixed_unsold_ratio` | `fixedUnsoldRatio` | âœ… ä¸€è‡´ |
| `distributor_floor_price_a` | `distributorFloorPriceA` | âœ… ä¸€è‡´ |
| `distributor_floor_price_b` | `distributorFloorPriceB` | âœ… ä¸€è‡´ |
| `target_price_a` | `targetPriceA` | âœ… ä¸€è‡´ |
| `target_price_b` | `targetPriceB` | âœ… ä¸€è‡´ |
| `num_teams` | `numTeams` | âœ… ä¸€è‡´ |
| `total_days` | `totalDays` | âœ… ä¸€è‡´ |
| `buying_duration` | `buyingDuration` | âœ… ä¸€è‡´ |
| `selling_duration` | `sellingDuration` | âœ… ä¸€è‡´ |

### game_participants è¡¨

| è³‡æ–™åº«æ¬„ä½ | JavaScript è®Šæ•¸ | ç‹€æ…‹ |
|-----------|----------------|------|
| `current_budget` | `currentBudget` | âœ… ä¸€è‡´ |
| `total_loan` | `totalLoan` | âœ… ä¸€è‡´ |
| `total_loan_principal` | `totalLoanPrincipal` | âœ… ä¸€è‡´ |
| `fish_a_inventory` | `fishAInventory` | âœ… ä¸€è‡´ |
| `fish_b_inventory` | `fishBInventory` | âœ… ä¸€è‡´ |
| `cumulative_profit` | `cumulativeProfit` | âœ… ä¸€è‡´ |
| `roi` | `roi` | âœ… ä¸€è‡´ |

### daily_results è¡¨ï¼ˆä¿®æ­£å¾Œï¼‰

| è³‡æ–™åº«æ¬„ä½ (ä¸»è¦) | è³‡æ–™åº«æ¬„ä½ (å…¼å®¹) | ä½¿ç”¨ç‹€æ…‹ |
|-----------------|------------------|---------|
| `starting_cash` | - | âœ… ä½¿ç”¨ä¸­ |
| `ending_cash` | `closing_budget` | âœ… ä½¿ç”¨ä¸»è¦æ¬„ä½ |
| `starting_loan` | - | âœ… ä½¿ç”¨ä¸­ |
| `ending_loan` | `closing_loan` | âœ… ä½¿ç”¨ä¸»è¦æ¬„ä½ |
| `buy_cost` | `cost` | âœ… ä½¿ç”¨ä¸»è¦æ¬„ä½ |
| `sell_revenue` | `revenue` | âœ… ä½¿ç”¨ä¸»è¦æ¬„ä½ |
| `interest_paid` | `interest_incurred` | âœ… ä½¿ç”¨ä¸»è¦æ¬„ä½ |
| `fish_a_bought` | - | âœ… ä½¿ç”¨ä¸­ |
| `fish_a_sold` | - | âœ… ä½¿ç”¨ä¸­ |
| `fish_a_unsold` | - | âœ… ä½¿ç”¨ä¸­ |
| `fish_b_bought` | - | âœ… ä½¿ç”¨ä¸­ |
| `fish_b_sold` | - | âœ… ä½¿ç”¨ä¸­ |
| `fish_b_unsold` | - | âœ… ä½¿ç”¨ä¸­ |

### bids è¡¨

| è³‡æ–™åº«æ¬„ä½ | JavaScript è®Šæ•¸ | ç‹€æ…‹ |
|-----------|----------------|------|
| `bid_type` | `bidType` | âœ… å…¼å®¹è™•ç† |
| `fish_type` | `fishType` | âœ… å…¼å®¹è™•ç† |
| `quantity_submitted` | `quantitySubmitted` | âœ… ä¸€è‡´ |
| `quantity_fulfilled` | `quantityFulfilled` | âœ… ä¸€è‡´ |
| `price_index` | `priceIndex` | âœ… ä¸€è‡´ |

---

## 5ï¸âƒ£ ä¿®æ­£ç¸½çµ

### æœ¬æ¬¡ä¿®æ­£æª”æ¡ˆ

| æª”æ¡ˆ | ä¿®æ­£é …ç›® | è¡Œæ•¸ |
|------|---------|------|
| `backend/server.js` | åˆªé™¤ submit-buy-bids ä¸­çš„éŒ¯èª¤å€Ÿè²¸é‚è¼¯ | 2494-2503 |
| `backend/server.js` | ä¿®æ­£ daily_results INSERT ä½¿ç”¨ä¸»è¦æ¬„ä½ | 3774-3814 |
| `backend/server.js` | ä¿®æ­£ daily_results SELECT ä½¿ç”¨ä¸»è¦æ¬„ä½ | 2834-2853 |

### ä¿®æ­£å½±éŸ¿åˆ†æ

**å€Ÿè²¸é‚è¼¯ä¿®æ­£**:
- âœ… æ¶ˆé™¤é‡è¤‡å€Ÿè²¸é¢¨éšª
- âœ… å€Ÿè²¸é‡‘é¡æ­£ç¢ºåŠ å…¥è³‡é‡‘æ± 
- âœ… å€Ÿè²¸å¾Œçš„è³‡é‡‘å¯ä»¥ç¹¼çºŒä½¿ç”¨
- âœ… æ¯å¤©ç´¯ç©3%è¤‡åˆ©
- âœ… ç¬¦åˆéŠæˆ²è¦å‰‡ï¼šè¶Šæ—©å€Ÿè²¸ç¸½æˆæœ¬è¶Šé«˜

**åƒæ•¸å‘½åä¿®æ­£**:
- âœ… ä½¿ç”¨èªæ„æ›´æ¸…æ™°çš„ä¸»è¦æ¬„ä½
- âœ… æ·»åŠ å®Œæ•´çš„æ¯æ—¥çµ±è¨ˆè³‡æ–™
- âœ… æé«˜è³‡æ–™ä¸€è‡´æ€§
- âœ… ä¾¿æ–¼å‰ç«¯é¡¯ç¤ºå’ŒæŸ¥è©¢

---

## 6ï¸âƒ£ æ¸¬è©¦å»ºè­°

### å€Ÿè²¸é‚è¼¯æ¸¬è©¦

**æ¸¬è©¦æ¡ˆä¾‹1: åŸºæœ¬å€Ÿè²¸**
```
åˆå§‹ç‹€æ…‹:
  current_budget: $100,000
  total_loan: $0

æäº¤æŠ•æ¨™: $150,000

é æœŸçµæœ:
  processBuyBids åŸ·è¡Œå¾Œ:
    - è‡ªå‹•å€Ÿè²¸ $50,000
    - current_budget: $0
    - total_loan: $50,000
    - total_loan_principal: $50,000
```

**æ¸¬è©¦æ¡ˆä¾‹2: è¤‡åˆ©è¨ˆç®—**
```
ç¬¬0å¤©:
  total_loan: $50,000

ç¬¬1å¤©çµç®—:
  interest = $50,000 Ã— 3% = $1,500
  total_loan: $51,500
  current_budget -= $1,500

ç¬¬2å¤©çµç®—:
  interest = $51,500 Ã— 3% = $1,545
  total_loan: $53,045

ç¬¬7å¤©:
  total_loan â‰ˆ $61,468
```

**æ¸¬è©¦æ¡ˆä¾‹3: å€Ÿè²¸ä¸Šé™æª¢æŸ¥**
```
åˆå§‹ç‹€æ…‹:
  initial_budget: $1,000,000
  max_loan_ratio: 50%
  current_budget: $100,000
  total_loan: $500,000 (å·²é”ä¸Šé™)

æäº¤æŠ•æ¨™: $200,000

é æœŸçµæœ:
  - å¯ç”¨è³‡é‡‘ = $100,000 + ($500,000 - $500,000) = $100,000
  - æŠ•æ¨™è¢«æ‹’çµ•ï¼ˆè¶…éå¯ç”¨è³‡é‡‘ï¼‰
```

### daily_results è³‡æ–™é©—è­‰

**é©—è­‰ SQL**:
```sql
-- æª¢æŸ¥ç¬¬1å¤©çš„çµç®—è³‡æ–™æ˜¯å¦å®Œæ•´
SELECT
    team_id,
    starting_cash, ending_cash,
    starting_loan, ending_loan,
    fish_a_bought, fish_a_sold, fish_a_unsold,
    fish_b_bought, fish_b_sold, fish_b_unsold,
    buy_cost, sell_revenue, unsold_fee, interest_paid,
    daily_profit, cumulative_profit, roi
FROM daily_results
WHERE day_number = 1;
```

**é æœŸæ¬„ä½**:
- âœ… æ‰€æœ‰æ¬„ä½éƒ½æœ‰æ•¸æ“šï¼ˆä¸æ˜¯ NULLï¼‰
- âœ… starting_cash + å€Ÿè²¸ = buy_cost
- âœ… ending_cash = starting_cash - unsold_fee - interest_paid
- âœ… daily_profit = sell_revenue - buy_cost - unsold_fee - interest_paid

---

## 7ï¸âƒ£ å›æ­¸æ¸¬è©¦æ¸…å–®

åŸ·è¡Œä»¥ä¸‹æª¢æŸ¥ç¢ºä¿ä¿®æ­£ç„¡èª¤ï¼š

- [x] `node --check backend/server.js` èªæ³•æª¢æŸ¥é€šé
- [ ] `node backend/test-logic.js` é‚è¼¯æ¸¬è©¦é€šé
- [ ] æäº¤è²·å…¥æŠ•æ¨™ä¸æœƒé å…ˆå€Ÿè²¸
- [ ] è™•ç†è²·å…¥æŠ•æ¨™æ™‚æ­£ç¢ºå€Ÿè²¸ä¸¦åŠ å…¥è³‡é‡‘æ± 
- [ ] å€Ÿè²¸å¾Œçš„è³‡é‡‘å¯ä»¥ä½¿ç”¨
- [ ] æ¯æ—¥çµç®—æ­£ç¢ºè¨ˆç®—3%è¤‡åˆ©
- [ ] daily_results è¡¨ä½¿ç”¨ä¸»è¦æ¬„ä½
- [ ] daily_results åŒ…å«å®Œæ•´çš„çµ±è¨ˆè³‡æ–™
- [ ] æ‰€æœ‰æŸ¥è©¢éƒ½ä½¿ç”¨ä¸€è‡´çš„æ¬„ä½åç¨±

---

## 8ï¸âƒ£ å»ºè­°æ”¹é€²

### çŸ­æœŸæ”¹é€²

1. **æ¸¬è©¦å€Ÿè²¸æµç¨‹**: å‰µå»ºå®Œæ•´çš„å€Ÿè²¸æ¸¬è©¦æ¡ˆä¾‹
2. **é©—è­‰è³‡æ–™å®Œæ•´æ€§**: æª¢æŸ¥ daily_results è³‡æ–™æ˜¯å¦å®Œæ•´
3. **å‰ç«¯é©é…**: ç¢ºèªå‰ç«¯æ­£ç¢ºè®€å–æ–°çš„æ¬„ä½åç¨±

### é•·æœŸæ”¹é€²

1. **çµ±ä¸€åˆ©ç‡æ¬„ä½**:
   - æ±ºå®šä½¿ç”¨ `loan_interest_rate` æˆ– `daily_interest_rate`
   - ç§»é™¤ä¸ä½¿ç”¨çš„å…¼å®¹æ¬„ä½

2. **æ¸…ç†å…¼å®¹æ¬„ä½**:
   - ç¢ºèªæ‰€æœ‰å…¼å®¹æ¬„ä½éƒ½å·²ä¸ä½¿ç”¨å¾Œ
   - å¾è³‡æ–™åº« schema ä¸­ç§»é™¤

3. **æ–‡æª”å®Œå–„**:
   - æ›´æ–° API æ–‡æª”èªªæ˜å€Ÿè²¸æµç¨‹
   - æ›´æ–°è³‡æ–™åº«æ–‡æª”èªªæ˜æ¬„ä½å‘½åè¦å‰‡

---

## 9ï¸âƒ£ å¿«é€Ÿåƒè€ƒ

### å€Ÿè²¸é—œéµè®Šæ•¸

```javascript
// game_participants è¡¨
current_budget        // ç•¶å‰å¯ç”¨è³‡é‡‘ï¼ˆåŒ…å«å€Ÿä¾†çš„éŒ¢ï¼‰
total_loan           // ç•¶å‰ç¸½å€Ÿè²¸ï¼ˆæœ¬é‡‘ + ç´¯ç©åˆ©æ¯ï¼‰
total_loan_principal // ç¸½å€Ÿè²¸æœ¬é‡‘ï¼ˆä¸å«åˆ©æ¯ï¼‰
```

### å€Ÿè²¸è¨ˆç®—å…¬å¼

```javascript
// æ¯æ—¥åˆ©æ¯
interestIncurred = total_loan Ã— loan_interest_rate

// æ–°çš„ç¸½å€Ÿè²¸
newTotalLoan = total_loan + interestIncurred

// æ‰£é™¤åˆ©æ¯
newBudget = current_budget - interestIncurred
```

### daily_results ä¸»è¦æ¬„ä½

```
è³‡é‡‘æµ:
  starting_cash â†’ ending_cash
  starting_loan â†’ ending_loan

é­šé¡çµ±è¨ˆ:
  fish_a_bought â†’ fish_a_sold â†’ fish_a_unsold
  fish_b_bought â†’ fish_b_sold â†’ fish_b_unsold

è²¡å‹™çµ±è¨ˆ:
  buy_cost + unsold_fee + interest_paid = æ”¯å‡º
  sell_revenue = æ”¶å…¥
  daily_profit = æ”¶å…¥ - æ”¯å‡º
```

---

**æª¢æŸ¥ç‹€æ…‹**: âœ… æ‰€æœ‰å•é¡Œå·²ä¿®æ­£
**èªæ³•æª¢æŸ¥**: âœ… é€šé
**ä¸‹ä¸€æ­¥**: åŸ·è¡Œå®Œæ•´æ¸¬è©¦ï¼Œé©—è­‰å€Ÿè²¸é‚è¼¯å’Œè³‡æ–™å®Œæ•´æ€§

**æ–‡æª”ç¶­è­·**: Claude Code
