# é­šå¸‚å ´éŠæˆ² - å®Œæ•´ç³»çµ±æ¡†æ¶

**å»ºç«‹æ—¥æœŸ**: 2025-12-01
**ç›®çš„**: å»ºç«‹å®Œæ•´ç³»çµ±ç†è§£ï¼Œä½œç‚ºå…¨é¢ä¿®å¾©çš„åŸºç¤

---

## ä¸€ã€ç³»çµ±æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ä»‹é¢å±¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  admin.html  â”‚  â”‚  team.html   â”‚  â”‚  index.html  â”‚  â”‚
â”‚  â”‚  (ç®¡ç†å“¡)     â”‚  â”‚  (å­¸ç”Ÿåœ˜éšŠ)   â”‚  â”‚  (ç™»å…¥)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¾Œç«¯ API å±¤                            â”‚
â”‚              backend/server.js (Express)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ èªè­‰ â”‚ éŠæˆ²ç®¡ç† â”‚ æŠ•æ¨™ â”‚ çµç®— â”‚ WebSocket(Socket.IO) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Railway MySQL è³‡æ–™åº«                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚users â”‚ â”‚  games   â”‚ â”‚game_days  â”‚ â”‚game_         â”‚ â”‚
â”‚  â”‚      â”‚ â”‚          â”‚ â”‚           â”‚ â”‚participants  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚bids  â”‚ â”‚daily_results â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€è³‡æ–™åº«æ¶æ§‹ï¼ˆRailway å¯¦éš›ï¼‰

### 2.1 æ ¸å¿ƒè¡¨é—œä¿‚

```
games (éŠæˆ²)
  â”œâ”€â†’ game_days (éŠæˆ²å¤©æ•¸)
  â”‚     â””â”€â†’ bids (æŠ•æ¨™)
  â”‚     â””â”€â†’ daily_results (æ¯æ—¥çµç®—)
  â””â”€â†’ game_participants (åƒèˆ‡è€…)
        â””â”€â†’ users (åœ˜éšŠ)
```

### 2.2 ç‹€æ…‹ç®¡ç†é›™è»Œåˆ¶

**é‡è¦è¨­è¨ˆæ±ºç­–**ï¼š
- `games.phase` - éŠæˆ²æ•´é«”éšæ®µï¼ˆå‰ç«¯é¡¯ç¤ºç”¨ï¼‰
- `game_days.status` - ç•¶æ—¥å…·é«”ç‹€æ…‹ï¼ˆå¾Œç«¯é‚è¼¯ç”¨ï¼‰

**ç‹€æ…‹å°æ‡‰é—œä¿‚**ï¼š
| games.phase | game_days.status | èªªæ˜ |
|-------------|------------------|------|
| waiting | pending | ç­‰å¾…é–‹å§‹ |
| buying | buying_open | è²·å…¥æŠ•æ¨™ä¸­ |
| buying_closed | buying_closed | è²·å…¥å·²é—œé–‰ |
| selling | selling_open | è³£å‡ºæŠ•æ¨™ä¸­ |
| selling_closed | selling_closed | è³£å‡ºå·²é—œé–‰ |
| settling | settled | çµç®—ä¸­ |
| day_ended | settled | ç•¶æ—¥çµæŸ |

### 2.3 å®Œæ•´è¡¨çµæ§‹ï¼ˆ26å€‹æ¬„ä½ï¼‰

#### games è¡¨
```sql
id, name, description, status, phase, total_days, current_day,
num_teams, initial_budget, daily_interest_rate, loan_interest_rate,
max_loan_ratio, unsold_fee_per_kg, fixed_unsold_ratio,
distributor_floor_price_a, distributor_floor_price_b,
target_price_a, target_price_b, buying_duration, selling_duration,
created_at, updated_at, team_names, is_force_ended,
force_ended_at, force_end_day
```

**é—œéµæ¬„ä½**ï¼š
- `name` (NOT game_name) - VARCHAR(100)
- `status` - ENUM('pending','active','paused','finished','force_ended')
- `phase` - ENUM('waiting','buying','buying_closed','selling','selling_closed','settling','day_ended')

#### game_days è¡¨
```sql
id, game_id, day_number, fish_a_supply, fish_b_supply,
fish_a_restaurant_budget, fish_b_restaurant_budget, status
```

**status ENUM**ï¼š
- 'pending', 'buying_open', 'buying_closed', 'selling_open', 'selling_closed', 'settled'

#### bids è¡¨
```sql
id, game_id, game_day_id, day_number, team_id, bid_type,
fish_type, price, quantity_submitted, quantity_fulfilled,
status, created_at
```

**ENUM å€¼**ï¼š
- bid_type: 'buy', 'sell'
- fish_type: 'A', 'B'
- status: 'pending', 'fulfilled', 'partial', 'failed'

---

## ä¸‰ã€éŠæˆ²æµç¨‹èˆ‡ç‹€æ…‹è½‰æ›

### 3.1 å®Œæ•´éŠæˆ²æµç¨‹

```
1. å‰µå»ºéŠæˆ² (POST /api/admin/games)
   â†“ games.status = 'active', phase = 'waiting'

2. é–‹å§‹è²·å…¥æŠ•æ¨™ (POST /api/admin/games/:id/start-buying)
   â†“ games.phase = 'buying', game_days.status = 'buying_open'

3. é—œé–‰è²·å…¥æŠ•æ¨™ (POST /api/admin/games/:id/close-buying)
   â†“ games.phase = 'buying_closed', game_days.status = 'buying_closed'
   â†“ åŸ·è¡Œ processBuyBids() çµç®—

4. é–‹å§‹è³£å‡ºæŠ•æ¨™ (POST /api/admin/games/:id/start-selling)
   â†“ games.phase = 'selling', game_days.status = 'selling_open'

5. é—œé–‰è³£å‡ºæŠ•æ¨™ (POST /api/admin/games/:id/close-selling)
   â†“ games.phase = 'selling_closed', game_days.status = 'selling_closed'
   â†“ åŸ·è¡Œ processSellBids() çµç®—

6. åŸ·è¡Œæ¯æ—¥çµç®— (POST /api/admin/games/:id/settle)
   â†“ games.phase = 'settling', game_days.status = 'settled'
   â†“ è¨ˆç®—åˆ©æ¯ã€æ»¯éŠ·è²»ã€ROIç­‰

7. æ¨é€²åˆ°ä¸‹ä¸€å¤© (POST /api/admin/games/:id/next-day)
   â†“ games.current_day++, phase = 'waiting'
   â†“ å‰µå»ºæ–°çš„ game_days è¨˜éŒ„
```

### 3.2 é—œéµæ›´æ–°é»ï¼ˆå¿…é ˆåŒæ­¥æ›´æ–°ï¼‰

æ¯æ¬¡ç‹€æ…‹è®Šæ›´æ™‚ï¼Œå¿…é ˆåŒæ™‚æ›´æ–°ï¼š
1. `game_days.status` - æ›´æ–°ç•¶æ—¥ç‹€æ…‹
2. `games.phase` - æ›´æ–°éŠæˆ²éšæ®µ
3. WebSocket å»£æ’­ - é€šçŸ¥æ‰€æœ‰å®¢æˆ¶ç«¯

---

## å››ã€API ç«¯é»åˆ†é¡

### 4.1 èªè­‰ç›¸é—œ
- POST /api/login - ç™»å…¥
- POST /api/logout - ç™»å‡º
- POST /api/admin/reset-passwords - é‡ç½®å¯†ç¢¼

### 4.2 éŠæˆ²ç®¡ç†ï¼ˆç®¡ç†å“¡ï¼‰
- POST /api/admin/games - å‰µå»ºéŠæˆ²
- GET /api/admin/games - ç²å–éŠæˆ²åˆ—è¡¨
- GET /api/admin/games/:id - ç²å–éŠæˆ²è©³æƒ…
- POST /api/admin/games/:id/start-buying - é–‹å§‹è²·å…¥
- POST /api/admin/games/:id/close-buying - é—œé–‰è²·å…¥
- POST /api/admin/games/:id/start-selling - é–‹å§‹è³£å‡º
- POST /api/admin/games/:id/close-selling - é—œé–‰è³£å‡º
- POST /api/admin/games/:id/settle - æ¯æ—¥çµç®—
- POST /api/admin/games/:id/next-day - æ¨é€²ä¸‹ä¸€å¤©
- POST /api/admin/games/:id/force-end - å¼·åˆ¶çµæŸ
- POST /api/admin/games/:id/pause - æš«åœ
- POST /api/admin/games/:id/resume - æ¢å¾©

### 4.3 æŠ•æ¨™ç›¸é—œï¼ˆåœ˜éšŠï¼‰
- POST /api/bids - æäº¤æŠ•æ¨™
- GET /api/games/:gameId/bids - ç²å–æŠ•æ¨™è¨˜éŒ„
- PUT /api/bids/:id - æ›´æ–°æŠ•æ¨™
- DELETE /api/bids/:id - åˆªé™¤æŠ•æ¨™

### 4.4 æŸ¥è©¢ç›¸é—œ
- GET /api/games/:id/status - éŠæˆ²ç‹€æ…‹
- GET /api/games/:id/teams - åœ˜éšŠç‹€æ…‹
- GET /api/games/:id/daily-results - æ¯æ—¥çµç®—çµæœ
- GET /api/qr/:gameId - ç”ŸæˆQRç¢¼

---

## äº”ã€å·²çŸ¥å•é¡Œèˆ‡ä¿®å¾©ç‹€æ…‹

### 5.1 å·²ä¿®å¾© âœ…
1. game_name â†’ name (10è™•)
2. UPDATE games SET phase èªå¥æ¢å¾© (5è™•)
3. DATABASE_ARCHITECTURE.md æ›´æ–°

### 5.2 å¾…ä¿®å¾© â³
1. CREATE TABLE å®šç¾©èˆ‡ Railway ä¸å®Œå…¨ä¸€è‡´
2. ENUM å€¼éœ€è¦å…¨é¢é©—è­‰
3. æ¶æ§‹è‡ªå‹•ä¿®å¾©é‚è¼¯éœ€è¦æª¢æŸ¥
4. å¯èƒ½å­˜åœ¨çš„å…¶ä»–æ¬„ä½åç¨±ä¸ä¸€è‡´

### 5.3 å¾…æ¸¬è©¦ ğŸ§ª
1. éŠæˆ²å‰µå»ºåŠŸèƒ½
2. å®Œæ•´éŠæˆ²æµç¨‹
3. æŠ•æ¨™æäº¤èˆ‡çµç®—
4. æ¯æ—¥çµç®—è¨ˆç®—

---

## å…­ã€ç³»çµ±æ€§æª¢æŸ¥æ¸…å–®

### 6.1 è³‡æ–™åº«å±¤æª¢æŸ¥
- [ ] æ‰€æœ‰ CREATE TABLE å®šç¾©èˆ‡ Railway ä¸€è‡´
- [ ] æ‰€æœ‰ ENUM å€¼èˆ‡ Railway ä¸€è‡´
- [ ] æ‰€æœ‰å¤–éµé—œä¿‚æ­£ç¢º
- [ ] ç´¢å¼•è¨­ç½®åˆç†

### 6.2 SQL æŸ¥è©¢æª¢æŸ¥
- [ ] æ‰€æœ‰ SELECT ä½¿ç”¨æ­£ç¢ºæ¬„ä½å
- [ ] æ‰€æœ‰ INSERT åŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½
- [ ] æ‰€æœ‰ UPDATE åŒæ™‚æ›´æ–° games.phase å’Œ game_days.status
- [ ] æ‰€æœ‰ JOIN é—œè¯æ­£ç¢º

### 6.3 æ¥­å‹™é‚è¼¯æª¢æŸ¥
- [ ] ç‹€æ…‹è½‰æ›é‚è¼¯å®Œæ•´
- [ ] çµç®—è¨ˆç®—å…¬å¼æ­£ç¢º
- [ ] æ»¯éŠ·è™•ç†é‚è¼¯æ­£ç¢ºï¼ˆæ‰£é™¤2.5%ï¼‰
- [ ] åˆ©æ¯è¨ˆç®—æ­£ç¢º
- [ ] ROI è¨ˆç®—æ­£ç¢º

### 6.4 API éŸ¿æ‡‰æª¢æŸ¥
- [ ] æ‰€æœ‰éŸ¿æ‡‰ä½¿ç”¨ camelCase (gameName ä¸æ˜¯ game_name)
- [ ] æ‰€æœ‰éŒ¯èª¤è™•ç†å®Œå–„
- [ ] æ‰€æœ‰ WebSocket äº‹ä»¶æ­£ç¢º

### 6.5 å‰ç«¯æ•´åˆæª¢æŸ¥
- [ ] admin.html æ­£ç¢ºè™•ç†æ‰€æœ‰éŠæˆ²ç‹€æ…‹
- [ ] team.html æ­£ç¢ºé¡¯ç¤ºæŠ•æ¨™ä»‹é¢
- [ ] æ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹æ§åˆ¶æ­£ç¢º

---

## ä¸ƒã€ä¿®å¾©å„ªå…ˆé †åº

### ğŸ”´ é«˜å„ªå…ˆç´šï¼ˆå½±éŸ¿æ ¸å¿ƒåŠŸèƒ½ï¼‰
1. âœ… game_name â†’ name
2. âœ… UPDATE games SET phase æ¢å¾©
3. â³ é©—è­‰æ‰€æœ‰ ENUM å€¼
4. â³ æª¢æŸ¥æ‰€æœ‰ç‹€æ…‹è½‰æ›é‚è¼¯

### ğŸŸ¡ ä¸­å„ªå…ˆç´šï¼ˆå½±éŸ¿é«”é©—ï¼‰
5. â³ CREATE TABLE å®šç¾©å®Œæ•´æ€§
6. â³ éŒ¯èª¤è™•ç†å®Œå–„
7. â³ WebSocket äº‹ä»¶é©—è­‰

### ğŸŸ¢ ä½å„ªå…ˆç´šï¼ˆå„ªåŒ–ï¼‰
8. â³ æ¶æ§‹è‡ªå‹•ä¿®å¾©é‚è¼¯å„ªåŒ–
9. â³ è¨ºæ–·å·¥å…·å®Œå–„
10. â³ æ–‡æª”è£œå……

---

## å…«ã€æ•¸æ“šæµè¿½è¹¤

### 8.1 å‰µå»ºéŠæˆ²æ•¸æ“šæµ
```
å‰ç«¯ admin.html
  â†“ POST /api/admin/games {gameName, ...}
å¾Œç«¯ server.js
  â†“ INSERT INTO games (name, ...) VALUES (?, ...)
  â†“ UPDATE games SET status='active', phase='waiting', current_day=1
  â†“ INSERT INTO game_days (game_id, day_number, status='pending', ...)
  â†“ WebSocket broadcast {gameId, phase: 'waiting'}
Railway MySQL
  â†“ games è¨˜éŒ„, game_days è¨˜éŒ„
å‰ç«¯æ›´æ–°
  â†“ é¡¯ç¤ºéŠæˆ²ï¼Œå•Ÿç”¨ã€Œé–‹å§‹è²·å…¥æŠ•æ¨™ã€æŒ‰éˆ•
```

### 8.2 æŠ•æ¨™æ•¸æ“šæµ
```
å‰ç«¯ team.html
  â†“ POST /api/bids {gameId, fishType, bidType, price, quantity}
å¾Œç«¯ server.js
  â†“ æª¢æŸ¥ game_days.status === 'buying_open' or 'selling_open'
  â†“ INSERT INTO bids (game_id, game_day_id, team_id, ...)
Railway MySQL
  â†“ bids è¨˜éŒ„
å‰ç«¯æ›´æ–°
  â†“ é¡¯ç¤ºæŠ•æ¨™è¨˜éŒ„
```

### 8.3 çµç®—æ•¸æ“šæµ
```
å¾Œç«¯ server.js
  â†“ processBuyBids() or processSellBids()
  â†“ æŒ‰åƒ¹æ ¼æ’åºï¼Œåˆ†é…é­šè²¨/è²·å®¶
  â†“ UPDATE bids SET quantity_fulfilled, status
  â†“ UPDATE game_participants SET fish_a_inventory, fish_b_inventory, current_budget
  â†“ INSERT INTO daily_results (revenue, cost, profit, roi, ...)
Railway MySQL
  â†“ æ›´æ–°æ‰€æœ‰ç›¸é—œè¨˜éŒ„
WebSocket
  â†“ broadcast 'phaseChange' äº‹ä»¶
å‰ç«¯æ›´æ–°
  â†“ é¡¯ç¤ºçµç®—çµæœ
```

---

**æ­¤æ¡†æ¶å°‡ä½œç‚ºç³»çµ±æ€§ä¿®å¾©çš„åŸºç¤ï¼Œç¢ºä¿æ‰€æœ‰ä¿®æ”¹éƒ½åŸºæ–¼å®Œæ•´çš„ç³»çµ±ç†è§£ã€‚**
