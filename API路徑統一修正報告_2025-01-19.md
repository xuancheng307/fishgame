# API è·¯å¾‘çµ±ä¸€èˆ‡åƒæ•¸ä¿®æ­£å ±å‘Š

**ä¿®æ­£æ—¥æœŸ**: 2025-01-19
**å•é¡Œä¾†æº**: ç”¨æˆ¶ç™¼ç¾å¤šæ¢è·¯å¾‘ä¸ä¸€è‡´ã€åƒæ•¸é è¨­å€¼ä¸ä¸€è‡´

---

## ğŸ“‹ ä¿®æ­£ç¸½è¦½

| å•é¡Œ | ç‹€æ…‹ | ä¿®æ­£æ–¹å¼ |
|------|------|---------|
| æ»¯éŠ·è²»é è¨­å€¼ä¸ä¸€è‡´ | âœ… å·²ä¿®æ­£ | çµ±ä¸€æ”¹å› 10 å…ƒ/kg |
| æ¨é€²å¤©æ•¸æœ‰å…©æ¢è·¯å¾‘ | âœ… å·²ä¿®æ­£ | åˆªé™¤æœªä½¿ç”¨çš„è·¯å¾‘ |
| è·¯å¾‘2ç¼ºå°‘åº«å­˜æ¸…ç©ºå’Œåˆ©æ¯è¨ˆç®— | âœ… å·²ä¿®æ­£ | è£œé½Šé‚è¼¯ |
| å‰ç«¯ 'finished' vs 'completed' | âœ… å·²ç¢ºèª | å·²åœ¨ä¹‹å‰ä¿®æ­£ |

---

## ğŸ”´ å•é¡Œ 1: æ»¯éŠ·è²»é è¨­å€¼ä¸ä¸€è‡´

### å•é¡Œæè¿°

ä¸‰å€‹åœ°æ–¹çš„æ»¯éŠ·è²»é è¨­å€¼ä¸ä¸€è‡´ï¼š

| ä½ç½® | åŸå€¼ | æ­£ç¢ºå€¼ |
|------|------|--------|
| `defaultGameParameters` (server.js:30) | 10 | âœ… æ­£ç¢º |
| `complete_database_structure.sql:50` | 20 | âŒ éŒ¯èª¤ |
| `server.js:3406` (fallback) | 20 | âŒ éŒ¯èª¤ |

### ä¿®æ­£å…§å®¹

1. **server.js Line 3406**:
   ```javascript
   // ä¿®æ­£å‰
   const unsoldFeePerKg = gameInfo[0].unsold_fee_per_kg || 20;

   // ä¿®æ­£å¾Œ
   const unsoldFeePerKg = gameInfo[0].unsold_fee_per_kg || 10;
   ```

2. **complete_database_structure.sql Line 50**:
   ```sql
   -- ä¿®æ­£å‰
   `unsold_fee_per_kg` decimal(10,2) NOT NULL DEFAULT 20.00,

   -- ä¿®æ­£å¾Œ
   `unsold_fee_per_kg` decimal(10,2) NOT NULL DEFAULT 10.00,
   ```

3. **migrations/004_update_unsold_fee.sql**:
   ```sql
   -- ä¿®æ­£ç‚ºç¢ºä¿é è¨­å€¼ç‚º 10.00
   ALTER TABLE `games`
   MODIFY COLUMN `unsold_fee_per_kg` decimal(10,2) NOT NULL DEFAULT 10.00;
   ```

---

## ğŸ”´ å•é¡Œ 2: æ¨é€²å¤©æ•¸æœ‰å…©æ¢è·¯å¾‘ï¼Œé‚è¼¯ä¸ä¸€è‡´

### å•é¡Œåˆ†æ

**è·¯å¾‘ 1** (å·²åˆªé™¤): `/api/admin/games/:gameId/advance-day`
- Line 715-877 (å…± 163 è¡Œ)
- éœ€è¦æä¾› gameId
- **å®Œæ•´é‚è¼¯**ï¼šæ›´æ–° statusã€æ¸…ç©ºåº«å­˜ã€è¨ˆç®—åˆ©æ¯

**è·¯å¾‘ 2** (ä¿ç•™): `/api/admin/advance-day`
- Line 716-858
- è‡ªå‹•æ‰¾ active éŠæˆ²
- **åŸæœ¬ç¼ºå°‘**ï¼šåº«å­˜æ¸…ç©ºã€åˆ©æ¯è¨ˆç®—

### ä½¿ç”¨æƒ…æ³èª¿æŸ¥

**å‰ç«¯ä½¿ç”¨**ï¼š
```javascript
// admin.html:993
fetch('/api/admin/advance-day', { ... })  // âœ… ä½¿ç”¨è·¯å¾‘ 2
```

**å…¶ä»–åŠŸèƒ½ä¹Ÿéƒ½ä½¿ç”¨ä¸å¸¶ gameId çš„ç‰ˆæœ¬**ï¼š
- `/api/admin/start-buying` - è‡ªå‹•æ‰¾ active éŠæˆ²
- `/api/admin/close-buying` - è‡ªå‹•æ‰¾ active éŠæˆ²
- `/api/admin/start-selling` - è‡ªå‹•æ‰¾ active éŠæˆ²
- `/api/admin/settle` - è‡ªå‹•æ‰¾ active éŠæˆ²

**çµè«–**: è·¯å¾‘ 1 å®Œå…¨æœªä½¿ç”¨ âŒ

### ä¿®æ­£æ–¹æ¡ˆï¼šåˆªé™¤è·¯å¾‘ 1ï¼Œè£œé½Šè·¯å¾‘ 2

#### ä¿®æ­£ 1: åˆªé™¤æœªä½¿ç”¨çš„è·¯å¾‘ 1

**åˆªé™¤ç¯„åœ**: server.js Line 715-877

```javascript
// å·²åˆªé™¤æ•´å€‹ app.post('/api/admin/games/:gameId/advance-day', ...) ç«¯é»
```

**åŸå› **ï¼š
1. å‰ç«¯ä¸ä½¿ç”¨
2. é‚è¼¯é‡è¤‡
3. ç¶­è­·æˆæœ¬é«˜
4. å®¹æ˜“å‡ºç¾ä¸ä¸€è‡´

#### ä¿®æ­£ 2: è£œé½Šè·¯å¾‘ 2 çš„é‚è¼¯

**æª”æ¡ˆ**: server.js Line 975-1022

**æ–°å¢å…§å®¹**ï¼š

1. **æ›´æ–° games.status** (Line 976):
   ```javascript
   // ä¿®æ­£å‰
   await db.execute('UPDATE games SET current_day = ? WHERE id = ?', [nextDay, gameId]);

   // ä¿®æ­£å¾Œ
   await db.execute('UPDATE games SET current_day = ?, status = "active" WHERE id = ?', [nextDay, gameId]);
   ```

2. **æ¸…ç©ºåº«å­˜ä¸¦è¨ˆç®—åˆ©æ¯** (Line 986-1007):
   ```javascript
   // æ–°å¢ï¼šè¨­å®šæ‰€æœ‰éšŠä¼ç‹€æ…‹ - æ¸…ç©ºåº«å­˜ï¼Œè²¸æ¬¾åˆ©æ¯ç´¯åŠ 
   console.log(`è¨­å®šç¬¬${nextDay}å¤©çš„éšŠä¼ç‹€æ…‹..`);
   const [participants] = await db.execute(
       'SELECT * FROM game_participants WHERE game_id = ?',
       [gameId]
   );

   for (const participant of participants) {
       const currentLoan = participant.total_loan || 0;
       const interestRate = game.loan_interest_rate || 0.03; // 3%è¤‡åˆ©
       const newTotalLoan = currentLoan * (1 + interestRate);

       // æ›´æ–°éšŠä¼ç‹€æ…‹ï¼šæ¸…ç©ºåº«å­˜ï¼Œæ›´æ–°è²¸æ¬¾
       await db.execute(
           `UPDATE game_participants
            SET fish_a_inventory = 0,
                fish_b_inventory = 0,
                total_loan = ?
            WHERE team_id = ? AND game_id = ?`,
           [newTotalLoan, participant.team_id, gameId]
       );
   }

   console.log(`ç¬¬${nextDay}å¤©çš„éšŠä¼ç‹€æ…‹å·²è¨­å®š`);
   ```

3. **æ–°å¢ WebSocket æ¨æ’­** (Line 1022):
   ```javascript
   io.emit('gameUpdate', { gameId, event: 'newDay', dayNumber: nextDay });
   ```

---

## âœ… å•é¡Œ 3: å‰ç«¯ç‹€æ…‹é¡¯ç¤º

### ç¢ºèªçµæœ

å‰ç«¯å·²åœ¨ä¹‹å‰çš„ä¿®æ­£ä¸­çµ±ä¸€ä½¿ç”¨ `'completed'`ï¼š

**admin.html**:
```javascript
// Line 755-757
const statusClass = gameStatus.status === 'active' ? 'status-active' :
                  gameStatus.status === 'completed' ? 'status-completed' : 'status-pending';
const statusText = gameStatus.status === 'active' ? 'é€²è¡Œä¸­' :
                 gameStatus.status === 'completed' ? 'å·²çµæŸ' : 'æº–å‚™ä¸­';
```

**CSS**:
```css
/* Line 207 */
.status-completed { background: #f0f0f0; color: #595959; }
```

**çµè«–**: âœ… å‰ç«¯å·²æ­£ç¢ºä½¿ç”¨ 'completed'ï¼Œç„¡éœ€ä¿®æ”¹

---

## âœ… å•é¡Œ 4: force-end æµç¨‹

### ç¢ºèªçµæœ

**ç•¶å‰å¯¦ä½œ**ï¼ˆæ­£ç¢ºï¼‰ï¼š
```javascript
// ä½¿ç”¨ status = 'completed' + è¼”åŠ©æ¬„ä½
UPDATE games SET
    status = "completed",
    is_force_ended = TRUE,
    force_ended_at = NOW(),
    force_end_day = ?
WHERE id = ?
```

**enum å®šç¾©** (complete_database_structure.sql):
```sql
-- games.status åªæœ‰ä¸‰å€‹å€¼
status ENUM('pending', 'active', 'completed')

-- force-end è³‡è¨Šå­˜åœ¨å°ˆç”¨æ¬„ä½
is_force_ended BOOLEAN DEFAULT FALSE,
force_ended_at TIMESTAMP NULL,
force_end_day INT NULL
```

**çµè«–**: âœ… è¨­è¨ˆæ­£ç¢ºï¼Œæ²’æœ‰ä½¿ç”¨ä¸å­˜åœ¨çš„ 'force_ended' enum

---

## ğŸ“Š ä¿®æ­£çµ±è¨ˆ

| ä¿®æ­£é¡åˆ¥ | æª”æ¡ˆ | è¡Œæ•¸è®ŠåŒ– |
|---------|------|----------|
| æ»¯éŠ·è²»é è¨­å€¼ | server.js | 1 è¡Œ |
| æ»¯éŠ·è²»é è¨­å€¼ | complete_database_structure.sql | 1 è¡Œ |
| åˆªé™¤é‡è¤‡è·¯å¾‘ | server.js | -163 è¡Œ |
| è£œé½Šè·¯å¾‘2é‚è¼¯ | server.js | +38 è¡Œ |
| **ç¸½è¨ˆ** | **3 å€‹æª”æ¡ˆ** | **-123 è¡Œ** |

---

## ğŸ¯ ä¿®æ­£å¾Œçš„æ­£ç¢ºæµç¨‹

### æ¨é€²å¤©æ•¸çš„å”¯ä¸€è·¯å¾‘

```
POST /api/admin/advance-day
{
    "params": {
        "fishASupply": 1500,      // å¯é¸
        "fishBSupply": 3000,      // å¯é¸
        "fishABudget": 225000,    // å¯é¸
        "fishBBudget": 360000     // å¯é¸
    }
}
```

**è™•ç†æµç¨‹**ï¼š
1. è‡ªå‹•æ‰¾åˆ° active éŠæˆ²
2. æª¢æŸ¥ç•¶å‰å¤©æ•¸æ˜¯å¦å·²å®Œæˆçµç®—
3. æ›´æ–° `games.current_day` å’Œ `status = 'active'`
4. æ’å…¥æ–°çš„ `game_days` è¨˜éŒ„
5. **æ¸…ç©ºæ‰€æœ‰éšŠä¼åº«å­˜**
6. **è¨ˆç®—ä¸¦ç´¯åŠ åˆ©æ¯åˆ° total_loan**
7. æ¨æ’­ WebSocket äº‹ä»¶

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### 1. è³‡æ–™åº«é·ç§»

```bash
# ç¢ºä¿æ»¯éŠ·è²»é è¨­å€¼ç‚º 10 å…ƒ
mysql -u root -p fishmarket_game < migrations/004_update_unsold_fee.sql
```

### 2. éƒ¨ç½²å¾Œç«¯

```bash
# è¤‡è£½ä¿®æ­£å¾Œçš„ server.js
cp backend/server.js /path/to/production/backend/

# é‡å•Ÿæœå‹™
pm2 restart fishmarket-backend
```

### 3. é©—è­‰æ¸¬è©¦

#### æ¸¬è©¦ 1: æ»¯éŠ·è²»é è¨­å€¼
```sql
-- å»ºç«‹æ–°éŠæˆ²å¾Œæª¢æŸ¥
SELECT unsold_fee_per_kg FROM games ORDER BY id DESC LIMIT 1;
-- æ‡‰è©²é¡¯ç¤º 10.00
```

#### æ¸¬è©¦ 2: æ¨é€²å¤©æ•¸å®Œæ•´é‚è¼¯
1. å»ºç«‹æ–°éŠæˆ²
2. å®Œæˆ Day 1 çš„æ‰€æœ‰éšæ®µï¼ˆè²·å…¥ã€è³£å‡ºã€çµç®—ï¼‰
3. æ¨é€²åˆ° Day 2
4. æª¢æŸ¥ï¼š
   ```sql
   -- æª¢æŸ¥éŠæˆ²ç‹€æ…‹
   SELECT status, current_day FROM games WHERE id = ?;
   -- status æ‡‰ç‚º 'active', current_day æ‡‰ç‚º 2

   -- æª¢æŸ¥åº«å­˜å·²æ¸…ç©º
   SELECT fish_a_inventory, fish_b_inventory FROM game_participants WHERE game_id = ?;
   -- å…©è€…æ‡‰ç‚º 0

   -- æª¢æŸ¥åˆ©æ¯å·²ç´¯åŠ 
   SELECT total_loan FROM game_participants WHERE game_id = ?;
   -- æ‡‰ç‚ºåŸå€¼ Ã— 1.03
   ```

#### æ¸¬è©¦ 3: ç¢ºèªèˆŠè·¯å¾‘å·²åˆªé™¤
```bash
curl -X POST http://localhost:3000/api/admin/games/1/advance-day
# é æœŸï¼šCannot POST /api/admin/games/1/advance-day
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### 1. API è®Šæ›´

**å·²åˆªé™¤çš„ç«¯é»**ï¼š
- `/api/admin/games/:gameId/advance-day` âŒ ä¸å†å¯ç”¨

**ä¿ç•™çš„ç«¯é»**ï¼š
- `/api/admin/advance-day` âœ… å”¯ä¸€æ­£ç¢ºè·¯å¾‘

### 2. åƒæ•¸çµ±ä¸€

æ‰€æœ‰åœ°æ–¹çš„æ»¯éŠ·è²»é è¨­å€¼ç¾åœ¨ä¸€è‡´ç‚º **10 å…ƒ/kg**ï¼š
- defaultGameParameters âœ…
- complete_database_structure.sql âœ…
- server.js fallback âœ…

### 3. é‚è¼¯å®Œæ•´æ€§

æ¨é€²å¤©æ•¸ç¾åœ¨æœƒæ­£ç¢ºåŸ·è¡Œï¼š
1. âœ… æ›´æ–° games.status = 'active'
2. âœ… æ¸…ç©ºæ‰€æœ‰éšŠä¼åº«å­˜
3. âœ… è¨ˆç®—è¤‡åˆ©åˆ©æ¯
4. âœ… æ¨æ’­ WebSocket äº‹ä»¶

### 4. å‰ç«¯ç„¡éœ€ä¿®æ”¹

å‰ç«¯å·²æ­£ç¢ºä½¿ç”¨ `/api/admin/advance-day`ï¼Œç„¡éœ€ä»»ä½•è®Šæ›´ã€‚

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- `å®Œæ•´ä¿®æ­£ç¸½çµ_2025-01-18.md` - ä¹‹å‰çš„ä¿®æ­£ï¼ˆæš«åœã€force-endã€å‰ç«¯ç‹€æ…‹ï¼‰
- `æ—¥æµç¨‹ä¿®æ­£å ±å‘Š_2025-01-18.md` - æ—¥æµç¨‹ç‹€æ…‹ä¿®æ­£
- `æ»¯éŠ·è²»èˆ‡å€Ÿè²¸ä¿®æ­£å ±å‘Š_2025-01-19.md` - æ—©ä¸Šçš„ä¿®æ­£ï¼ˆå·²å»¢æ£„ï¼‰

---

## âœ… é©—è­‰æ¸…å–®

- [x] æ»¯éŠ·è²»é è¨­å€¼çµ±ä¸€ç‚º 10 å…ƒ/kg
- [x] åˆªé™¤æœªä½¿ç”¨çš„å¸¶ gameId è·¯å¾‘
- [x] è·¯å¾‘2è£œé½Šåº«å­˜æ¸…ç©ºé‚è¼¯
- [x] è·¯å¾‘2è£œé½Šåˆ©æ¯è¨ˆç®—é‚è¼¯
- [x] è·¯å¾‘2æ›´æ–° games.status
- [x] è·¯å¾‘2æ·»åŠ  WebSocket æ¨æ’­
- [x] ç¢ºèªå‰ç«¯ä½¿ç”¨æ­£ç¢ºè·¯å¾‘
- [x] ç¢ºèªå‰ç«¯ç‹€æ…‹é¡¯ç¤ºæ­£ç¢º
- [x] å»ºç«‹ä¿®æ­£å ±å‘Š

---

**ä¿®æ­£å®Œæˆæ™‚é–“**: 2025-01-19
**ä¿®æ­£æª”æ¡ˆ**: 3 å€‹
**ç¨‹å¼ç¢¼è®ŠåŒ–**: -123 è¡Œï¼ˆç°¡åŒ–ï¼‰
**ç‹€æ…‹**: âœ… å…¨éƒ¨å®Œæˆï¼Œå¯éƒ¨ç½²
