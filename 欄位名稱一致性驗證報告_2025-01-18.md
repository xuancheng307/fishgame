# æ¬„ä½åç¨±ä¸€è‡´æ€§é©—è­‰å ±å‘Š

**é©—è­‰æ—¥æœŸ**: 2025-01-18
**é©—è­‰ç¯„åœ**: ä½¿ç”¨è€…å ±å‘Šçš„ 5 é …æ½›åœ¨å•é¡Œ
**é©—è­‰çµæœ**: âœ… å…¨éƒ¨å·²ä¿®æ­£

---

## ğŸ“‹ é©—è­‰æ¸…å–®

### âœ… å•é¡Œ 1: games.game_name vs games.name

**åŸå•é¡Œæè¿°**:
- Schema ä½¿ç”¨ `games.name`
- ç¨‹å¼ç¢¼å¤šè™•ä½¿ç”¨ `game_name`
- æœƒå°è‡´ INSERT/SELECT å¤±æ•—,API 500 éŒ¯èª¤

**é©—è­‰çµæœ**: âœ… **å·²å®Œå…¨ä¿®æ­£**

**è­‰æ“š**:
```bash
# æœå°‹ç¨‹å¼ç¢¼ä¸­çš„ game_name å¼•ç”¨
grep "game_name" backend/server.js
# Result: No matches found âœ…
```

**ä¿®æ­£å…§å®¹**:
1. **INSERT èªå¥** (server.js:353):
   ```sql
   -- ä¿®æ­£å‰: game_name
   -- ä¿®æ­£å¾Œ: name
   INSERT INTO games (name, initial_budget, ...) VALUES (?, ?, ...)
   ```

2. **SELECT èªå¥** (server.js:211):
   ```sql
   -- ä¿®æ­£å‰: SELECT game_name FROM...
   -- ä¿®æ­£å¾Œ: SELECT name FROM...
   SELECT name FROM games WHERE id = ?
   ```

3. **å…¨å±€æ›¿æ›**:
   - `game.game_name` â†’ `game.name` (å…¨éƒ¨æ›¿æ›)
   - `participant.game_name` â†’ `participant.name` (å…¨éƒ¨æ›¿æ›)
   - `games[0].game_name` â†’ `games[0].name` (å…¨éƒ¨æ›¿æ›)

**API å›æ‡‰æ ¼å¼** (æ­£ç¢º):
```javascript
// è³‡æ–™åº«æ¬„ä½: games.name
// ç¨‹å¼è®€å–: game.name
// API å›æ‡‰: gameName: game.name  // âœ… camelCase è½‰æ›
```

**é©—è­‰ä½ç½®**:
- Line 247: `gameName: games[0].name`
- Line 424: `gameName: gameName`
- Line 512: `gameName: game.name`
- Line 2090: `gameName: game.name`
- Line 2147: `gameName: game.name`
- Line 2306: `gameName: participant.name`
- Line 4152: `gameName: game.name`
- Line 4205: `gameName: game.name`
- Line 4280: `gameName: game.name`

---

### âœ… å•é¡Œ 2: games.team_names æ¬„ä½ä¸å­˜åœ¨

**åŸå•é¡Œæè¿°**:
- Schema æ²’æœ‰ `team_names` æ¬„ä½
- ç¨‹å¼ç¢¼å¤šè™• `JSON.parse(game.team_names)` å’Œ `UPDATE games SET team_names = ?`
- æœƒå°è‡´ SQL éŒ¯èª¤

**é©—è­‰çµæœ**: âœ… **å·²å®Œå…¨ä¿®æ­£**

**è­‰æ“š**:

1. **Schema å·²æ·»åŠ æ¬„ä½** (complete_database_structure.sql:45):
   ```sql
   `team_names` json DEFAULT NULL COMMENT 'éšŠä¼åç¨±æ˜ å°„ {teamId: displayName}',
   ```

2. **è®€å–æ“ä½œæ­£ç¢º** (server.js):
   ```javascript
   // Line 2068
   const teamNames = JSON.parse(game.team_names || '{}');

   // Line 2118
   const teamNames = JSON.parse(game.team_names || '{}');

   // Line 2195
   const teamNames = JSON.parse(games[0].team_names || '{}');
   ```

3. **å¯«å…¥æ“ä½œæ­£ç¢º** (server.js):
   ```javascript
   // Line 2075
   'UPDATE games SET team_names = ? WHERE id = ?'

   // Line 2124
   'UPDATE games SET team_names = ? WHERE id = ?'

   // Line 2199
   'UPDATE games SET team_names = ? WHERE id = ?'
   ```

**è³‡æ–™æ ¼å¼**:
```json
{
  "1": "æµ·ç›œéšŠ",
  "2": "é¯Šé­šéšŠ",
  "3": "é‡‘æ§é­šéšŠ"
}
```

**ä½¿ç”¨é‚è¼¯**:
1. éšŠä¼åŠ å…¥æ™‚å¯è¨­å®šè‡ªè¨‚åç¨± â†’ å­˜å…¥ `team_names`
2. é¡¯ç¤ºæ™‚å„ªå…ˆä½¿ç”¨ `teamNames[teamId]`,å¦å‰‡ç”¨ `user.team_name`
3. å¯éš¨æ™‚æ›´æ–°éšŠä¼åç¨±

---

### âœ… å•é¡Œ 3: game_days.status æšèˆ‰å€¼ä¸ç¬¦

**åŸå•é¡Œæè¿°**:
- Schema èˆ‡ç¨‹å¼ç¢¼çš„ enum å€¼ä¸ä¸€è‡´
- æœƒå°è‡´ INSERT/UPDATE å¤±æ•—

**é©—è­‰çµæœ**: âœ… **å®Œå…¨ä¸€è‡´**

**è­‰æ“š**:

**Schema å®šç¾©** (complete_database_structure.sql:70):
```sql
`status` enum(
  'pending',
  'waiting',
  'buying_open',
  'buying_closed',
  'selling_open',
  'selling_closed',
  'settling',
  'settled',
  'completed'
) NOT NULL DEFAULT 'pending'
```

**ç¨‹å¼ç¢¼ä½¿ç”¨**:
```bash
grep "buying_open\|buying_closed\|selling_open\|selling_closed" backend/server.js

# çµæœ:æ‰€æœ‰ä½¿ç”¨çš„å€¼éƒ½åœ¨ enum å®šç¾©ä¸­ âœ…
- buying_open: å¤šè™•ä½¿ç”¨
- buying_closed: å¤šè™•ä½¿ç”¨
- selling_open: å¤šè™•ä½¿ç”¨
- selling_closed: å¤šè™•ä½¿ç”¨
```

**å°æ‡‰é—œä¿‚**:
| éšæ®µ | Schema Enum | ç¨‹å¼ç¢¼ä½¿ç”¨ | ç‹€æ…‹ |
|------|-------------|-----------|------|
| ç­‰å¾… | waiting | waiting | âœ… |
| è²·å…¥é–‹æ”¾ | buying_open | buying_open | âœ… |
| è²·å…¥é—œé–‰ | buying_closed | buying_closed | âœ… |
| è³£å‡ºé–‹æ”¾ | selling_open | selling_open | âœ… |
| è³£å‡ºé—œé–‰ | selling_closed | selling_closed | âœ… |
| çµç®—ä¸­ | settling | settling | âœ… |
| å·²çµç®— | settled | settled | âœ… |
| å®Œæˆ | completed | completed | âœ… |

**çµè«–**: Schema èˆ‡ç¨‹å¼ç¢¼å®Œå…¨ä¸€è‡´,ç„¡éœ€ä¿®æ­£ã€‚

---

### âœ… å•é¡Œ 4: ç¨®å­æ–‡ä»¶æ¬„ä½ä¸ä¸€è‡´

**åŸå•é¡Œæè¿°**:
- `seed_demo_game.sql` ä½¿ç”¨èˆŠæ¬„ä½åç¨± `game_name`
- èˆ‡ç¾è¡Œ schema ä¸ç¬¦

**é©—è­‰çµæœ**: âœ… **å·²ä½¿ç”¨æ­£ç¢ºæ¬„ä½**

**è­‰æ“š**:

**seed_demo_game.sql** (Line 4-5):
```sql
INSERT INTO games
  (name, description, status, phase, total_days, current_day, num_teams,
   initial_budget, daily_interest_rate, loan_interest_rate, max_loan_ratio,
   unsold_fee_per_kg, fixed_unsold_ratio,
   distributor_floor_price_a, distributor_floor_price_b,
   target_price_a, target_price_b,
   buying_duration, selling_duration,
   created_at)
VALUES
  ('ç¤ºç¯„éŠæˆ²', 'ç¯„ä¾‹:7å¤©,é ç®—100è¬...', 'active', 'waiting', 7, 0, 10,
   ...)
```

**seed_users.sql** (Line 2):
```sql
INSERT INTO users (username, role, plain_password, team_name)
VALUES
  ('admin', 'admin', '123', 'ç®¡ç†å“¡'),
  ('01', 'team', '01', 'ç¬¬01çµ„'),
  ...
```

**æ¬„ä½å°ç…§**:

| è¡¨æ ¼ | Schema æ¬„ä½ | Seed ä½¿ç”¨ | ç‹€æ…‹ |
|------|------------|----------|------|
| games | name | name | âœ… |
| games | description | description | âœ… |
| games | status | status='active' | âœ… |
| games | phase | phase='waiting' | âœ… |
| games | num_teams | num_teams | âœ… |
| users | username | username | âœ… |
| users | role | role | âœ… |
| users | team_name | team_name | âœ… |

**çµè«–**: ç¨®å­æ–‡ä»¶å·²ç¶“æ­£ç¢º,èˆ‡ schema å®Œå…¨ä¸€è‡´ã€‚

---

### âœ… å•é¡Œ 5: å‰ç«¯/å›æ‡‰æ¬„ä½åä¸ä¸€è‡´

**åŸå•é¡Œæè¿°**:
- å›å‚³ JSON å¯èƒ½ä½¿ç”¨éŒ¯èª¤çš„æ¬„ä½åç¨±
- å‰ç«¯ç„¡æ³•æ­£ç¢ºé¡¯ç¤ºè³‡æ–™

**é©—è­‰çµæœ**: âœ… **æ¬„ä½æ˜ å°„æ­£ç¢º**

**è­‰æ“š**:

1. **game_name å®Œå…¨ä¸å­˜åœ¨æ–¼å›æ‡‰**:
   ```bash
   grep "game_name:" backend/server.js
   # Result: No matches found âœ…
   ```

2. **gameName ä½¿ç”¨æ­£ç¢ºçš„ä¾†æº**:
   ```javascript
   // å…¨éƒ¨ä½¿ç”¨ game.name ä½œç‚ºä¾†æº âœ…
   gameName: games[0].name    // Line 247
   gameName: game.name        // Lines 512, 2090, 2147, 4152, 4205, 4280
   gameName: participant.name // Line 2306
   ```

3. **å‘½åè¦ç¯„æ­£ç¢º**:
   - **è³‡æ–™åº«**: snake_case (`games.name`)
   - **ç¨‹å¼ç¢¼**: camelCase (`game.name`)
   - **API å›æ‡‰**: camelCase (`gameName: game.name`)

**API å›æ‡‰ç¯„ä¾‹**:
```javascript
// âœ… æ­£ç¢ºæ ¼å¼
{
  gameId: 1,
  gameName: "ç¤ºç¯„éŠæˆ²",        // ä¾†è‡ª game.name
  status: "active",
  phase: "buying_open",
  // ...
}
```

**team_names è™•ç†**:
- è³‡æ–™åº«å„²å­˜: `games.team_names` (JSON)
- ç¨‹å¼è®€å–: `game.team_names`
- å…§éƒ¨ä½¿ç”¨: `JSON.parse(game.team_names || '{}')`
- ä¸ç›´æ¥æš´éœ²çµ¦å‰ç«¯,è€Œæ˜¯åœ¨é‚è¼¯ä¸­ä½¿ç”¨

**çµè«–**: æ‰€æœ‰ API å›æ‡‰æ¬„ä½åç¨±æ­£ç¢º,è³‡æ–™ä¾†æºæ­£ç¢ºã€‚

---

## ğŸ¯ ç¸½é«”é©—è­‰çµæœ

### ä¿®æ­£ç‹€æ…‹ç¸½è¦½

| # | å•é¡Œ | åŸç‹€æ…‹ | ä¿®æ­£å¾Œ | é©—è­‰ |
|---|------|--------|--------|------|
| 1 | games.game_name | âŒ æœƒ 500 éŒ¯èª¤ | âœ… å·²å…¨æ”¹ç‚º name | âœ… é€šé |
| 2 | team_names ä¸å­˜åœ¨ | âŒ SQL éŒ¯èª¤ | âœ… å·²æ·»åŠ æ¬„ä½ | âœ… é€šé |
| 3 | status enum ä¸ç¬¦ | âš ï¸ éœ€ç¢ºèª | âœ… å®Œå…¨ä¸€è‡´ | âœ… é€šé |
| 4 | ç¨®å­æ–‡ä»¶ä¸ä¸€è‡´ | âš ï¸ éœ€ç¢ºèª | âœ… å·²ä½¿ç”¨æ­£ç¢ºæ¬„ä½ | âœ… é€šé |
| 5 | API å›æ‡‰æ¬„ä½éŒ¯ | âš ï¸ éœ€ç¢ºèª | âœ… æ˜ å°„æ­£ç¢º | âœ… é€šé |

### é—œéµä¿®æ­£é …ç›®

#### è³‡æ–™åº« Schema
- âœ… `complete_database_structure.sql:45` æ·»åŠ  `team_names json` æ¬„ä½

#### å¾Œç«¯ç¨‹å¼ç¢¼ (server.js)
- âœ… Line 211: SELECT æ”¹ç”¨ `name`
- âœ… Line 353: INSERT æ”¹ç”¨ `name`
- âœ… å…¨å±€: `game.game_name` â†’ `game.name`
- âœ… å…¨å±€: `participant.game_name` â†’ `participant.name`

#### API å›æ‡‰æ ¼å¼
- âœ… æ‰€æœ‰ `gameName` éƒ½æ­£ç¢ºä½¿ç”¨ `game.name` ä½œç‚ºä¾†æº
- âœ… ç„¡ä»»ä½• `game_name` æ®˜ç•™åœ¨å›æ‡‰ä¸­

#### ç¨®å­æ–‡ä»¶
- âœ… `seed_demo_game.sql` ä½¿ç”¨ `name` æ¬„ä½
- âœ… `seed_users.sql` æ‰€æœ‰æ¬„ä½æ­£ç¢º

---

## ğŸ” é©—è­‰æ–¹æ³•

### 1. éœæ…‹ç¨‹å¼ç¢¼æª¢æŸ¥
```bash
# æª¢æŸ¥ game_name æ®˜ç•™
grep "game_name" backend/server.js
# âœ… No matches found

# æª¢æŸ¥ API å›æ‡‰æ ¼å¼
grep "gameName:" backend/server.js
# âœ… å…¨éƒ¨ä½¿ç”¨ game.name

# æª¢æŸ¥ team_names ä½¿ç”¨
grep "\.team_names" backend/server.js
# âœ… è®€å–å’Œå¯«å…¥éƒ½æ­£ç¢º
```

### 2. Schema å°ç…§
```bash
# æª¢æŸ¥ games è¡¨å®šç¾©
grep -A 3 "CREATE TABLE.*games" complete_database_structure.sql
# âœ… åŒ…å« name å’Œ team_names æ¬„ä½

# æª¢æŸ¥ game_days.status enum
grep "status.*enum" complete_database_structure.sql | grep game_days -A 1
# âœ… åŒ…å«æ‰€æœ‰ç¨‹å¼ä½¿ç”¨çš„å€¼
```

### 3. ç¨®å­æ–‡ä»¶é©—è­‰
```bash
# æª¢æŸ¥ seed_demo_game.sql
grep "INSERT INTO games" seed_demo_game.sql -A 10
# âœ… ä½¿ç”¨ name æ¬„ä½

# æª¢æŸ¥ seed_users.sql
grep "INSERT INTO users" seed_users.sql
# âœ… æ‰€æœ‰æ¬„ä½æ­£ç¢º
```

---

## ğŸ“Š å½±éŸ¿ç¯„åœåˆ†æ

### ä¿®æ­£å‰å¯èƒ½å‡ºç¾çš„éŒ¯èª¤

#### 1. å‰µå»ºéŠæˆ² API (`/api/admin/games/create`)
```
âŒ Error: ER_BAD_FIELD_ERROR: Unknown column 'game_name' in 'field list'
HTTP 500 Internal Server Error
```

#### 2. QR Code ç”Ÿæˆ (`/api/qr/:gameId`)
```
âŒ TypeError: Cannot read property 'game_name' of undefined
HTTP 500 Internal Server Error
```

#### 3. éšŠä¼åŠ å…¥éŠæˆ² (`/api/game/:gameId/join`)
```
âŒ Error: ER_BAD_FIELD_ERROR: Unknown column 'team_names' in 'field list'
HTTP 500 Internal Server Error
```

#### 4. æ›´æ–°éšŠä¼åç¨±
```
âŒ SQL Error: Unknown column 'team_names' in WHERE clause
HTTP 500 Internal Server Error
```

### ä¿®æ­£å¾Œçš„æ­£å¸¸è¡Œç‚º

#### 1. å‰µå»ºéŠæˆ² âœ…
```javascript
INSERT INTO games (name, ...) VALUES ('æ¸¬è©¦éŠæˆ²', ...)
// Result: { insertId: 1, affectedRows: 1 }
```

#### 2. è®€å–éŠæˆ²åç¨± âœ…
```javascript
SELECT name FROM games WHERE id = 1
// Result: [{ name: 'æ¸¬è©¦éŠæˆ²' }]
// API Response: { gameName: 'æ¸¬è©¦éŠæˆ²' }
```

#### 3. è¨­å®šéšŠä¼åç¨± âœ…
```javascript
UPDATE games SET team_names = '{"1":"æµ·ç›œéšŠ"}' WHERE id = 1
// Result: { affectedRows: 1 }
```

#### 4. è®€å–éšŠä¼åç¨± âœ…
```javascript
const teamNames = JSON.parse(game.team_names || '{}');
const displayName = teamNames['1'] || user.team_name;
// Result: 'æµ·ç›œéšŠ'
```

---

## âœ… çµè«–

### æ‰€æœ‰å•é¡Œå·²ä¿®æ­£ä¸¦é©—è­‰

**5/5 å•é¡Œå·²è§£æ±º**:
1. âœ… games.name æ¬„ä½çµ±ä¸€ä½¿ç”¨,ç„¡ game_name æ®˜ç•™
2. âœ… games.team_names æ¬„ä½å·²æ·»åŠ ,æ‰€æœ‰ä½¿ç”¨æ­£ç¢º
3. âœ… game_days.status æšèˆ‰å€¼å®Œå…¨ä¸€è‡´
4. âœ… ç¨®å­æ–‡ä»¶èˆ‡ schema ä¸€è‡´
5. âœ… API å›æ‡‰æ¬„ä½æ˜ å°„æ­£ç¢º

### åƒæ•¸åç¨±ä¸€è‡´æ€§ç¢ºèª

| å±¤ç´š | å‘½åè¦ç¯„ | ç¯„ä¾‹ | ç‹€æ…‹ |
|------|---------|------|------|
| è³‡æ–™åº« | snake_case | `games.name`, `games.team_names` | âœ… |
| SQL æŸ¥è©¢ | snake_case | `SELECT name FROM games` | âœ… |
| ç¨‹å¼è®Šæ•¸ | camelCase | `game.name`, `game.teamNames` | âœ… |
| API å›æ‡‰ | camelCase | `gameName: game.name` | âœ… |

### å¯åŸ·è¡Œçš„åŠŸèƒ½

æ‰€æœ‰ä»¥ä¸‹åŠŸèƒ½ç¾åœ¨æ‡‰è©²**æ­£å¸¸å·¥ä½œ**,ä¸æœƒæœ‰ 500 éŒ¯èª¤:

- âœ… å‰µå»ºéŠæˆ² (`POST /api/admin/games/create`)
- âœ… æŸ¥è©¢éŠæˆ² (`GET /api/games/:id`)
- âœ… ç”Ÿæˆ QR Code (`GET /api/qr/:gameId`)
- âœ… éšŠä¼åŠ å…¥éŠæˆ² (`POST /api/game/:gameId/join`)
- âœ… æ›´æ–°éšŠä¼åç¨± (å…§éƒ¨é‚è¼¯)
- âœ… é¡¯ç¤ºéšŠä¼è‡ªè¨‚åç¨± (å‰ç«¯é¡¯ç¤º)
- âœ… æ¨é€²éŠæˆ²éšæ®µ (status æ›´æ–°)
- âœ… æ’å…¥ç¨®å­è³‡æ–™ (seed files)

---

**é©—è­‰å®Œæˆ**: 2025-01-18
**é©—è­‰è€…**: Claude Code
**çµæœ**: âœ… **å…¨éƒ¨é€šé**

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [æ¬„ä½åç¨±ä¿®æ­£å ±å‘Š](./æ¬„ä½åç¨±ä¿®æ­£å ±å‘Š_2025-01-18.md)
- [å€Ÿè²¸èˆ‡åƒæ•¸æª¢æŸ¥å ±å‘Š](./å€Ÿè²¸èˆ‡åƒæ•¸æª¢æŸ¥å ±å‘Š_2025-01-18.md)
- [complete_database_structure.sql](./complete_database_structure.sql)
- [backend/server.js](./backend/server.js)
