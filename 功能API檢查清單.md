# 魚市場遊戲功能 API 檢查清單

根據 `遊戲說明.html` 逐一檢查功能實現

---

## 📋 遊戲流程功能

### 1. 推進新一天
**說明文件**: 管理員設定市場參數
**預期 API**:
- `POST /api/admin/games/:gameId/advance-day`
- `POST /api/admin/advance-day`

**檢查項目**:
- [ ] 插入新的 game_days 記錄
- [ ] 設定當日魚貨供應量
- [ ] 設定餐廳預算
- [ ] 清零前一天庫存

---

### 2. 買入投標階段
**說明文件**: 向總代理出價收購魚貨（7分鐘）
**預期 API**:
- `POST /api/admin/open-buying` - 開啟買入階段
- `POST /api/team/submit-buy-bids` - 提交買入標單

**檢查項目**:
- [ ] 每種魚最多 2 個標單
- [ ] 檢查總出價 ≤ 現金 + 剩餘借貸額度
- [ ] 7 分鐘計時
- [ ] 階段狀態：buying_open

---

### 3. 買入結算
**說明文件**: 系統分配魚貨給得標者
**預期 API**:
- `POST /api/admin/close-buying` - 關閉買入
- `POST /api/admin/process-buy` - 處理買入結算

**檢查項目**:
- [ ] 按價格降序排列投標
- [ ] 從最高價開始分配供應量
- [ ] 成交量 = min(投標量, 剩餘供應量)
- [ ] 自動借貸：成交金額 > 現金時借貸
- [ ] 借貸額度限制：初始預算 × 50%
- [ ] 更新團隊庫存
- [ ] 更新現金/借貸

---

### 4. 賣出投標階段
**說明文件**: 向餐廳出價銷售魚貨（4分鐘）
**預期 API**:
- `POST /api/admin/open-selling` - 開啟賣出階段
- `POST /api/team/submit-sell-bids` - 提交賣出標單

**檢查項目**:
- [ ] 每種魚最多 2 個標單
- [ ] 檢查出售數量 ≤ 庫存
- [ ] 4 分鐘計時
- [ ] 階段狀態：selling_open

---

### 5. 賣出結算
**說明文件**: 系統處理餐廳採購
**預期 API**:
- `POST /api/admin/close-selling` - 關閉賣出
- `POST /api/admin/process-sell` - 處理賣出結算

**檢查項目**:
- [x] **固定滯銷機制**（重要）：
  - [x] 計算全部成交量的 2.5%
  - [x] 從最高價開始分配滯銷量
  - [x] 同價格時，晚投標者優先滯銷
- [x] 扣除滯銷後，按價格升序成交
- [x] 從最低價開始購買
- [x] 成交條件：預算 ≥ 價格 × 數量
- [x] 預算不足時部分成交
- [x] 滯銷費：$20/kg ✅ **已修正** (2025-01-19)

---

### 6. 每日結算
**說明文件**: 計算損益、利息、ROI
**預期 API**:
- `POST /api/admin/settle` - 每日結算
- `POST /api/admin/games/:gameId/settle`

**檢查項目**:
- [ ] **利息計算**（複利）：
  - [ ] 每日利息 = 總借貸 × 3%
  - [ ] 新總借貸 = 總借貸 + 利息
  - [ ] 從現金扣除利息
  - [ ] 現金不足時追加借貸
- [ ] **每日損益**：
  - [ ] 收益 = 銷售收入 - 採購成本 - 滯銷費 - 利息
  - [ ] 累積收益 += 每日收益
- [ ] **ROI 計算**：
  - [ ] 總投資 = 初始預算 + 總借貸本金
  - [ ] ROI = (累積收益 ÷ 總投資) × 100%
- [ ] **清空庫存**（每日）
- [ ] game_days.status 設為 'completed'

---

## 💰 資金管理功能

### 資金池規則（重要）
**說明文件**: 資金池只減不增

**檢查項目**:
- [ ] **賣出收入不加回資金池**
- [ ] 資金池只因以下原因減少：
  - [ ] 買入成本
  - [ ] 滯銷費
  - [ ] 利息
- [ ] 現金流獨立於資金池

---

### 自動借貸機制
**說明文件**: 購買超過現有資金時自動借貸

**檢查項目**:
- [x] 買入時自動檢查資金
- [x] 不足時自動借貸
- [x] 借貸上限：初始預算 × 50% ✅ **已添加檢查** (2025-01-19)
- [x] 每日按複利計算利息（3%）
- [x] 利息從現金扣除

---

## 🐟 魚貨交易功能

### 魚種分類
**檢查項目**:
- [ ] A級魚和B級魚分別處理
- [ ] 不同的供應量
- [ ] 不同的目標價格
- [ ] 不同的底價

---

### 投標限制
**檢查項目**:
- [ ] 每種魚最多 2 個標單
- [ ] 買入：總出價 ≤ 現金 + 剩餘借貸額度
- [ ] 賣出：數量 ≤ 庫存

---

### 成交規則
**檢查項目**:
- [ ] 買入：價高者優先
- [ ] 賣出：價低者優先
- [ ] 供應量/預算用完即停止

---

## 📦 庫存管理功能

### 每日清零
**說明文件**: 所有庫存自動清零

**檢查項目**:
- [ ] 每日結算後清空 fish_a_inventory
- [ ] 每日結算後清空 fish_b_inventory
- [ ] 模擬魚貨保鮮期限

---

### 滯銷機制（重要更新）
**說明文件**: 固定滯銷比例 2.5%

**檢查項目**:
- [x] 全部成交量的 2.5% 會滯銷
- [x] 從最高價開始分配滯銷
- [x] 同價格時晚投標者先滯銷
- [x] 滯銷費：$20/kg ✅ **已修正** (2025-01-19)
- [x] 從現金扣除滯銷費
- [x] **滯銷包含兩部分**：固定 2.5% + 預算不足滯銷

---

## 🎮 操作功能

### 投標時間
**檢查項目**:
- [ ] 買入階段：7 分鐘計時
- [ ] 賣出階段：4 分鐘計時
- [ ] 時間到自動結算
- [ ] 計時器 Socket.IO 推播

---

### 團隊協作
**檢查項目**:
- [ ] 查看市場資訊 API
- [ ] 無法看到其他團隊標單
- [ ] 查看自己的歷史記錄

---

## 🏆 獲勝條件

### ROI 計算
**說明文件**: ROI 最高的團隊獲勝

**檢查項目**:
- [ ] ROI = (累積利潤 / 總投資) × 100%
- [ ] 總投資 = 初始資金 + 總借貸金額
- [ ] 每日更新 ROI
- [ ] 遊戲結束時最終 ROI 排名

---

## 📊 查詢功能

### 團隊資訊查詢
**預期 API**:
- [ ] `GET /api/team/status` - 查看當前狀態
- [ ] `GET /api/team/history` - 查看歷史記錄
- [ ] `GET /api/team/leaderboard` - 排行榜

### 管理員查詢
**預期 API**:
- [ ] `GET /api/admin/games` - 遊戲列表
- [ ] `GET /api/admin/games/:gameId` - 遊戲詳情
- [ ] `GET /api/admin/games/:gameId/participants` - 參與者列表

---

## 🔧 額外功能

### 遊戲管理
**預期 API**:
- [ ] `POST /api/admin/games/create` - 建立遊戲
- [ ] `POST /api/admin/games/:gameId/force-end` - 強制結束
- [ ] `DELETE /api/admin/games/:gameId` - 刪除遊戲

### 用戶認證
**預期 API**:
- [ ] `POST /api/auth/login` - 登入
- [ ] `POST /api/auth/register` - 註冊
- [ ] `POST /api/auth/logout` - 登出

---

## 檢查方式

對於每個功能，需要驗證：
1. ✅ API 端點存在
2. ✅ 邏輯符合說明文件
3. ✅ 參數驗證正確
4. ✅ 錯誤處理完整
5. ✅ WebSocket 推播（如需要）

---

**建立時間**: 2025-01-18
**最後更新**: 2025-01-19
**檢查狀態**: ✅ 已完成核心功能驗證

## 📝 修正記錄

### 2025-01-19 修正
1. ✅ **滯銷費預設值**: $10/kg → $20/kg
   - `backend/server.js` line 3397
   - `complete_database_structure.sql` line 50
   - 建立遷移腳本 `migrations/004_update_unsold_fee.sql`

2. ✅ **借貸額度保護性檢查**:
   - 買入結算 (`processBuyBids`) 添加額度檢查
   - 每日結算 (`enhancedDailySettlement`) 添加額度檢查
   - 確保不會超過 初始預算 × 50% 的限制

3. ✅ **滯銷機制澄清**:
   - 滯銷包含兩部分：固定 2.5% + 預算不足滯銷
   - 計算方式：買入量 - 賣出量 = 總滯銷
   - 滯銷費 = 總滯銷 × $20/kg
